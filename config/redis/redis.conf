# Copyright (C) 2025 iolaire mcfadden.
# This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Redis configuration for Vedfolnir Docker container
# Optimized for session storage and RQ queue management

# Network settings
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# General settings
daemonize no
supervised no
pidfile /var/run/redis_6379.pid
loglevel notice
logfile ""
databases 16

# Enhanced persistence configuration for session and queue data
# RDB snapshots - optimized for session storage patterns
save 900 1      # Save if at least 1 key changed in 900 seconds
save 300 10     # Save if at least 10 keys changed in 300 seconds  
save 60 10000   # Save if at least 10000 keys changed in 60 seconds
save 30 100000  # Additional save for high-activity periods

# RDB configuration
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# RDB save optimization
rdb-save-incremental-fsync yes

# Background save optimization
rdb-del-sync-files no

# Replication settings
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-ping-replica-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600

# Security and Access Controls
# Password authentication (set via environment variable in Docker Compose)
# requirepass will be set via command line argument in Docker Compose

# Disable dangerous commands for security
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command SHUTDOWN "SHUTDOWN_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command EVAL ""

# Protected mode (enabled by default, requires authentication)
protected-mode yes

# Access Control Lists (ACL) for enhanced security
# Default user disabled, application uses authenticated user
user default off

# Client connection limits
maxclients 10000

# Connection timeout for idle clients (5 minutes)
timeout 300

# Memory management optimized for session storage and RQ queues
maxmemory 1gb
maxmemory-policy volatile-lru  # Prefer evicting keys with TTL (sessions)
maxmemory-samples 10  # Better LRU approximation

# Memory usage optimization
hash-max-ziplist-entries 1024  # Optimize for session data
hash-max-ziplist-value 256     # Larger values for session objects
list-max-ziplist-size -1       # Memory-optimized lists for RQ queues
set-max-intset-entries 1024    # Optimize sets for session data

# Memory defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# Lazy freeing
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# Enhanced AOF persistence for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Good balance of performance and durability
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# AOF optimization
aof-rewrite-incremental-fsync yes
aof-timestamp-enabled no

# Lua scripting
lua-time-limit 5000

# Slow log
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 0

# Event notification
notify-keyspace-events ""

# Hash settings (optimized for session data)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings (optimized for RQ queues)
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Streams settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Protocol buffer limit
proto-max-bulk-len 512mb

# Frequency of rehashing
hz 10

# Dynamic HZ
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# Jemalloc background thread
jemalloc-bg-thread yes

# Session-specific optimizations
# These settings are optimized for Vedfolnir's session storage patterns

# Increase timeout for session operations
timeout 300

# Optimize for session key patterns
# Sessions typically have TTL, so optimize for expiration
maxmemory-policy volatile-lru

# Enable keyspace notifications for session expiration tracking
notify-keyspace-events Ex

# Optimize hash tables for session data size
hash-max-ziplist-entries 1024
hash-max-ziplist-value 128

# RQ queue optimizations
# Lists are used for RQ queues, optimize accordingly
list-max-ziplist-size -1  # Optimize for memory over CPU for small queues

# Connection optimizations for web application
tcp-keepalive 60
timeout 300

# Memory optimization for session storage
maxmemory-samples 10  # Better LRU approximation for session eviction