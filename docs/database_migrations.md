# Database Migrations Guide

This document describes how to use Alembic for database migrations in the Vedfolnir project.

## Overview

The Vedfolnir uses Alembic to manage database schema changes. Alembic provides a way to:
- Track database schema changes in version control
- Apply migrations to update the database schema
- Revert migrations if needed
- Generate migration scripts automatically based on model changes

## Setup

The migration system is already set up with the following components:
- `alembic.ini`: Configuration file for Alembic
- `migrations/`: Directory containing migration scripts and environment
- `migrations/env.py`: Environment configuration for Alembic
- `migrations/script.py.mako`: Template for migration scripts
- `migrations/versions/`: Directory containing individual migration scripts

## Initial Setup

To initialize the migration system for the first time:

```bash
python init_migrations.py
```

This script will:
1. Create the necessary directories
2. Generate an initial migration based on the current models
3. Apply the migration to the database

## Creating New Migrations

When you make changes to the database models in `models.py`, you need to create a new migration:

```bash
alembic revision --autogenerate -m "Description of changes"
```

This will:
1. Compare the current database schema with the models in `models.py`
2. Generate a new migration script in `migrations/versions/`
3. The script will include the necessary changes to upgrade and downgrade the database

## Applying Migrations

To apply all pending migrations:

```bash
alembic upgrade head
```

To apply a specific number of migrations:

```bash
alembic upgrade +1
```

## Reverting Migrations

To revert the most recent migration:

```bash
alembic downgrade -1
```

To revert to a specific migration:

```bash
alembic downgrade <revision_id>
```

## Checking Migration Status

To see the current migration status:

```bash
alembic current
```

To see the history of migrations:

```bash
alembic history
```

## Best Practices

1. Always review autogenerated migration scripts before applying them
2. Test migrations on a development database before applying to production
3. Include both upgrade and downgrade paths in migrations
4. Keep migrations small and focused on specific changes
5. Use meaningful commit messages for migration scripts
6. Run migrations as part of your deployment process

## Session Performance Migration

A special migration script is available for session performance optimization:

```bash
python scripts/database/migrate_session_performance.py
```

This migration:
1. Adds required columns to the `user_sessions` table:
   - `last_activity`: Tracks when the session was last used
   - `expires_at`: Session expiration timestamp
   - `is_active`: Boolean flag for active sessions
2. Creates performance indexes for faster session queries
3. Updates existing sessions with default values

**Note**: This migration is required for the session performance optimization system to work correctly.

## Troubleshooting

If you encounter issues with migrations:

1. Check the Alembic logs for error messages
2. Verify that your models are correctly defined
3. Ensure the database URL in `alembic.ini` is correct
4. Try running migrations with the `--sql` flag to see the SQL that would be executed
5. For complex schema changes, consider writing manual migration scripts instead of using autogenerate