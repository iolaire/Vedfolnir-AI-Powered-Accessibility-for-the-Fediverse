<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="ebfee85a-e52d-4cd3-b7c2-5ab7d3994a34:1755982425:3ed203792247d767dd43f43c0762c57d58f675c13a79b9614301ae54992e1639:1af0c59ff4373d9ae4c954d766dbf3b37c2647f2d6fdbd3a866dedd2810ce724">
    <title>Login - Vedfolnir</title>
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Modern font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap and icons with fallback -->
    <link href="/static/css/bootstrap-fallback.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.remove()">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" onerror="this.remove()">
    
    <!-- Custom styles -->
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/platform_styles.css" rel="stylesheet">
    <link href="/static/css/fixes.css" rel="stylesheet">
    
    <!-- Session Management Styles -->
    <style>
        .session-status-indicator {
            display: inline-block;
            margin-left: 0.5rem;
            font-size: 0.75rem;
        }
        
        .session-status-indicator i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .platform-switch-item:hover {
            background-color: var(--bs-dropdown-link-hover-bg);
        }
        
        .dropdown-item-text {
            padding: 0.25rem 1rem;
            margin-bottom: 0;
            font-size: 0.875rem;
            color: var(--bs-dropdown-color);
            text-decoration: none;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
        }
    </style>
    
    <!-- Favicon -->
<!-- Standard favicon -->
<link rel="icon" type="image/x-icon" href="/static/favicons/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/static/favicons/favicon-96x96.png">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/static/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/static/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/static/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-icon-180x180.png">

<!-- Android Chrome Icons -->
<link rel="icon" type="image/png" sizes="36x36" href="/static/favicons/android-icon-36x36.png">
<link rel="icon" type="image/png" sizes="48x48" href="/static/favicons/android-icon-48x48.png">
<link rel="icon" type="image/png" sizes="72x72" href="/static/favicons/android-icon-72x72.png">
<link rel="icon" type="image/png" sizes="96x96" href="/static/favicons/android-icon-96x96.png">
<link rel="icon" type="image/png" sizes="144x144" href="/static/favicons/android-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192" href="/static/favicons/android-icon-192x192.png">

<!-- PWA Manifest -->
<link rel="manifest" href="/static/favicons/manifest.json">

<!-- Windows Tiles -->
<meta name="msapplication-config" content="/static/favicons/browserconfig.xml">
<meta name="msapplication-TileColor" content="#212529">
<meta name="msapplication-TileImage" content="/static/favicons/ms-icon-144x144.png">

<!-- Theme colors -->
<meta name="theme-color" content="#212529">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Vedfolnir">
    
    
</head>
<body data-authenticated="false">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/" aria-label="Vedfolnir - Go to dashboard">
                <img src="/static/images/Logo.png" 
                     alt="Vedfolnir Logo" 
                     class="navbar-logo me-2"
                     height="32"
                     onerror="this.style.display='none'">
                <span class="navbar-brand-text">Vedfolnir</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    
                </ul>
                <ul class="navbar-nav">
                    
                        <li class="nav-item">
                            <a class="nav-link" href="/login">Login</a>
                        </li>
                    
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4" id="main-content">
        
            
        

        
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0 text-center">
                        <i class="fas fa-sign-in-alt me-2"></i>Sign In
                    </h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted text-center mb-4">
                        Welcome back to Vedfolnir
                    </p>

                    <form method="POST" novalidate>
                        <input type="hidden" name="csrf_token" value="ebfee85a-e52d-4cd3-b7c2-5ab7d3994a34:1755982425:ddc60bf2f987ad5baf90b8b99ba3e2bab2d19a8162a463a29cbc1cb8de9bb8fc:a95a5c2a2f8e9b88e3f084a89fa6c9c7cb2b1e02bef92325be71cea8b2a16066">
                        
                        <!-- Username or Email Field -->
                        <div class="mb-3">
                            <label class="form-label" for="username_or_email">Username or Email</label>
                            <input autocomplete="username" class="form-control" id="username_or_email" maxlength="120" name="username_or_email" placeholder="Enter your username or email" required type="text" value="">
                            
                        </div>

                        <!-- Password Field -->
                        <div class="mb-3">
                            <label class="form-label" for="password">Password</label>
                            <div class="input-group">
                                <input autocomplete="current-password" class="form-control" id="password" name="password" placeholder="Enter your password" required type="password" value="">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                </button>
                            </div>
                            
                        </div>

                        <!-- Remember Me -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" id="remember_me" name="remember_me" type="checkbox" value="y">
                                <label class="form-check-label" for="remember_me">Remember me</label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <input class="btn btn-primary btn-lg" id="submit" name="submit" type="submit" value="Login">
                        </div>
                    </form>

                    <!-- Additional Links -->
                    <div class="text-center mt-4">
                        <p class="text-muted mb-2">
                            <a href="/forgot-password" class="text-decoration-none">
                                Forgot your password?
                            </a>
                        </p>
                        <p class="text-muted">
                            Don't have an account? 
                            <a href="/register" class="text-decoration-none">Sign up here</a>
                        </p>
                    </div>

                    <!-- Email Verification Notice -->
                    
                        
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Toggle Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    const icon = document.getElementById('togglePasswordIcon');
    
    if (toggle && password && icon) {
        toggle.addEventListener('click', function() {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            
            if (type === 'text') {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    }
});
</script>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" onerror="console.warn('Bootstrap JS failed to load from CDN')"></script>
    <script src="/static/js/csrf-handler.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/error_handler.js"></script>
    <script src="/static/js/session-sync.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/platform_context_refresh.js"></script>
    
    <!-- Session Management JavaScript -->
    <script>
        // Handle logout with session sync
        function handleLogout(event) {
            if (window.sessionSync) {
                window.sessionSync.broadcastLogout();
            }
            // Let the default action proceed
            return true;
        }
        
        // Handle logout all devices
        function handleLogoutAll(event) {
            if (window.sessionSync) {
                window.sessionSync.broadcastLogout();
            }
            // Let the default action proceed
            return true;
        }
        
        // Update session status indicator
        function updateSessionStatus(isActive) {
            const indicator = document.getElementById('sessionStatusIndicator');
            if (indicator) {
                const icon = indicator.querySelector('i');
                if (isActive) {
                    icon.className = 'bi bi-circle-fill text-success';
                    indicator.title = 'Session Active';
                } else {
                    icon.className = 'bi bi-circle-fill text-warning';
                    indicator.title = 'Session Issues';
                }
            }
        }
        
        // Listen for session state changes
        window.addEventListener('sessionStateChanged', function(event) {
            updateSessionStatus(true);
        });
        
        window.addEventListener('sessionExpired', function(event) {
            updateSessionStatus(false);
        });
        
        // Quick platform switching function
        window.quickSwitchPlatform = async function(platformId, platformName) {
            try {
                // Show loading state
                const switchItems = document.querySelectorAll('.platform-switch-item');
                switchItems.forEach(item => {
                    item.style.opacity = '0.6';
                    item.style.pointerEvents = 'none';
                });
                
                // Use secure fetch with automatic CSRF handling
                const response = await window.csrfHandler.secureFetch(`/api/switch_platform/${platformId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Notify session sync about the platform switch
                    if (window.sessionSync) {
                        window.sessionSync.notifyPlatformSwitch(platformId, platformName);
                    }
                    
                    // Update UI immediately
                    if (result.platform) {
                        updatePlatformUI(result.platform);
                    }
                    
                    // Show success message
                    if (window.errorHandler) {
                        window.errorHandler.showNotification(result.message, 'success');
                    }
                    
                    // Refresh the page after a short delay to ensure all components are updated
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to switch platform');
                }
            } catch (error) {
                console.error('Error switching platform:', error);
                
                if (window.errorHandler) {
                    window.errorHandler.showNotification('Failed to switch platform: ' + error.message, 'danger');
                } else {
                    alert('Failed to switch platform: ' + error.message);
                }
            } finally {
                // Restore UI state
                const switchItems = document.querySelectorAll('.platform-switch-item');
                switchItems.forEach(item => {
                    item.style.opacity = '';
                    item.style.pointerEvents = '';
                });
            }
        };
        
        // Update platform UI elements
        function updatePlatformUI(platform) {
            // Update platform dropdown text
            const platformDropdown = document.getElementById('platformsDropdown');
            if (platformDropdown) {
                platformDropdown.textContent = `Platforms: ${platform.name}`;
            }
            
            // Update current platform displays
            const currentPlatformElements = document.querySelectorAll('[data-current-platform]');
            currentPlatformElements.forEach(element => {
                element.textContent = platform.name;
                element.setAttribute('data-platform-id', platform.id);
                element.setAttribute('data-platform-type', platform.platform_type);
            });
        }
        
        // Fallback for Bootstrap JS functionality
        if (typeof bootstrap === 'undefined') {
            document.addEventListener('click', function(e) {
                if (e.target.matches('[data-bs-toggle="dropdown"]')) {
                    e.preventDefault();
                    const menu = e.target.nextElementSibling;
                    if (menu && menu.classList.contains('dropdown-menu')) {
                        menu.classList.toggle('show');
                    }
                }
                // Close dropdowns when clicking outside
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    if (!menu.parentElement.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                });
            });
        }
        
        // Session management functions
        function handleLogout(event) {
            // Notify other tabs about logout
            if (window.vedfolnir && window.vedfolnir.sessionSync) {
                window.vedfolnir.sessionSync.notifyLogout();
            }
            
            // Allow normal logout to proceed
            return true;
        }
        
        // Platform switching handler
        function handlePlatformSwitch(platformId, platformName) {
            // Notify other tabs about platform switch
            if (window.vedfolnir && window.vedfolnir.sessionSync) {
                window.vedfolnir.sessionSync.notifyPlatformSwitch({
                    id: platformId,
                    name: platformName
                });
            }
        }
    </script>
    
</body>
</html>