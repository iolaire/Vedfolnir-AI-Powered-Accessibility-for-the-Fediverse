<div id="notification-container" class="notification-container"></div>
<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base.html" %}

{% block title %}User Profile{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-user"></i> User Profile
                    </h4>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary btn-sm" onclick="toggleEditMode()">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <a href="{{ url_for('user_management.change_password') }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-key"></i> Change Password
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if profile_data %}
                    <!-- View Mode -->
                    <div id="view-mode">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Personal Information</h5>
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Username:</strong></td>
                                        <td>{{ profile_data.username }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Full Name:</strong></td>
                                        <td>{{ profile_data.full_name or 'Not provided' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>First Name:</strong></td>
                                        <td>{{ profile_data.first_name or 'Not provided' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Last Name:</strong></td>
                                        <td>{{ profile_data.last_name or 'Not provided' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Email:</strong></td>
                                        <td>
                                            {{ profile_data.email }}
                                            {% if profile_data.email_verified %}
                                                <span class="badge bg-success ms-2">
                                                    <i class="fas fa-check"></i> Verified
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning ms-2">
                                                    <i class="fas fa-exclamation-triangle"></i> Unverified
                                                </span>
                                                <form method="POST" action="{{ url_for('user_management.resend_verification') }}" class="d-inline ms-2">
                                                    <button type="submit" class="btn btn-link btn-sm p-0">
                                                        Resend verification email
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        <div class="col-md-6">
                            <h5>Account Information</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Role:</strong></td>
                                    <td>
                                        <span class="badge bg-info">{{ profile_data.role.title() if profile_data.role else 'Unknown' }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        {% if profile_data.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Member Since:</strong></td>
                                    <td>{{ profile_data.created_at.strftime('%B %d, %Y') if profile_data.created_at else 'Unknown' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Login:</strong></td>
                                    <td>{{ profile_data.last_login.strftime('%B %d, %Y at %I:%M %p') if profile_data.last_login else 'Never' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Platforms:</strong></td>
                                    <td>{{ profile_data.platform_count }} connected</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    </div>

                    <!-- Edit Mode -->
                    <div id="edit-mode" class="profile-edit-mode">
                        <form method="POST" action="{{ url_for('main.profile') }}">
                            {{ form.hidden_tag() }}
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Personal Information</h5>
                                    <div class="mb-3">
                                        <label for="first_name" class="form-label">First Name</label>
                                        {{ form.first_name(class="form-control") }}
                                        {% if form.first_name.errors %}
                                            <div class="text-danger">
                                                {% for error in form.first_name.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="last_name" class="form-label">Last Name</label>
                                        {{ form.last_name(class="form-control") }}
                                        {% if form.last_name.errors %}
                                            <div class="text-danger">
                                                {% for error in form.last_name.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        {{ form.email(class="form-control") }}
                                        {% if form.email.errors %}
                                            <div class="text-danger">
                                                {% for error in form.email.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    {% if profile_data.data_processing_consent %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Data Processing Consent</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                You have consented to data processing on {{ profile_data.data_processing_consent_date.strftime('%B %d, %Y') if profile_data.data_processing_consent_date else 'an unknown date' }}.
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Data Management</h5>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('user_management.export_profile_data') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Export My Data
                                </a>
                                <a href="{{ url_for('user_management.delete_profile') }}" class="btn btn-outline-danger">
                                    <i class="fas fa-trash"></i> Delete My Profile
                                </a>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Export your personal data or permanently delete your profile in compliance with GDPR regulations.
                            </small>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Unable to load profile data. Please try again or contact support.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ g.csp_nonce if g.csp_nonce else '' }}">
function toggleEditMode() {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    
    if (editMode.classList.contains('active')) {
        // Switch to view mode
        viewMode.classList.remove('hidden');
        editMode.classList.remove('active');
    } else {
        // Switch to edit mode
        viewMode.classList.add('hidden');
        editMode.classList.add('active');
    }
}

// Handle form submission with AJAX
function setupProfileForm() {
    const profileForm = document.querySelector('#edit-mode form');
    const submitButton = document.querySelector('#edit-mode button[type="submit"]');
    
    if (profileForm && submitButton) {
        console.log('Setting up profile form AJAX handler');
        submitButton.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Submit button clicked');
            
            // Get form data
            const formData = new FormData(profileForm);
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitButton.disabled = true;
            
            // Submit the form with AJAX
            fetch(profileForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Success - refresh the page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    // Error - show message and reset button
                    alert('Profile update failed: ' + (data.message || 'Unknown error'));
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Form submission error:', error);
                alert('Profile update failed: ' + error.message);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
    }
}

// Set up the form when DOM is loaded and when edit mode is toggled
document.addEventListener('DOMContentLoaded', function() {
    setupProfileForm();
});

// Also set up form when edit mode is toggled
const originalToggleEditMode = window.toggleEditMode;
window.toggleEditMode = function() {
    originalToggleEditMode();
    setTimeout(setupProfileForm, 100);
};
</script>
{% endblock %}