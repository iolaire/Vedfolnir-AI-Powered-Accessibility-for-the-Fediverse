<div id="notification-container" class="notification-container"></div>
<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base.html" %}

{% block title %}Change Password - Vedfolnir{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Update your password to keep your account secure. You'll be logged out of other devices after changing your password.
                    </p>
                    
                    <form method="POST" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        
                        <div class="mb-3">
                            {{ form.current_password.label(class="form-label") }}
                            {{ form.current_password() }}
                            {% if form.current_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.current_password.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.new_password.label(class="form-label") }}
                            {{ form.new_password() }}
                            {% if form.new_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.new_password.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Password must be at least 8 characters long and contain at least one letter and one number.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.confirm_new_password.label(class="form-label") }}
                            {{ form.confirm_new_password() }}
                            {% if form.confirm_new_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.confirm_new_password.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Password strength indicator -->
                        <div class="mb-3">
                            <div class="password-strength">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="password-strength-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="form-text" id="password-strength-text">Password strength: <span id="strength-level">None</span></small>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-info") }}
                            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="alert alert-info mt-3" role="alert">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>Security Notice:</strong> After changing your password, you'll be automatically logged out of all other devices and sessions for security purposes.
            </div>
            
            <!-- Password Tips -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Password Security Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Use a unique password that you don't use elsewhere</li>
                        <li>Include a mix of uppercase and lowercase letters</li>
                        <li>Add numbers and special characters</li>
                        <li>Make it at least 12 characters long for better security</li>
                        <li>Consider using a password manager</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus on current password field
    const currentPasswordField = document.getElementById('current_password');
    if (currentPasswordField) {
        currentPasswordField.focus();
    }
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = [];
        
        if (password.length >= 8) strength += 1;
        else feedback.push('At least 8 characters');
        
        if (/[a-z]/.test(password)) strength += 1;
        else feedback.push('Lowercase letter');
        
        if (/[A-Z]/.test(password)) strength += 1;
        else feedback.push('Uppercase letter');
        
        if (/[0-9]/.test(password)) strength += 1;
        else feedback.push('Number');
        
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;
        else feedback.push('Special character');
        
        return { strength, feedback };
    }
    
    function updatePasswordStrength() {
        const passwordField = document.getElementById('new_password');
        const password = passwordField.value;
        const { strength, feedback } = checkPasswordStrength(password);
        const progressBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('strength-level');
        
        const percentage = (strength / 5) * 100;
        progressBar.style.width = percentage + '%';
        
        // Update color and text based on strength
        progressBar.className = 'progress-bar';
        if (strength <= 1) {
            progressBar.classList.add('bg-danger');
            strengthText.textContent = 'Very Weak';
            strengthText.className = 'text-danger';
        } else if (strength <= 2) {
            progressBar.classList.add('bg-warning');
            strengthText.textContent = 'Weak';
            strengthText.className = 'text-warning';
        } else if (strength <= 3) {
            progressBar.classList.add('bg-info');
            strengthText.textContent = 'Fair';
            strengthText.className = 'text-info';
        } else if (strength <= 4) {
            progressBar.classList.add('bg-success');
            strengthText.textContent = 'Good';
            strengthText.className = 'text-success';
        } else {
            progressBar.classList.add('bg-success');
            strengthText.textContent = 'Strong';
            strengthText.className = 'text-success';
        }
    }
    
    const newPasswordField = document.getElementById('new_password');
    if (newPasswordField) {
        newPasswordField.addEventListener('input', updatePasswordStrength);
    }
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_new_password').value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                document.getElementById('confirm_new_password').classList.add('is-invalid');
                document.getElementById('confirm_new_password').focus();
            }
        });
    }
});
</script>
{% endblock %}