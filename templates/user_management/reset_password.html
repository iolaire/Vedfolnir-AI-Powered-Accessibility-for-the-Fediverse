<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base.html" %}

{% block title %}Reset Password - Vedfolnir{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-lock-open me-2"></i>Set New Password
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Please enter your new password below. Make sure it's strong and secure.
                    </p>
                    
                    <form method="POST" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="mb-3">
                            {{ form.password.label(class="form-label") }}
                            {{ form.password() }}
                            {% if form.password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.password.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Password must be at least 8 characters long and contain at least one letter and one number.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.confirm_password.label(class="form-label") }}
                            {{ form.confirm_password() }}
                            {% if form.confirm_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.confirm_password.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Password strength indicator -->
                        <div class="mb-3">
                            <div class="password-strength">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="password-strength-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="form-text" id="password-strength-text">Password strength: <span id="strength-level">None</span></small>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-warning") }}
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <p class="mb-0">
                            Remember your password? 
                            <a href="{{ url_for('user_management.login') }}" class="text-decoration-none">
                                Sign in here
                            </a>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="alert alert-warning mt-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Security Notice:</strong> This password reset link will expire soon. 
                After resetting your password, you'll be logged out of all other devices for security.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus on password field
    const passwordField = document.getElementById('password');
    if (passwordField) {
        passwordField.focus();
    }
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = [];
        
        if (password.length >= 8) strength += 1;
        else feedback.push('At least 8 characters');
        
        if (/[a-z]/.test(password)) strength += 1;
        else feedback.push('Lowercase letter');
        
        if (/[A-Z]/.test(password)) strength += 1;
        else feedback.push('Uppercase letter');
        
        if (/[0-9]/.test(password)) strength += 1;
        else feedback.push('Number');
        
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;
        else feedback.push('Special character');
        
        return { strength, feedback };
    }
    
    function updatePasswordStrength() {
        const password = passwordField.value;
        const { strength, feedback } = checkPasswordStrength(password);
        const progressBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('strength-level');
        
        const percentage = (strength / 5) * 100;
        progressBar.style.width = percentage + '%';
        
        // Update color and text based on strength
        progressBar.className = 'progress-bar';
        if (strength <= 1) {
            progressBar.classList.add('bg-danger');
            strengthText.textContent = 'Very Weak';
            strengthText.className = 'text-danger';
        } else if (strength <= 2) {
            progressBar.classList.add('bg-warning');
            strengthText.textContent = 'Weak';
            strengthText.className = 'text-warning';
        } else if (strength <= 3) {
            progressBar.classList.add('bg-info');
            strengthText.textContent = 'Fair';
            strengthText.className = 'text-info';
        } else if (strength <= 4) {
            progressBar.classList.add('bg-success');
            strengthText.textContent = 'Good';
            strengthText.className = 'text-success';
        } else {
            progressBar.classList.add('bg-success');
            strengthText.textContent = 'Strong';
            strengthText.className = 'text-success';
        }
    }
    
    if (passwordField) {
        passwordField.addEventListener('input', updatePasswordStrength);
    }
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                document.getElementById('confirm_password').classList.add('is-invalid');
                document.getElementById('confirm_password').focus();
            }
        });
    }
});
</script>
{% endblock %}