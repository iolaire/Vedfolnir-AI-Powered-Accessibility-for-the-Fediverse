<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base.html" %}

{% block title %}Dashboard - Vedfolnir{% endblock %}

{% block head %}
<!-- Page-Specific Notification Integration -->
{% set page_id = 'user-dashboard' %}
{% set page_type = 'user_dashboard' %}
{% set notification_config = {
    'enabled_types': ['system', 'caption', 'platform', 'maintenance', 'user'],
    'auto_hide': true,
    'max_notifications': 5,
    'position': 'top-right'
} %}
{% set websocket_events = ['dashboard_update', 'system_notification', 'maintenance_notification', 'notification'] %}
{% include 'components/page_notification_integration.html' %}
{% endblock %}

{% block content %}

<!-- Role-based Dashboard Display -->
{% if is_viewer %}
    <!-- Viewer Dashboard -->
    {% include 'components/viewer_dashboard.html' %}
{% elif is_admin %}
    <!-- Admin Dashboard -->
    {% include 'components/admin_dashboard.html' %}
{% else %}
    <!-- Legacy Dashboard -->
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-2">Dashboard</h1>
                    <p class="lead text-muted mb-0">Automated alt text generation and review system</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    {% if is_admin %}
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-heart-pulse"></i> System Health
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Platform Context Banner -->
{% if active_platform %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-{{ 'mastodon' if active_platform.platform_type == 'mastodon' else 'image' }} fs-4 me-3"></i>
            <div class="flex-grow-1">
                <strong>Current Platform:</strong> {{ active_platform.name }} 
                <span class="badge bg-primary ms-2">{{ active_platform.platform_type|title }}</span>
                {% if active_platform.is_default %}
                <span class="badge bg-success ms-1">Default</span>
                {% endif %}
                <br>
                <small class="text-muted">
                    {{ active_platform.instance_url }}
                    {% if active_platform.username %} - @{{ active_platform.username }}{% endif %}
                </small>
            </div>
            <div>
                <a href="{{ url_for('platform.management') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-gear"></i> Manage
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning d-flex align-items-center">
            <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
            <div class="flex-grow-1">
                <strong>No Platform Selected</strong><br>
                <small>Please configure a platform connection to view data.</small>
            </div>
            <div>
                <a href="{{ url_for('platform.management') }}" class="btn btn-sm btn-warning">
                    <i class="bi bi-plus-circle"></i> Add Platform
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-4 mb-5">
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card h-100">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <i class="bi bi-file-earmark-text fs-1 opacity-75"></i>
                </div>
                <h5 class="card-title">
                    Total Posts
                    {% if active_platform %}
                    <br><small class="text-muted">on {{ active_platform.name }}</small>
                    {% endif %}
                </h5>
                <h2 class="mb-0">{{ "{:,}".format(stats.total_posts or 0) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card stats-card-green h-100">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <i class="bi bi-image fs-1 opacity-75"></i>
                </div>
                <h5 class="card-title">
                    Total Images
                    {% if active_platform %}
                    <br><small class="text-muted opacity-75">on {{ active_platform.name }}</small>
                    {% endif %}
                </h5>
                <h2 class="mb-0">{{ "{:,}".format(stats.total_images or 0) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card stats-card-orange h-100">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <i class="bi bi-clock-history fs-1 opacity-75"></i>
                </div>
                <h5 class="card-title">Pending Review</h5>
                <h2 class="mb-0">{{ "{:,}".format(stats.pending_review or 0) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card stats-card-blue h-100">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <i class="bi bi-check-circle fs-1 opacity-75"></i>
                </div>
                <h5 class="card-title">Posted</h5>
                <h2 class="mb-0">{{ "{:,}".format(stats.posted or 0) }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="row g-4">
    <!-- Quick Actions -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-lightning-charge me-2 text-primary"></i>
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <a href="{{ url_for('review.review_list') }}" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center">
                            <i class="bi bi-eye me-2"></i>
                            Review Images
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('review.batch_review') }}" class="btn btn-outline-primary btn-lg w-100 d-flex align-items-center justify-content-center">
                            <i class="bi bi-grid-3x3 me-2"></i>
                            Batch Review
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('static.post_approved') }}" class="btn btn-success btn-lg w-100 d-flex align-items-center justify-content-center">
                            <i class="bi bi-cloud-upload me-2"></i>
                            Post Approved
                        </a>
                    </div>
                    {% if current_user_safe and current_user_safe.role.value == 'admin' %}
                    <div class="col-md-6">
                        <a href="{{ url_for('admin.cleanup') }}" class="btn btn-outline-secondary btn-lg w-100 d-flex align-items-center justify-content-center">
                            <i class="bi bi-trash me-2"></i>
                            Data Cleanup
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-pie-chart me-2 text-primary"></i>
                <h5 class="mb-0">Status Overview</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator status-indicator-warning me-3"></div>
                            <span>Pending Review</span>
                        </div>
                        <span class="badge bg-warning">{{ stats.pending_review or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator status-indicator-success me-3"></div>
                            <span>Approved</span>
                        </div>
                        <span class="badge bg-success">{{ stats.approved or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator status-indicator-info me-3"></div>
                            <span>Posted</span>
                        </div>
                        <span class="badge bg-info">{{ stats.posted or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator status-indicator-danger me-3"></div>
                            <span>Rejected</span>
                        </div>
                        <span class="badge bg-danger">{{ stats.rejected or 0 }}</span>
                    </div>
                </div>
                
                {% if stats.total_images and stats.total_images > 0 %}
                <div class="mt-4">
                    <div class="small text-muted mb-2">Processing Progress</div>
                    {% set processed = (stats.approved or 0) + (stats.posted or 0) + (stats.rejected or 0) %}
                    {% set progress_percent = ((processed / stats.total_images) * 100) | round(1) %}
                    <div class="progress progress-sm">
                        <div class="progress-bar progress-bar-processing progress-bar-dynamic" role="progressbar" 
                             data-progress="{{ progress_percent }}"
                             aria-valuenow="{{ progress_percent }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             style="--progress-width: {{ progress_percent }}%">
                        </div>
                    </div>
                    <div class="small text-muted mt-1">{{ progress_percent }}% processed</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity (if we have data) -->
{% if current_user_safe and current_user_safe.role.value == 'admin' %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-activity me-2 text-primary"></i>
                    <h5 class="mb-0">System Status</h5>
                </div>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-sm btn-outline-primary">
                    View Details <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-database text-success me-2"></i>
                            <span class="text-success fw-medium">Database Online</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-robot text-success me-2"></i>
                            <span class="text-success fw-medium">AI Service Ready</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-cloud text-success me-2"></i>
                            <span class="text-success fw-medium">API Connected</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-hdd text-success me-2"></i>
                            <span class="text-success fw-medium">Storage OK</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Unified Notification System Integration -->
<script nonce="{{ g.csp_nonce if g.csp_nonce else '' }}">
// Initialize unified notification system for user dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Initialize page notification integrator
    if (typeof PageNotificationIntegrator !== 'undefined') {
        window.dashboardNotifications = new PageNotificationIntegrator(
            'user-dashboard',
            'user_dashboard',
            {
                notification_config: {
                    enabled_types: ['system', 'caption', 'platform', 'maintenance'],
                    auto_hide: true,
                    max_notifications: 5,
                    position: 'top-right',
                    show_progress: false
                },
                websocket_config: {
                    namespace: '/',
                    events: [
                        'caption_progress', 'caption_status', 'platform_status',
                        'notification', 'user_activity', 'system_notification'
                    ],
                    auto_connect: true,
                    reconnect_on_error: true
                },
                ui_config: {
                    container_id: 'user-dashboard-notifications',
                    theme: 'default',
                    animations: true,
                    sound_enabled: false
                }
            }
        );
        
        // Initialize the notification system
        window.dashboardNotifications.initialize().then(() => {
            console.log('Dashboard notifications initialized successfully');
            
            // Show welcome notification for new sessions
            if (sessionStorage.getItem('dashboard_welcome_shown') !== 'true') {
                window.dashboardNotifications.showNotification({
                    type: 'info',
                    title: 'Welcome to Vedfolnir',
                    message: 'Real-time notifications are now active',
                    auto_hide: true,
                    duration: 4000
                });
                sessionStorage.setItem('dashboard_welcome_shown', 'true');
            }
            
        }).catch(error => {
            console.error('Failed to initialize dashboard notifications:', error);
            // Fallback to basic notifications
            initializeFallbackNotifications();
        });
        
        // Register dashboard-specific event handlers
        window.handleCaptionProgress = function(data) {
            if (data.progress !== undefined) {
                window.dashboardNotifications.showNotification({
                    type: 'progress',
                    title: 'Caption Generation',
                    message: data.message || 'Processing images...',
                    progress: data.progress,
                    auto_hide: false,
                    id: 'caption-progress'
                });
            }
        };
        
        window.handlePlatformStatus = function(data) {
            const type = data.status === 'connected' ? 'success' : 
                        data.status === 'error' ? 'error' : 'warning';
            
            window.dashboardNotifications.showNotification({
                type: type,
                title: 'Platform Status',
                message: data.message || `Platform ${data.status}`,
                auto_hide: true,
                duration: 5000
            });
        };
        
        window.handleUserActivity = function(data) {
            // Update dashboard stats in real-time
            if (data.stats) {
                updateDashboardStats(data.stats);
            }
            
            // Show activity notifications if significant
            if (data.notification) {
                window.dashboardNotifications.showNotification({
                    type: data.notification.type || 'info',
                    title: data.notification.title || 'Activity Update',
                    message: data.notification.message,
                    auto_hide: true,
                    duration: 3000
                });
            }
        };
        
    } else {
        console.warn('PageNotificationIntegrator not available, using fallback');
        initializeFallbackNotifications();
    }
});

// Fallback notification system for compatibility
function initializeFallbackNotifications() {
    console.log('Initializing fallback notification system');
    
    // Create simple notification container if not exists
    let container = document.getElementById('user-dashboard-notifications');
    if (!container) {
        container = document.createElement('div');
        container.id = 'user-dashboard-notifications';
        container.className = 'notification-container fallback';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(container);
    }
    
    // Simple notification function
    window.showFallbackNotification = function(message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        container.appendChild(notification);
        
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
    };
}

// Update dashboard stats in real-time
function updateDashboardStats(stats) {
    const statElements = {
        'total_posts': document.querySelector('.stats-card:nth-child(1) h2'),
        'total_images': document.querySelector('.stats-card:nth-child(2) h2'),
        'pending_review': document.querySelector('.stats-card:nth-child(3) h2'),
        'posted': document.querySelector('.stats-card:nth-child(4) h2')
    };
    
    Object.entries(stats).forEach(([key, value]) => {
        const element = statElements[key];
        if (element && element.textContent !== value.toString()) {
            element.textContent = value.toLocaleString();
            // Add update animation
            element.style.transform = 'scale(1.1)';
            element.style.transition = 'transform 0.2s ease';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 200);
        }
    });
}

// Enhanced auto-refresh with notification integration
setInterval(function() {
    // Only refresh if user is active (to save resources)
    if (document.visibilityState === 'visible') {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                // Update only the stats cards to avoid disrupting user interaction
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(html, 'text/html');
                const newStats = newDoc.querySelectorAll('.stats-card h2');
                const currentStats = document.querySelectorAll('.stats-card h2');
                
                let hasChanges = false;
                newStats.forEach((newStat, index) => {
                    if (currentStats[index] && newStat.textContent !== currentStats[index].textContent) {
                        currentStats[index].textContent = newStat.textContent;
                        hasChanges = true;
                        // Add a subtle animation to indicate update
                        currentStats[index].style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            currentStats[index].style.transform = 'scale(1)';
                        }, 200);
                    }
                });
                
                // Show notification if stats changed significantly
                if (hasChanges && window.dashboardNotifications) {
                    window.dashboardNotifications.showNotification({
                        type: 'info',
                        title: 'Stats Updated',
                        message: 'Dashboard statistics have been refreshed',
                        auto_hide: true,
                        duration: 2000
                    });
                }
            })
            .catch(error => {
                console.log('Stats refresh failed:', error);
                // Show error notification
                if (window.dashboardNotifications) {
                    window.dashboardNotifications.showNotification({
                        type: 'warning',
                        title: 'Refresh Failed',
                        message: 'Unable to update dashboard statistics',
                        auto_hide: true,
                        duration: 3000
                    });
                }
            });
    }
}, 30000);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (window.dashboardNotifications && typeof window.dashboardNotifications.cleanup === 'function') {
        window.dashboardNotifications.cleanup();
    }
});
</script>
{% endblock %}