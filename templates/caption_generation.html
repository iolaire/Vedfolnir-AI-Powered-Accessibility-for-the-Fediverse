<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base.html" %}

{% block title %}Generate Captions - Vedfolnir{% endblock %}

{% block head %}
<!-- Unified Notification System Integration -->
{% set page_id = 'caption-processing-main' %}
{% set page_type = 'caption_processing' %}
{% set notification_config = {
    'enabled_types': ['caption', 'system', 'maintenance'],
    'auto_hide': true,
    'max_notifications': 5,
    'position': 'top-right',
    'show_progress': true
} %}
{% set websocket_events = ['caption_progress', 'caption_status', 'caption_complete', 'caption_error', 'system_maintenance', 'notification', 'system_notification'] %}
{% include 'components/page_notification_integration.html' %}

<script src="{{ url_for('static', filename='js/caption_generation.js') }}"></script>
<style>
    .progress-container {
        display: none;
        margin-top: 20px;
    }
    
    .task-status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .task-status.queued {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }
    
    .task-status.running {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .task-status.completed {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .task-status.failed {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .task-status.cancelled {
        background-color: #e2e3e5;
        border: 1px solid #d6d8db;
        color: #383d41;
    }
    
    .settings-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .task-history {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .task-item {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 10px;
        background-color: white;
    }
    
    .task-item:last-child {
        margin-bottom: 0;
    }
    
    .progress-details {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .character-count {
        font-size: 0.8em;
        color: #6c757d;
        float: right;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }
    }
    
    /* Enhanced UI styles */
    .error-display {
        position: relative;
    }
    
    .error-display .btn-link {
        text-decoration: none;
        color: #dc3545;
    }
    
    .error-display .btn-link:hover {
        color: #b02a37;
    }
    
    .task-item {
        transition: all 0.3s ease;
    }
    
    .task-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .btn-group .btn.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    
    .progress-details .row {
        font-size: 0.85em;
    }
    
    .progress-details strong {
        font-weight: 600;
    }
    
    .modal-body .alert {
        border-left: 4px solid;
    }
    
    .modal-body .alert-danger {
        border-left-color: #dc3545;
    }
    
    .modal-body .alert-info {
        border-left-color: #0dcaf0;
    }
    
    .modal-body .alert-success {
        border-left-color: #198754;
    }
    
    .modal-body .alert-warning {
        border-left-color: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-robot"></i> Generate Captions</h1>
                <div>
                    <a href="{{ url_for('caption_settings') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-gear"></i> Settings
                    </a>
                </div>
            </div>
            
            {% if current_platform %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Current Platform:</strong> {{ current_platform.name }} 
                ({{ current_platform.type|title }})
                {% if current_platform.username %}
                - @{{ current_platform.username }}
                {% endif %}
                <span class="float-end">
                    <small>
                        <i class="bi bi-wifi"></i> 
                        Real-time updates: <span id="websocket-status" class="text-muted">Connecting...</span>
                    </small>
                </span>
            </div>
            {% endif %}
            
            <!-- Storage Limit Notifications -->
            {% include 'components/storage_limit_notification.html' %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Active Task Status -->
            {% if active_task %}
            <div class="task-status {{ active_task.status.value }}" id="active-task-status">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5>
                            <i class="bi bi-clock-history"></i>
                            Active Task: {{ active_task.id[:8] }}...
                        </h5>
                        <p class="mb-1">
                            <strong>Status:</strong> 
                            <span class="text-capitalize">{{ active_task.status.value }}</span>
                        </p>
                        <p class="mb-1">
                            <strong>Current Step:</strong> 
                            <span id="current-step">{{ active_task.current_step or 'Initializing' }}</span>
                        </p>
                        <div class="progress mt-2" style="height: 20px;">
                            <div class="progress-bar" id="progress-bar" 
                                 role="progressbar" 
                                 style="width: {{ active_task.progress_percent or 0 }}%"
                                 aria-valuenow="{{ active_task.progress_percent or 0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span id="progress-text">{{ active_task.progress_percent or 0 }}%</span>
                            </div>
                        </div>
                        <div class="progress-details" id="progress-details">
                            <div class="row">
                                <div class="col-sm-6">
                                    <small><strong>Started:</strong> {{ active_task.created_at.strftime('%Y-%m-%d %H:%M:%S') if active_task.created_at else 'Unknown' }}</small>
                                </div>
                                <div class="col-sm-6">
                                    <small><strong>Estimated completion:</strong> <span id="estimated-completion">Calculating...</span></small>
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col-sm-6">
                                    <small><strong>Images processed:</strong> <span id="images-processed">0</span></small>
                                </div>
                                <div class="col-sm-6">
                                    <small><strong>Processing rate:</strong> <span id="processing-rate">-</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        {% if active_task.status.value in ['queued', 'running'] %}
                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelTask('{{ active_task.id }}')">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Caption Generation Form or Disabled State -->
            {% if hide_caption_form %}
            <!-- Storage Limit Disabled Form -->
            {% include 'components/caption_form_disabled.html' %}
            {% else %}
            <!-- Normal Caption Generation Form -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-play-circle"></i> Start Caption Generation</h5>
                </div>
                <div class="card-body">
                    {% if active_task and active_task.status.value in ['queued', 'running'] %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        You already have an active caption generation task. Please wait for it to complete or cancel it before starting a new one.
                    </div>
                    {% else %}
                    <form id="caption-generation-form" method="POST" action="{{ url_for('start_caption_generation') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="settings-form">
                            <h6><i class="bi bi-sliders"></i> Generation Settings</h6>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    {{ form.max_posts_per_run.label(class="form-label") }}
                                    {{ form.max_posts_per_run(class="form-control") }}
                                    <div class="form-text">Maximum number of posts to process in this run</div>
                                </div>
                                
                                <div class="form-group">
                                    {{ form.processing_delay.label(class="form-label") }}
                                    {{ form.processing_delay(class="form-control", step="0.1") }}
                                    <div class="form-text">Delay between processing posts (seconds)</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    {{ form.max_caption_length.label(class="form-label") }}
                                    {{ form.max_caption_length(class="form-control") }}
                                    <div class="form-text">Maximum length for generated captions</div>
                                </div>
                                
                                <div class="form-group">
                                    {{ form.optimal_min_length.label(class="form-label") }}
                                    {{ form.optimal_min_length(class="form-control") }}
                                    <div class="form-text">Minimum optimal caption length</div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    {{ form.optimal_max_length.label(class="form-label") }}
                                    {{ form.optimal_max_length(class="form-control") }}
                                    <div class="form-text">Maximum optimal caption length</div>
                                </div>
                                
                                <div class="form-group d-flex align-items-center">
                                    <div class="form-check">
                                        {{ form.reprocess_existing(class="form-check-input") }}
                                        {{ form.reprocess_existing.label(class="form-check-label") }}
                                    </div>
                                    <div class="form-text ms-2">Reprocess images that already have captions</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary btn-lg", id="start-generation-btn") }}
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Task History -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-clock-history"></i> Task History</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="filterTasks('all')" id="filter-all">All</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="filterTasks('completed')" id="filter-completed">Completed</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="filterTasks('failed')" id="filter-failed">Failed</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if task_history %}
                    <div class="task-history">
                        {% for task in task_history %}
                        <div class="task-item" data-status="{{ task.status }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ task.task_id[:8] }}...</strong>
                                    <span class="badge bg-{{ 'success' if task.status == 'completed' else 'danger' if task.status == 'failed' else 'warning' if task.status == 'cancelled' else 'primary' }}">
                                        {{ task.status|title }}
                                    </span>
                                    {% if task.status == 'failed' %}
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="retryTask('{{ task.task_id }}')" title="Retry this task">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    {{ task.created_at[:19] if task.created_at else 'Unknown' }}
                                </small>
                            </div>
                            
                            {% if task.results %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-check-circle"></i> {{ task.results.captions_generated }} captions generated
                                    <br>
                                    <i class="bi bi-images"></i> {{ task.results.images_processed }} images processed
                                    {% if task.results.errors_count > 0 %}
                                    <br>
                                    <i class="bi bi-exclamation-triangle text-warning"></i> {{ task.results.errors_count }} errors
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                            
                            {% if task.error_message %}
                            <div class="mt-2">
                                <div class="error-display">
                                    <small class="text-danger">
                                        <i class="bi bi-exclamation-circle"></i> 
                                        <span class="error-message">{{ task.error_message[:100] }}{% if task.error_message|length > 100 %}...{% endif %}</span>
                                    </small>
                                    <button type="button" class="btn btn-sm btn-link p-0 ms-1" onclick="showErrorDetails('{{ task.task_id }}')" title="Show error details">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No recent tasks found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task ID for JavaScript -->
{% if active_task %}
<div data-current-task-id="{{ active_task.id }}" style="display: none;"></div>
{% endif %}
{% endblock %}