<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base.html" %}

{% block title %}Platform Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Maintenance Status Banner -->
    {% if maintenance_status and maintenance_status.is_active %}
    <div class="row mb-3">
        <div class="col-12">
            {{ maintenance_status.banner_html|safe }}
            {% if maintenance_status.mode != 'test' %}
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                if (window.unifiedNotificationRenderer) {
                    window.unifiedNotificationRenderer.renderNotification({
                        type: 'info',
                        title: 'Platform Operations Restricted',
                        message: 'Platform switching, connection testing, and credential updates are temporarily disabled during maintenance. You can continue using your current platform connection.',
                        persistent: true,
                        priority: 'high'
                    });
                }
            });
            </script>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <h2>Platform Management</h2>
            <p class="text-muted">Manage your ActivityPub platform connections</p>
        </div>
    </div>

    <!-- Current Platform Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-server"></i> Current Platform
                    </h5>
                </div>
                <div class="card-body">
                    {% if active_platform %}
                    <div class="d-flex align-items-center">
                        <div class="platform-icon me-3">
                            <i
                                class="bi bi-{{ 'mastodon' if active_platform.platform_type == 'mastodon' else 'image' }} fs-2 text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ active_platform.name }}</h6>
                            <p class="mb-1 text-muted">
                                {{ active_platform.platform_type|title }} - {{ active_platform.instance_url }}
                                {% if active_platform.username %}
                                <br>@{{ active_platform.username }}
                                {% endif %}
                            </p>
                            {% if platform_stats %}
                            <div class="platform-stats mt-2">
                                <span class="badge bg-primary me-2">{{ platform_stats.get('total_posts', 0) }}
                                    posts</span>
                                <span class="badge bg-success me-2">{{ platform_stats.get('approved', 0) }}
                                    approved</span>
                                <span class="badge bg-warning me-2">{{ platform_stats.get('pending_review', 0) }}
                                    pending</span>
                                <span class="badge bg-info">{{ platform_stats.get('posted', 0) }} posted</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="platform-actions">
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Active
                            </span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                        <h5 class="mt-3">No Platform Selected</h5>
                        <p class="text-muted">Please add and select a platform connection to get started.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Connections Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list"></i> Platform Connections
                    </h5>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlatformModal">
                        <i class="bi bi-plus-circle"></i> Add Platform
                    </button>
                </div>
                <div class="card-body">
                    {% if user_platforms %}
                    <div class="row g-3">
                        {% for platform in user_platforms %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card platform-connection-card {{ 'border-primary shadow-lg' if platform.is_default else '' }} animate-fade-in"
                                data-platform-id="{{ platform.id }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="platform-info flex-grow-1">
                                            <h6 class="card-title d-flex align-items-center">
                                                <i
                                                    class="bi bi-{{ 'mastodon' if platform.platform_type == 'mastodon' else 'image' }} me-2 text-{{ 'info' if platform.platform_type == 'mastodon' else 'warning' }}"></i>
                                                <span class="fw-bold">{{ platform.name }}</span>
                                                {% if platform.is_default %}
                                                <span class="badge bg-primary ms-2 animate-pulse">Default</span>
                                                {% endif %}
                                            </h6>
                                            <p class="card-text mb-1">
                                                <small class="text-muted">
                                                    <i class="bi bi-server me-1"></i>{{ platform.platform_type|title
                                                    }}<br>
                                                    <i class="bi bi-globe me-1"></i>{{
                                                    platform.instance_url|replace('https://', '')|replace('http://', '')
                                                    }}<br>
                                                    {% if platform.username %}<i class="bi bi-person me-1"></i>@{{
                                                    platform.username }}{% endif %}
                                                </small>
                                            </p>
                                        </div>
                                    </div>

                                    <div class="platform-status mb-2">
                                        {% if platform.is_active %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Active
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i> Inactive
                                        </span>
                                        {% endif %}

                                        {% if platform.last_used %}
                                        <small class="text-muted ms-2">
                                            Last used: {{ platform.last_used.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                        {% endif %}
                                    </div>

                                    <div class="platform-actions">
                                        <div class="d-grid gap-2">
                                            <div class="btn-group" role="group">
                                                {% if not platform.is_default %}
                                                <button class="btn btn-sm btn-primary"
                                                    onclick="switchPlatform({{ platform.id }}, '{{ platform.name }}')"
                                                    title="Set as default platform">
                                                    <i class="bi bi-arrow-right-circle"></i> Switch
                                                </button>
                                                {% else %}
                                                <button class="btn btn-sm btn-success" disabled
                                                    title="Currently active platform">
                                                    <i class="bi bi-check-circle"></i> Active
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-info"
                                                    onclick="editPlatform({{ platform.id }})"
                                                    title="Edit platform settings">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </button>
                                            </div>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="testConnection({{ platform.id }}, '{{ platform.name }}')"
                                                    title="Test platform connection">
                                                    <i class="bi bi-wifi"></i> Test
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger"
                                                    onclick="deletePlatform({{ platform.id }}, '{{ platform.name }}')"
                                                    title="Delete platform connection">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Mobile-friendly summary -->
                    <div class="d-md-none mt-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-info-circle text-info"></i>
                                <strong>{{ user_platforms|length }} platform{{ 's' if user_platforms|length != 1 else '' }}
                                configured</strong><br>
                            <small>Tap any platform card to view actions</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-server display-4 text-muted"></i>
                        <h5 class="mt-3">No Platform Connections</h5>
                        <p class="text-muted">Add your first platform connection to get started.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlatformModal">
                            <i class="bi bi-plus-circle"></i> Add Platform
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'components/add_platform_modal.html' %}

<!-- Edit Platform Modal -->
<div class="modal fade" id="editPlatformModal" tabindex="-1" aria-labelledby="editPlatformModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPlatformModalLabel">Edit Platform Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editPlatformForm">
                <!-- CSRF token handled by form validation -->
                <input type="hidden" id="editPlatformId" name="platform_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editPlatformName" class="form-label">Connection Name <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editPlatformName" name="name" required minlength="1"
                            maxlength="100" placeholder="e.g., My Pixelfed Account">
                        <div class="form-text">A friendly name for this connection (1-100 characters)</div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editPlatformType" class="form-label">Platform Type <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="editPlatformType" name="platform_type" required>
                            <option value="">Select platform...</option>
                            <option value="pixelfed">Pixelfed</option>
                            <option value="mastodon">Mastodon</option>
                        </select>
                        <div class="form-text">Choose the type of ActivityPub platform</div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editInstanceUrl" class="form-label">Instance URL <span
                                class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="editInstanceUrl" name="instance_url" required
                            maxlength="500" placeholder="https://pixelfed.social">
                        <div class="form-text">The full URL of the instance (e.g., https://pixelfed.social)</div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" maxlength="200"
                            placeholder="your_username">
                        <div class="form-text">Your username on this platform (optional)</div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editAccessToken" class="form-label">Access Token <span
                                class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="editAccessToken" name="access_token" required
                            minlength="10" placeholder="Your API access token">
                        <div class="form-text">Your API access token (minimum 10 characters)</div>
                        <div class="invalid-feedback"></div>
                    </div>



                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editTestConnection"
                                name="test_connection">
                            <label class="form-check-label" for="editTestConnection">
                                Test connection after updating
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Update Platform
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePlatformModal" tabindex="-1" aria-labelledby="deletePlatformModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePlatformModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Platform Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card border-warning">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                </div>

                <p>You are about to delete the platform connection:</p>

                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title" id="deletePlatformName">Platform Name</h6>
                        <p class="card-text">
                            <small class="text-muted">
                                <span id="deletePlatformType">Platform Type</span><br>
                                <span id="deletePlatformUrl">Instance URL</span><br>
                                <span id="deletePlatformUsername">Username</span>
                            </small>
                        </p>
                    </div>
                </div>

                <div class="mt-3">
                    <h6>This will:</h6>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-x-circle text-danger"></i> Remove the platform connection permanently</li>
                        <li><i class="bi bi-x-circle text-danger"></i> Prevent access to this platform's data</li>
                        <li><i class="bi bi-info-circle text-info"></i> Preserve existing posts and images in the
                            database</li>
                        <li id="deleteDefaultWarning" class="d-none"><i
                                class="bi bi-exclamation-triangle text-warning"></i> Set another platform as default (if
                            available)</li>
                    </ul>
                </div>

                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDeletion" required>
                        <label class="form-check-label" for="confirmDeletion">
                            I understand that this action cannot be undone
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton" disabled
                    onclick="confirmPlatformDeletion()">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <i class="bi bi-trash"></i> Delete Platform
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading and Alert Modals -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0" id="loadingMessage">Processing...</p>
            </div>
        </div>
    </div>
</div>

<!-- Include unified notification system -->
<script src="{{ url_for('static', filename='js/notification_ui_renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/page_notification_integrator.js') }}"></script>

<!-- Include WebSocket-enabled platform management -->
<script src="{{ url_for('static', filename='js/platform_management_websocket.js') }}"></script>

<!-- Include legacy platform management for fallback -->
<script src="{{ url_for('static', filename='js/platform_management.js') }}"></script>

<!-- Initialize page notifications -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize page notification system for platform management
    if (window.PageNotificationIntegrator) {
        window.pageNotifications = new PageNotificationIntegrator('platform_management');
        console.log('Platform management page notifications initialized');
    }
    
    // Mark page type for WebSocket integration
    document.body.setAttribute('data-page-type', 'platform_management');
});
</script>
{% endblock %}