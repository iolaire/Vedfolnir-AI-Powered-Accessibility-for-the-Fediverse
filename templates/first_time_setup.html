<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base.html" %}

{% block title %}First Time Setup - Vedfolnir{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- Welcome Header -->
            <div class="text-center mb-5">
                <div class="mb-3">
                    <span style="font-size: 4rem;">ðŸš€</span>
                </div>
                <h1 class="display-5 fw-bold text-primary mb-3">Welcome to Vedfolnir!</h1>
                <p class="lead text-muted">Let's get you set up with your first platform connection</p>
            </div>

            <!-- Setup Steps -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">
                        <i class="bi bi-list-check text-primary me-2"></i>
                        Setup Steps
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <small class="fw-bold">1</small>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Choose Platform</h6>
                                    <small class="text-muted">Select Pixelfed or Mastodon</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <small class="fw-bold">2</small>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Get Access Token</h6>
                                    <small class="text-muted">Create app in your instance</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <small class="fw-bold">3</small>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Add Connection</h6>
                                    <small class="text-muted">Configure your platform</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <small class="fw-bold">4</small>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Start Using</h6>
                                    <small class="text-muted">Begin processing images</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Platform Selection -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">
                        <i class="bi bi-cloud text-primary me-2"></i>
                        Choose Your Platform
                    </h3>
                    
                    <div class="row g-3">
                        <!-- Pixelfed Option -->
                        <div class="col-md-6">
                            <div class="card h-100 border-2 platform-option" data-platform="pixelfed">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="bi bi-camera text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h5 class="card-title">Pixelfed</h5>
                                    <p class="card-text text-muted small">
                                        Photo sharing platform focused on visual content
                                    </p>
                                    <div class="mt-3">
                                        <span class="badge bg-success-subtle text-success">Simple Setup</span>
                                        <span class="badge bg-info-subtle text-info">Photo Focused</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mastodon Option -->
                        <div class="col-md-6">
                            <div class="card h-100 border-2 platform-option" data-platform="mastodon">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="bi bi-chat-dots text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h5 class="card-title">Mastodon</h5>
                                    <p class="card-text text-muted small">
                                        Decentralized social network with media support
                                    </p>
                                    <div class="mt-3">
                                        <span class="badge bg-success-subtle text-success">Simple Setup</span>
                                        <span class="badge bg-info-subtle text-info">Social Network</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setup Instructions -->
            <div class="card shadow-sm border-0 mb-4" id="setup-instructions" style="display: none;">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">
                        <i class="bi bi-gear text-primary me-2"></i>
                        Setup Instructions
                    </h3>
                    
                    <!-- Pixelfed Instructions -->
                    <div id="pixelfed-instructions" class="platform-instructions" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Pixelfed Setup:</strong> You only need an access token to get started.
                        </div>
                        
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item">
                                <strong>Go to your Pixelfed instance</strong><br>
                                <small class="text-muted">Navigate to Settings â†’ Applications</small>
                            </li>
                            <li class="list-group-item">
                                <strong>Create a new application</strong><br>
                                <small class="text-muted">Name: "Vedfolnir", Scopes: read + write</small>
                            </li>
                            <li class="list-group-item">
                                <strong>Copy your access token</strong><br>
                                <small class="text-muted">You'll need this for the form below</small>
                            </li>
                        </ol>
                    </div>
                    
                    <!-- Mastodon Instructions -->
                    <div id="mastodon-instructions" class="platform-instructions" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Mastodon Setup:</strong> You only need an access token to get started.
                        </div>
                        
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item">
                                <strong>Go to your Mastodon instance</strong><br>
                                <small class="text-muted">Navigate to Preferences â†’ Development</small>
                            </li>
                            <li class="list-group-item">
                                <strong>Create a new application</strong><br>
                                <small class="text-muted">Name: "Vedfolnir", Scopes: read + write</small>
                            </li>
                            <li class="list-group-item">
                                <strong>Copy your access token</strong><br>
                                <small class="text-muted">You'll need this for the form below</small>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Platform Form -->
            <div class="card shadow-sm border-0 mb-4" id="platform-form" style="display: none;">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">
                        <i class="bi bi-plus-circle text-primary me-2"></i>
                        Add Platform Connection
                    </h3>
                    
                    <form id="addPlatformForm">
                        {{ csrf_token() }}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="platformName" class="form-label">Connection Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="platformName" name="name" required minlength="1"
                                       maxlength="100" placeholder="My Pixelfed Account">
                                <div class="form-text">A friendly name for this connection (1-100 characters)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="instanceUrl" class="form-label">Instance URL <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" id="instanceUrl" name="instance_url" required
                                       maxlength="500" placeholder="https://pixelfed.social">
                                <div class="form-text">The full URL of the instance (e.g., https://pixelfed.social)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username" maxlength="200"
                                       placeholder="your_username">
                                <div class="form-text">Your username on this platform (optional)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="accessToken" class="form-label">Access Token <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="accessToken" name="access_token" required
                                       minlength="10" placeholder="Your API access token">
                                <div class="form-text">Your API access token (minimum 10 characters)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="testConnection" name="test_connection" checked>
                                <label class="form-check-label" for="testConnection">
                                    Test connection before saving
                                </label>
                            </div>
                        </div>
                        
                        <input type="hidden" id="platformType" name="platform_type" value="">
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-secondary" id="backButton">
                                <i class="bi bi-arrow-left me-2"></i>Back
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <i class="bi bi-check-circle me-2"></i>Add Connection & Continue
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Skip Option -->
            <div class="text-center">
                <p class="text-muted small">
                    Need help? Check the 
                    <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#helpModal">
                        setup documentation
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Setup Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>For detailed setup instructions, please refer to the README documentation or contact your system administrator.</p>
                <p>The Vedfolnir helps you automatically generate and manage alt text for images on ActivityPub platforms.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.platform-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.platform-option:hover {
    border-color: var(--bs-primary) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.platform-option.selected {
    border-color: var(--bs-primary) !important;
    background-color: var(--bs-primary-bg-subtle);
}

.list-group-numbered {
    counter-reset: section;
}

.list-group-numbered .list-group-item {
    border: 1px solid var(--bs-border-color);
    margin-bottom: 0.5rem;
    border-radius: 0.375rem;
}

.list-group-numbered .list-group-item::before {
    counter-increment: section;
    content: counter(section);
    position: absolute;
    left: -2.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: var(--bs-primary);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const platformOptions = document.querySelectorAll('.platform-option');
    const setupInstructions = document.getElementById('setup-instructions');
    const platformForm = document.getElementById('platform-form');
    const platformTypeInput = document.getElementById('platformType');
    const backButton = document.getElementById('backButton');
    const addPlatformForm = document.getElementById('addPlatformForm');
    
    // Platform selection
    platformOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            platformOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            const platform = this.dataset.platform;
            platformTypeInput.value = platform;
            
            // Show instructions for selected platform
            document.querySelectorAll('.platform-instructions').forEach(inst => {
                inst.style.display = 'none';
            });
            document.getElementById(platform + '-instructions').style.display = 'block';
            
            // Show setup instructions and form
            setupInstructions.style.display = 'block';
            platformForm.style.display = 'block';
            
            // Update form placeholders based on platform
            updateFormPlaceholders(platform);
            
            // Smooth scroll to instructions
            setupInstructions.scrollIntoView({ behavior: 'smooth' });
        });
    });
    
    // Back button
    backButton.addEventListener('click', function() {
        // Hide instructions and form
        setupInstructions.style.display = 'none';
        platformForm.style.display = 'none';
        
        // Remove selected class from all options
        platformOptions.forEach(opt => opt.classList.remove('selected'));
        
        // Scroll back to platform selection
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    });
    
    // Form submission
    addPlatformForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const formData = new FormData(form);

        // Convert FormData to JSON and validate
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'test_connection') {
                data[key] = value ? value.trim() : '';
            }
        }
        
        // Explicitly handle test_connection checkbox
        const testConnectionCheckbox = form.querySelector('#testConnection');
        data.test_connection = testConnectionCheckbox ? testConnectionCheckbox.checked : false;
        
        // Client-side validation
        const validationErrors = validatePlatformForm(data);
        if (validationErrors.length > 0) {
            showAlert('danger', 'Validation errors: ' + validationErrors.join('; '));
            return;
        }
        
        // Show loading state
        const spinner = submitButton.querySelector('.spinner-border');
        const originalText = submitButton.innerHTML;
        submitButton.disabled = true;
        spinner.classList.remove('d-none');
        
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        // Submit to API
        fetch('/api/add_platform', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || ''
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Show success message
                showAlert('success', result.message + ' Redirecting to dashboard...');
                
                // Redirect to dashboard after short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } else {
                showAlert('danger', result.error || 'Failed to add platform connection');
            }
        })
        .catch(error => {
            showAlert('danger', 'Network error occurred while adding platform: ' + (error.message || 'Unknown error'));
        })
        .finally(() => {
            // Hide loading state
            submitButton.disabled = false;
            spinner.classList.add('d-none');
        });
    });
    
    function updateFormPlaceholders(platform) {
        const nameInput = document.getElementById('platformName');
        const instanceInput = document.getElementById('instanceUrl');
        
        if (platform === 'pixelfed') {
            nameInput.placeholder = 'My Pixelfed Account';
            instanceInput.placeholder = 'https://pixelfed.social';
        } else if (platform === 'mastodon') {
            nameInput.placeholder = 'My Mastodon Account';
            instanceInput.placeholder = 'https://mastodon.social';
        }
    }
    
    function validatePlatformForm(data) {
        const errors = [];
        
        // Validate required fields
        const requiredFields = ['name', 'platform_type', 'instance_url', 'access_token'];
        for (const field of requiredFields) {
            if (!data[field]) {
                errors.push(`${field.replace('_', ' ')} is required`);
            }
        }
        
        // Validate name length
        if (data.name && (data.name.length < 1 || data.name.length > 100)) {
            errors.push('Platform name must be between 1 and 100 characters');
        }
        
        // Validate platform type
        if (data.platform_type && !['pixelfed', 'mastodon'].includes(data.platform_type.toLowerCase())) {
            errors.push('Platform type must be either Pixelfed or Mastodon');
        }
        
        // Validate instance URL format
        if (data.instance_url) {
            try {
                const url = new URL(data.instance_url);
                if (!['http:', 'https:'].includes(url.protocol)) {
                    errors.push('Instance URL must use HTTP or HTTPS protocol');
                }
            } catch (e) {
                errors.push('Instance URL format is invalid');
            }
            
            if (data.instance_url.length > 500) {
                errors.push('Instance URL must be less than 500 characters');
            }
        }
        
        // Validate access token
        if (data.access_token && data.access_token.length < 10) {
            errors.push('Access token appears to be too short (minimum 10 characters)');
        }
        
        // Validate username length if provided
        if (data.username && data.username.length > 200) {
            errors.push('Username must be less than 200 characters');
        }
        
        return errors;
    }
    
    function showAlert(type, message) {
        // Sanitize inputs to prevent XSS
        const sanitizedType = type.replace(/[^a-zA-Z-]/g, '');
        const sanitizedMessage = document.createTextNode(message).textContent;
        
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${sanitizedType} alert-dismissible fade show`;
        
        // Create message element safely
        const messageSpan = document.createElement('span');
        messageSpan.textContent = sanitizedMessage;
        
        // Create close button safely
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close';
        closeButton.setAttribute('data-bs-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        
        alertDiv.appendChild(messageSpan);
        alertDiv.appendChild(closeButton);
        
        // Insert at top of form
        const form = document.getElementById('platform-form');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Scroll to alert
        alertDiv.scrollIntoView({ behavior: 'smooth' });
        
        // Auto-dismiss after 7 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.classList.add('fade');
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 300);
            }
        }, 7000);
    }
});
</script>
{% endblock %}