<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base.html" %}

{% block title %}User Profile - Vedfolnir{% endblock %}

{% block head %}
<!-- Page-Specific Notification Integration -->
{% set page_id = 'user-profile' %}
{% set page_type = 'user_profile' %}
{% set notification_config = {
    'enabled_types': ['user', 'security', 'system', 'maintenance'],
    'auto_hide': true,
    'max_notifications': 5,
    'position': 'top-right',
    'show_timestamp': true
} %}
{% set websocket_events = ['user_profile_update', 'security_notification', 'system_notification', 'notification'] %}
{% include 'components/page_notification_integration.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Profile Header -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center profile-avatar">
                                        <i class="bi bi-person-fill icon-sm"></i>
                                    </div>
                                </div>
                                <div>
                                    <h2 class="mb-1">{{ current_user_safe.username }}</h2>
                                    <p class="text-muted mb-1">{{ current_user_safe.email }}</p>
                                    <span
                                        class="badge bg-{{ 'success' if current_user_safe.role.value == 'admin' else 'primary' }}-subtle text-{{ 'success' if current_user_safe.role.value == 'admin' else 'primary' }}">
                                        {{ current_user_safe.role.value.title() }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <p class="text-muted small mb-1">Member since</p>
                            <p class="fw-semibold">{{ current_user_safe.created_at.strftime('%B %d, %Y') if current_user_safe.created_at else 'Unknown' }}</p>
                            {% if current_user_safe.last_login %}
                            <p class="text-muted small mb-0">Last login: {{ current_user_safe.last_login.strftime('%Y-%m-%d
                                %H:%M') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Platform Context -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-cloud-check text-primary me-2"></i>
                        Current Platform Context
                    </h4>
                </div>
                <div class="card-body">
                    {% if active_platform %}
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-{{ 'camera' if active_platform.platform_type == 'pixelfed' else 'chat-dots' }} text-primary icon-2xl"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">{{ active_platform.name }}</h5>
                                    <p class="text-muted mb-1">{{ active_platform.platform_type.title() }} â€¢ {{
                                        active_platform.instance_url }}</p>
                                    {% if active_platform.username %}
                                    <p class="text-muted small mb-0">@{{ active_platform.username }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            {% if active_platform.is_default %}
                            <span class="badge bg-success-subtle text-success mb-2">Default Platform</span><br>
                            {% endif %}
                            <a href="{{ url_for('platform.management') }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-gear me-1"></i>Manage Platforms
                            </a>
                        </div>
                    </div>

                    <!-- Platform Statistics -->
                    {% if platform_stats and active_platform.id in platform_stats %}
                    {% set stats = platform_stats[active_platform.id] %}
                    <hr class="my-3">
                    <div class="row text-center">
                        <div class="col-6 col-md-3">
                            <div class="border-end">
                                <h4 class="text-primary mb-0">{{ stats.posts }}</h4>
                                <small class="text-muted">Posts</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border-end">
                                <h4 class="text-info mb-0">{{ stats.images }}</h4>
                                <small class="text-muted">Images</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border-end">
                                <h4 class="text-warning mb-0">{{ stats.pending }}</h4>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <h4 class="text-success mb-0">{{ stats.posted }}</h4>
                            <small class="text-muted">Posted</small>
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle text-warning icon-3xl"></i>
                        <h5 class="mt-3">No Active Platform</h5>
                        <p class="text-muted">You don't have an active platform connection.</p>
                        <a href="{{ url_for('platform.management') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Add Platform Connection
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- User Settings -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-gear text-primary me-2"></i>
                        Settings
                    </h4>
                </div>
                <div class="card-body">
                    {% if active_platform %}
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="max_posts_per_run" class="form-label">Max Posts Per Run</label>
                            <input type="number" class="form-control" id="max_posts_per_run" name="max_posts_per_run"
                                value="{{ user_settings.max_posts_per_run if user_settings else 50 }}" min="1" max="500"
                                required>
                            <div class="form-text">Maximum number of posts to process in a single run (1-500)</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-sm" onclick="updateSettings(event); return false;">
                                <i class="bi bi-check-circle me-1"></i>Save Settings
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-exclamation-triangle text-warning icon-2xl"></i>
                        <p class="text-muted mt-2 mb-0">No active platform to configure</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-device-hdd text-primary me-2"></i>
                        Active Sessions
                    </h4>
                </div>
                <div class="card-body">
                    {% if active_sessions %}
                    <div class="list-group list-group-flush">
                        {% for session in active_sessions %}
                        <div class="list-group-item px-0 py-2 border-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        {% if session.is_current %}
                                        <i class="bi bi-circle-fill text-success me-2 icon-xs"></i>
                                        <strong>Current Session</strong>
                                        {% else %}
                                        <i class="bi bi-circle text-muted me-2 icon-xs"></i>
                                        <span>Other Device</span>
                                        {% endif %}
                                    </div>
                                    {% if session.platform_name %}
                                    <small class="text-muted">{{ session.platform_name }} ({{
                                        session.platform_type.title() }})</small><br>
                                    {% endif %}
                                    <small class="text-muted">{{ session.updated_at.strftime('%Y-%m-%d %H:%M')
                                        }}</small>
                                </div>
                                {% if not session.is_current %}
                                <button class="btn btn-outline-danger btn-sm"
                                    onclick="terminateSession('{{ session.session_id }}')">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <hr class="my-3">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('static.logout_all') }}" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-power me-2"></i>Logout All Devices
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-device-hdd text-muted icon-2xl"></i>
                        <p class="text-muted mt-2 mb-0">No active sessions</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Platform Connections -->
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-cloud text-primary me-2"></i>
                            Platform Connections
                        </h4>
                        <a href="{{ url_for('platform.management') }}" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus-circle me-2"></i>Add Platform
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if user_platforms %}
                    <div class="row">
                        {% for platform in user_platforms %}
                        <div class="col-lg-6 col-xl-4 mb-3">
                            <div class="card h-100 border-2 {{ 'border-primary' if platform.is_default else '' }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center">
                                            <i
                                                class="bi bi-{{ 'camera' if platform.platform_type == 'pixelfed' else 'chat-dots' }} text-primary me-2"></i>
                                            <h6 class="mb-0">{{ platform.name }}</h6>
                                        </div>
                                        {% if platform.is_default %}
                                        <span class="badge bg-primary-subtle text-primary">Default</span>
                                        {% endif %}
                                    </div>

                                    <p class="text-muted small mb-2">
                                        {{ platform.platform_type.title() }}<br>
                                        {{ platform.instance_url }}
                                        {% if platform.username %}<br>@{{ platform.username }}{% endif %}
                                    </p>

                                    <!-- Platform Statistics -->
                                    {% if platform_stats and platform.id in platform_stats %}
                                    {% set stats = platform_stats[platform.id] %}
                                    <div class="row text-center small mb-3">
                                        <div class="col-3">
                                            <div class="text-primary fw-semibold">{{ stats.posts }}</div>
                                            <div class="text-muted">Posts</div>
                                        </div>
                                        <div class="col-3">
                                            <div class="text-info fw-semibold">{{ stats.images }}</div>
                                            <div class="text-muted">Images</div>
                                        </div>
                                        <div class="col-3">
                                            <div class="text-warning fw-semibold">{{ stats.pending }}</div>
                                            <div class="text-muted">Pending</div>
                                        </div>
                                        <div class="col-3">
                                            <div class="text-success fw-semibold">{{ stats.posted }}</div>
                                            <div class="text-muted">Posted</div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="d-flex gap-2">
                                        {% if not active_platform or platform.id != active_platform.id %}
                                        <button class="btn btn-outline-primary btn-sm flex-fill"
                                            onclick="switchPlatform({{ platform.id }})">
                                            <i class="bi bi-arrow-right-circle me-1"></i>Switch
                                        </button>
                                        {% else %}
                                        <button class="btn btn-primary btn-sm flex-fill" disabled>
                                            <i class="bi bi-check-circle me-1"></i>Active
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-secondary btn-sm"
                                            onclick="testPlatform({{ platform.id }})">
                                            <i class="bi bi-wifi"></i>
                                        </button>
                                    </div>

                                    {% if platform.last_used %}
                                    <small class="text-muted">Last used: {{ platform.last_used.strftime('%Y-%m-%d
                                        %H:%M') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-cloud-plus text-muted icon-4xl"></i>
                        <h5 class="mt-3">No Platform Connections</h5>
                        <p class="text-muted">Add your first platform connection to get started.</p>
                        <a href="{{ url_for('platform.management') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Add Platform Connection
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function switchPlatform(platformId) {
        window.csrfHandler.secureFetch(`/api/switch_platform/${platformId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    // Reload page to update context
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Network error: ' + error.message);
            });
    }

    function testPlatform(platformId) {
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;

        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        button.disabled = true;

        window.csrfHandler.secureFetch(`/api/test_platform/${platformId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', 'Connection test failed: ' + data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Network error: ' + error.message);
            })
            .finally(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            });
    }

    function terminateSession(sessionId) {
        if (!confirm('Are you sure you want to terminate this session?')) {
            return;
        }

        window.csrfHandler.secureFetch(`/api/sessions/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Session terminated successfully');
                    // Reload page to update session list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Network error: ' + error.message);
            });
    }

    function updateSettings(event) {
        event.preventDefault();

        // Get the form element properly
        const form = event.target.closest('form') || document.getElementById('settingsForm');
        
        if (!form) {
            showAlert('danger', 'Form not found');
            return;
        }
        
        const formData = new FormData(form);
        const maxPostsPerRun = parseInt(formData.get('max_posts_per_run'));

        // Validate input
        if (isNaN(maxPostsPerRun) || maxPostsPerRun < 1 || maxPostsPerRun > 500) {
            showAlert('danger', 'Max posts per run must be between 1 and 500');
            return;
        }

        // Disable form during submission
        const submitBtn = form.querySelector('button[type="submit"]') || event.target;
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';

        // Get CSRF token
        window.csrfHandler.secureFetch('/api/update_user_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                max_posts_per_run: maxPostsPerRun
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Settings updated successfully!');
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Network error: ' + error.message);
            })
            .finally(() => {
                // Re-enable form
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alertDiv);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Note: Using onclick handler on button instead of form submit event listener
    // because the form submit event wasn't working reliably
</script>
{% endblock %}