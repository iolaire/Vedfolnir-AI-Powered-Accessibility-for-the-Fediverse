<!DOCTYPE html>
<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Vedfolnir{% endblock %}</title>
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Modern font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap and icons with fallback -->
    <link href="{{ url_for('static', filename='css/bootstrap-fallback.css') }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.remove()">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" onerror="this.remove()">
    
    <!-- Custom styles -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/platform_styles.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/fixes.css') }}" rel="stylesheet">
    
    <!-- Session Management Styles -->
    <style>
        .session-status-indicator {
            display: inline-block;
            margin-left: 0.5rem;
            font-size: 0.75rem;
        }
        
        .session-status-indicator i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .platform-switch-item:hover {
            background-color: var(--bs-dropdown-link-hover-bg);
        }
        
        .dropdown-item-text {
            padding: 0.25rem 1rem;
            margin-bottom: 0;
            font-size: 0.875rem;
            color: var(--bs-dropdown-color);
            text-decoration: none;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
        }
    </style>
    
    <!-- Favicon -->
    {% include 'includes/favicon_meta.html' %}
    
    {% block head %}{% endblock %}
</head>
<body data-authenticated="{% if current_user_safe %}true{% else %}false{% endif %}">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}" aria-label="Vedfolnir - Go to dashboard">
                <img src="{{ url_for('static', filename='images/Logo.png') }}" 
                     alt="Vedfolnir Logo" 
                     class="navbar-logo me-2"
                     height="32"
                     onerror="this.style.display='none'">
                <span class="navbar-brand-text">Vedfolnir</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
                    </li>
                    {% if current_user_safe %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="reviewDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Review
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="reviewDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('review_list') }}">
                                    <i class="bi bi-image"></i> Individual Images
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('batch_review') }}">
                                    <i class="bi bi-grid-3x3"></i> Batch Review
                                </a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="platformsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Platforms{% if active_platform %}: {{ active_platform.name }}{% endif %}
                            </a>
                            <ul class="dropdown-menu platform-dropdown" aria-labelledby="platformsDropdown">
                                {% if active_platform %}
                                <li><h6 class="dropdown-header">
                                    <i class="bi bi-server"></i> Current Platform
                                </h6></li>
                                <li><span class="dropdown-item-text">
                                    <strong>{{ active_platform.name }}</strong><br>
                                    <small class="text-muted">
                                        {{ active_platform.platform_type|title }} - {{ active_platform.instance_url|replace('https://', '')|replace('http://', '') }}
                                        {% if active_platform.username %}<br>@{{ active_platform.username }}{% endif %}
                                    </small>
                                </span></li>
                                
                                {% if user_platforms|length > 1 %}
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">
                                    <i class="bi bi-arrow-repeat"></i> Switch Platform
                                </h6></li>
                                {% for platform in user_platforms %}
                                    {% if platform.id != active_platform.id %}
                                    <li>
                                        <a class="dropdown-item platform-switch-item" href="#" onclick="quickSwitchPlatform({{ platform.id }}, '{{ platform.name }}')">
                                            <i class="bi bi-{{ 'mastodon' if platform.platform_type == 'mastodon' else 'image' }}"></i>
                                            {{ platform.name }}
                                            {% if platform.is_default %}
                                            <span class="badge bg-primary ms-1">Default</span>
                                            {% endif %}
                                            <br><small class="text-muted">{{ platform.platform_type|title }}</small>
                                        </a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                {% endif %}
                                
                                <li><hr class="dropdown-divider"></li>
                                {% else %}
                                <li><h6 class="dropdown-header">
                                    <i class="bi bi-exclamation-triangle text-warning"></i> No Platform Configured
                                </h6></li>
                                <li><span class="dropdown-item-text text-muted">
                                    You need to configure a platform connection to use this feature.
                                </span></li>
                                <li><hr class="dropdown-divider"></li>
                                {% endif %}
                                <li><a class="dropdown-item" href="{{ url_for('platform_management') }}">
                                    <i class="bi bi-gear"></i> Manage Platforms
                                </a></li>
                            </ul>
                        </li>
                        {% if active_platform %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('caption_generation') }}">
                                Generate Captions
                            </a>
                        </li>
                        {% endif %}

                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if current_user_safe %}
                        <!-- Session Status Indicator -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="sessionDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i>
                                <span data-user-info="username">{{ current_user_safe.username }}</span>
                                <span class="session-status-indicator" id="sessionStatusIndicator" title="Session Active">
                                    <i class="bi bi-circle-fill text-success"></i>
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sessionDropdown">
                                <li><h6 class="dropdown-header">
                                    <i class="bi bi-person"></i> Account
                                </h6></li>
                                <li><span class="dropdown-item-text">
                                    <strong data-user-info="username">{{ current_user_safe.username }}</strong><br>
                                    <small class="text-muted" data-user-info="email">{{ current_user_safe.email }}</small>
                                </span></li>
                                
                                {% if active_platform %}
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">
                                    <i class="bi bi-server"></i> Current Platform
                                </h6></li>
                                <li><span class="dropdown-item-text">
                                    <span data-current-platform data-platform-id="{{ active_platform.id }}" data-platform-type="{{ active_platform.platform_type }}">{{ active_platform.name }}</span><br>
                                    <small class="text-muted">{{ active_platform.platform_type|title }}</small>
                                </span></li>
                                {% endif %}
                                
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('user_management.profile') }}">
                                    <i class="bi bi-person-gear me-2"></i>Profile & Settings
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('gdpr.privacy_policy') }}" target="_blank">
                                    <i class="bi bi-shield-lock me-2"></i>Privacy Policy
                                </a></li>
                                {% if current_user_safe and (current_user_safe.role_value == 'admin' or (current_user_safe.role and current_user_safe.role.value == 'admin')) %}
                                <li><a class="dropdown-item" href="{{ url_for('admin.dashboard') }}">
                                    <i class="bi bi-shield-check me-2"></i>Site Administration
                                </a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('logout_all') }}" onclick="handleLogout(event)">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('logout_all') }}" onclick="handleLogoutAll(event)">
                                    <i class="bi bi-power me-2"></i>Logout All Devices
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('user_management.login') }}">Login</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4" id="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" onerror="console.warn('Bootstrap JS failed to load from CDN')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/csrf-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/websocket-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/error_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/session-sync.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/platform_context_refresh.js') }}"></script>
    
    <!-- Session Management JavaScript -->
    <script>
        // Handle logout with session sync
        function handleLogout(event) {
            if (window.sessionSync) {
                window.sessionSync.broadcastLogout();
            }
            // Let the default action proceed
            return true;
        }
        
        // Handle logout all devices
        function handleLogoutAll(event) {
            if (window.sessionSync) {
                window.sessionSync.broadcastLogout();
            }
            // Let the default action proceed
            return true;
        }
        
        // Update session status indicator
        function updateSessionStatus(isActive) {
            const indicator = document.getElementById('sessionStatusIndicator');
            if (indicator) {
                const icon = indicator.querySelector('i');
                if (isActive) {
                    icon.className = 'bi bi-circle-fill text-success';
                    indicator.title = 'Session Active';
                } else {
                    icon.className = 'bi bi-circle-fill text-warning';
                    indicator.title = 'Session Issues';
                }
            }
        }
        
        // Listen for session state changes
        window.addEventListener('sessionStateChanged', function(event) {
            updateSessionStatus(true);
        });
        
        window.addEventListener('sessionExpired', function(event) {
            updateSessionStatus(false);
        });
        
        // Quick platform switching function
        window.quickSwitchPlatform = async function(platformId, platformName) {
            try {
                // Show loading state
                const switchItems = document.querySelectorAll('.platform-switch-item');
                switchItems.forEach(item => {
                    item.style.opacity = '0.6';
                    item.style.pointerEvents = 'none';
                });
                
                // Use secure fetch with automatic CSRF handling
                const response = await window.csrfHandler.secureFetch(`/api/switch_platform/${platformId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Notify session sync about the platform switch
                    if (window.sessionSync) {
                        window.sessionSync.notifyPlatformSwitch(platformId, platformName);
                    }
                    
                    // Update UI immediately
                    if (result.platform) {
                        updatePlatformUI(result.platform);
                    }
                    
                    // Show success message
                    if (window.errorHandler) {
                        window.errorHandler.showNotification(result.message, 'success');
                    }
                    
                    // Refresh the page after a short delay to ensure all components are updated
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to switch platform');
                }
            } catch (error) {
                console.error('Error switching platform:', error);
                
                if (window.errorHandler) {
                    window.errorHandler.showNotification('Failed to switch platform: ' + error.message, 'danger');
                } else {
                    alert('Failed to switch platform: ' + error.message);
                }
            } finally {
                // Restore UI state
                const switchItems = document.querySelectorAll('.platform-switch-item');
                switchItems.forEach(item => {
                    item.style.opacity = '';
                    item.style.pointerEvents = '';
                });
            }
        };
        
        // Update platform UI elements
        function updatePlatformUI(platform) {
            // Update platform dropdown text
            const platformDropdown = document.getElementById('platformsDropdown');
            if (platformDropdown) {
                platformDropdown.textContent = `Platforms: ${platform.name}`;
            }
            
            // Update current platform displays
            const currentPlatformElements = document.querySelectorAll('[data-current-platform]');
            currentPlatformElements.forEach(element => {
                element.textContent = platform.name;
                element.setAttribute('data-platform-id', platform.id);
                element.setAttribute('data-platform-type', platform.platform_type);
            });
        }
        
        // Fallback for Bootstrap JS functionality
        if (typeof bootstrap === 'undefined') {
            document.addEventListener('click', function(e) {
                if (e.target.matches('[data-bs-toggle="dropdown"]')) {
                    e.preventDefault();
                    const menu = e.target.nextElementSibling;
                    if (menu && menu.classList.contains('dropdown-menu')) {
                        menu.classList.toggle('show');
                    }
                }
                // Close dropdowns when clicking outside
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    if (!menu.parentElement.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                });
            });
        }
        
        // Session management functions
        function handleLogout(event) {
            // Notify other tabs about logout
            if (window.vedfolnir && window.vedfolnir.sessionSync) {
                window.vedfolnir.sessionSync.notifyLogout();
            }
            
            // Allow normal logout to proceed
            return true;
        }
        
        // Platform switching handler
        function handlePlatformSwitch(platformId, platformName) {
            // Notify other tabs about platform switch
            if (window.vedfolnir && window.vedfolnir.sessionSync) {
                window.vedfolnir.sessionSync.notifyPlatformSwitch({
                    id: platformId,
                    name: platformName
                });
            }
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>