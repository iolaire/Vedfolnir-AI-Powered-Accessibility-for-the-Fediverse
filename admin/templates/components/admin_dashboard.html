<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

<!-- Admin Dashboard Component -->
<!-- Requirements: 1.2, 1.3, 1.4, 1.5 -->

<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 fw-bold text-primary mb-2">Administrator Dashboard</h1>
            <p class="lead text-muted">System overview and management controls</p>
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">System Health</h6>
                    <div class="fw-bold fs-4 mb-1" id="system-health-status">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Loading...
                    </div>
                    <small class="text-muted" id="system-health-details">
                        Checking system components...
                    </small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-right me-1"></i>Details
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">Total Users</h6>
                    <div class="fw-bold fs-4 mb-1">{{ stats.total_users or 0 }}</div>
                    <small class="text-muted">{{ stats.active_users or 0 }} active</small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('admin.user_management') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-gear me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">Platforms</h6>
                    <div class="fw-bold fs-4 mb-1">{{ stats.total_platforms or 0 }}</div>
                    <small class="text-muted">Connected</small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('platform_management') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">Images</h6>
                    <div class="fw-bold fs-4 mb-1">{{ stats.total_images or 0 }}</div>
                    <small class="text-muted">{{ stats.total_posts or 0 }} posts</small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('batch_review') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-eye me-1"></i>Review
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2 text-primary"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('admin.user_management') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-person-gear fs-1 mb-2"></i>
                                <span class="fw-semibold">User Management</span>
                                <small class="text-muted mt-1">Manage user accounts</small>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-activity fs-1 mb-2"></i>
                                <span class="fw-semibold">System Health</span>
                                <small class="text-muted mt-1">Monitor system status</small>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('admin.security_audit_dashboard') }}" class="btn btn-outline-danger w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-shield-check fs-1 mb-2"></i>
                                <span class="fw-semibold">Security Audit</span>
                                <small class="text-muted mt-1">Security monitoring</small>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('platform_management') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-gear-wide-connected fs-1 mb-2"></i>
                                <span class="fw-semibold">Platform Config</span>
                                <small class="text-muted mt-1">Configure platforms</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Admin Dashboard Component JavaScript with WebSocket Health Notifications
(function() {
    'use strict';
    
    let websocketConnected = false;
    let healthNotificationHandler = null;
    
    // Initialize WebSocket connection for real-time health notifications
    function initializeHealthNotifications() {
        try {
            // Initialize page notifications for admin dashboard
            if (typeof window.PageNotificationIntegrator !== 'undefined') {
                healthNotificationHandler = new window.PageNotificationIntegrator('admin_dashboard', {
                    namespace: '/admin',
                    enableHealthMonitoring: true,
                    notificationTypes: ['admin', 'system', 'security'],
                    onHealthUpdate: handleHealthUpdate,
                    onConnectionChange: handleConnectionChange
                });
                
                healthNotificationHandler.initialize();
            } else {
                console.warn('PageNotificationIntegrator not available, falling back to polling');
                fallbackToPolling();
            }
        } catch (error) {
            console.error('Failed to initialize health notifications:', error);
            fallbackToPolling();
        }
    }
    
    // Handle real-time health updates via WebSocket
    function handleHealthUpdate(healthData) {
        try {
            console.log('Received health update:', healthData);
            
            const statusElement = document.getElementById('system-health-status');
            const detailsElement = document.getElementById('system-health-details');
            
            if (!statusElement || !detailsElement) {
                return;
            }
            
            // Update status from WebSocket data
            if (healthData.system_health_data && healthData.system_health_data.health_status) {
                const health = healthData.system_health_data.health_status;
                updateHealthDisplay(statusElement, detailsElement, health);
            } else if (healthData.data && healthData.data.health_status) {
                const health = healthData.data.health_status;
                updateHealthDisplay(statusElement, detailsElement, health);
            }
            
            // Show notification for critical health changes
            if (healthData.priority === 'critical' || healthData.type === 'error') {
                showHealthAlert(healthData);
            }
            
        } catch (error) {
            console.error('Error handling health update:', error);
        }
    }
    
    // Handle WebSocket connection changes
    function handleConnectionChange(connected) {
        websocketConnected = connected;
        console.log('WebSocket health monitoring:', connected ? 'connected' : 'disconnected');
        
        if (!connected) {
            // Fall back to polling if WebSocket disconnects
            setTimeout(fallbackToPolling, 5000);
        }
    }
    
    // Update health display elements
    function updateHealthDisplay(statusElement, detailsElement, healthData) {
        try {
            const status = healthData.status || 'unknown';
            
            // Update status display
            statusElement.innerHTML = status.charAt(0).toUpperCase() + status.slice(1);
            
            // Set status color class
            statusElement.className = 'fw-bold fs-4 mb-1';
            if (status === 'healthy') {
                statusElement.classList.add('text-success');
            } else if (status === 'warning' || status === 'degraded') {
                statusElement.classList.add('text-warning');
            } else if (status === 'critical') {
                statusElement.classList.add('text-danger');
            } else {
                statusElement.classList.add('text-secondary');
            }
            
            // Update details
            if (healthData.database_status && healthData.redis_status) {
                const components = [];
                if (healthData.database_status === 'healthy') components.push('database');
                if (healthData.redis_status === 'healthy') components.push('redis');
                
                const totalComponents = 4; // database, redis, ollama, storage
                detailsElement.textContent = `${components.length}/${totalComponents} components healthy`;
            } else {
                detailsElement.textContent = 'Real-time monitoring active';
            }
            
        } catch (error) {
            console.error('Error updating health display:', error);
        }
    }
    
    // Show health alert notification
    function showHealthAlert(healthData) {
        try {
            // Create alert element
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${healthData.type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show position-fixed`;
            alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            
            alertContainer.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>
                        <strong>${healthData.title || 'System Health Alert'}</strong>
                        <div class="small">${healthData.message || 'System health issue detected'}</div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertContainer);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 10000);
            
        } catch (error) {
            console.error('Error showing health alert:', error);
        }
    }
    
    // Fallback to polling when WebSocket is not available
    function fallbackToPolling() {
        if (websocketConnected) {
            return; // Don't start polling if WebSocket is connected
        }
        
        console.log('Using fallback polling for health updates');
        updateSystemHealthPolling();
        setInterval(updateSystemHealthPolling, 30000);
    }
    
    // Function to update system health status via polling (fallback)
    function updateSystemHealthPolling() {
        const statusElement = document.getElementById('system-health-status');
        const detailsElement = document.getElementById('system-health-details');
        
        if (!statusElement || !detailsElement) {
            return;
        }
        
        // Fetch health status from admin health endpoint
        fetch('/admin/health')
            .then(response => response.json())
            .then(data => {
                console.log('Health check response (polling):', data);
                
                if (data.status) {
                    updateHealthDisplay(statusElement, detailsElement, data);
                } else {
                    // Handle error response
                    statusElement.innerHTML = 'Unknown';
                    statusElement.className = 'fw-bold fs-5 mb-1 text-secondary';
                    detailsElement.textContent = 'Health check failed';
                }
            })
            .catch(error => {
                console.error('Error fetching system health:', error);
                statusElement.innerHTML = 'Error';
                statusElement.className = 'fw-bold fs-5 mb-1 text-danger';
                detailsElement.textContent = 'Unable to check health';
            });
    }
    
    // Request immediate health update
    function requestHealthUpdate() {
        try {
            if (healthNotificationHandler && websocketConnected) {
                // Request via WebSocket
                healthNotificationHandler.requestHealthUpdate();
            } else {
                // Request via API
                fetch('/admin/api/health-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({ force_update: true })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.health_status) {
                        const statusElement = document.getElementById('system-health-status');
                        const detailsElement = document.getElementById('system-health-details');
                        if (statusElement && detailsElement) {
                            updateHealthDisplay(statusElement, detailsElement, data.health_status);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error requesting health update:', error);
                });
            }
        } catch (error) {
            console.error('Error requesting health update:', error);
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize WebSocket health notifications
        initializeHealthNotifications();
        
        // Add click handler for manual health refresh
        const healthCard = document.querySelector('#system-health-status').closest('.card');
        if (healthCard) {
            healthCard.style.cursor = 'pointer';
            healthCard.addEventListener('click', requestHealthUpdate);
            healthCard.title = 'Click to refresh health status';
        }
        
        // Initialize with polling as backup
        setTimeout(() => {
            if (!websocketConnected) {
                fallbackToPolling();
            }
        }, 2000);
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (healthNotificationHandler) {
            healthNotificationHandler.cleanup();
        }
    });
})();
</script>
