<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

<!-- Admin Dashboard Component -->
<!-- Requirements: 1.2, 1.3, 1.4, 1.5 -->

<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 fw-bold text-primary mb-2">Administrator Dashboard</h1>
            <p class="lead text-muted">System overview and management controls</p>
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">System Health</h6>
                    <div class="fw-bold fs-4 mb-1" id="system-health-status">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Loading...
                    </div>
                    <small class="text-muted" id="system-health-details">
                        Checking system components...
                    </small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-right me-1"></i>Details
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">Total Users</h6>
                    <div class="fw-bold fs-4 mb-1">{{ stats.total_users or 0 }}</div>
                    <small class="text-muted">{{ stats.active_users or 0 }} active</small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('admin.user_management') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-gear me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">Platforms</h6>
                    <div class="fw-bold fs-4 mb-1">{{ stats.total_platforms or 0 }}</div>
                    <small class="text-muted">Connected</small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('platform_management') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted text-uppercase small mb-2">Images</h6>
                    <div class="fw-bold fs-4 mb-1">{{ stats.total_images or 0 }}</div>
                    <small class="text-muted">{{ stats.total_posts or 0 }} posts</small>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('batch_review') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-eye me-1"></i>Review
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2 text-primary"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('admin.user_management') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-person-gear fs-1 mb-2"></i>
                                <span class="fw-semibold">User Management</span>
                                <small class="text-muted mt-1">Manage user accounts</small>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-activity fs-1 mb-2"></i>
                                <span class="fw-semibold">System Health</span>
                                <small class="text-muted mt-1">Monitor system status</small>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('admin.security_audit_dashboard') }}" class="btn btn-outline-danger w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-shield-check fs-1 mb-2"></i>
                                <span class="fw-semibold">Security Audit</span>
                                <small class="text-muted mt-1">Security monitoring</small>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('platform_management') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none">
                                <i class="bi bi-gear-wide-connected fs-1 mb-2"></i>
                                <span class="fw-semibold">Platform Config</span>
                                <small class="text-muted mt-1">Configure platforms</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Admin Dashboard Component JavaScript
(function() {
    'use strict';
    
    // Function to update system health status
    function updateSystemHealth() {
        const statusElement = document.getElementById('system-health-status');
        const detailsElement = document.getElementById('system-health-details');
        
        if (!statusElement || !detailsElement) {
            return; // Elements not found, skip update
        }
        
        // Fetch health status from the same endpoint as admin health dashboard
        fetch('/admin/health')
            .then(response => response.json())
            .then(data => {
                console.log('Health check response:', data); // Debug logging
                
                if (data.status) {
                    const status = data.status;
                    const components = data.components || {};
                    
                    console.log('Components received:', Object.keys(components)); // Debug logging
                    
                    // Update status display
                    statusElement.innerHTML = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    // Set status color class using Bootstrap classes
                    statusElement.className = 'fw-bold fs-4 mb-1';
                    if (status === 'healthy') {
                        statusElement.classList.add('text-success');
                    } else if (status === 'degraded') {
                        statusElement.classList.add('text-warning');
                    } else {
                        statusElement.classList.add('text-danger');
                    }
                    
                    // Update details with component status
                    const componentNames = Object.keys(components);
                    const expectedComponents = ['database', 'ollama', 'storage', 'sessions'];
                    
                    if (componentNames.length > 0) {
                        const healthyComponents = componentNames.filter(name => {
                            const componentStatus = components[name];
                            return componentStatus === 'healthy' || 
                                   (typeof componentStatus === 'string' && !componentStatus.includes('unhealthy'));
                        });
                        
                        // Use expected component count for better display
                        const totalComponents = Math.max(componentNames.length, expectedComponents.length);
                        
                        if (healthyComponents.length === totalComponents && totalComponents === expectedComponents.length) {
                            detailsElement.textContent = `All ${totalComponents} components healthy`;
                        } else {
                            detailsElement.textContent = `${healthyComponents.length}/${totalComponents} components healthy`;
                        }
                    } else {
                        detailsElement.textContent = 'System operational';
                    }
                } else {
                    // Handle error response
                    statusElement.innerHTML = 'Unknown';
                    statusElement.className = 'fw-bold fs-5 mb-1 text-secondary';
                    detailsElement.textContent = 'Health check failed';
                }
            })
            .catch(error => {
                console.error('Error fetching system health:', error);
                statusElement.innerHTML = 'Error';
                statusElement.className = 'fw-bold fs-5 mb-1 text-danger';
                detailsElement.textContent = 'Unable to check health';
            });
    }
    
    // Update system health on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateSystemHealth();
        
        // Set up periodic updates every 30 seconds
        setInterval(updateSystemHealth, 30000);
    });
})();
</script>
