<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base_admin.html" %}

{% block title %}Security Audit Logs{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Security Audit Logs</h1>
            
            <!-- Audit Statistics -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-info">{{ audit_stats.total_events }}</h5>
                            <p class="card-text">Total Events</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-danger">{{ audit_stats.critical_events }}</h5>
                            <p class="card-text">Critical</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-warning">{{ audit_stats.high_events }}</h5>
                            <p class="card-text">High</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-primary">{{ audit_stats.medium_events }}</h5>
                            <p class="card-text">Medium</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-secondary">{{ audit_stats.low_events }}</h5>
                            <p class="card-text">Low</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-success">{{ audit_stats.unique_ips }}</h5>
                            <p class="card-text">Unique IPs</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('admin.security_audit_logs') }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="hours" class="form-label">Time Period</label>
                                <select name="hours" id="hours" class="form-select">
                                    {% for period in available_filters.time_periods %}
                                    <option value="{{ period.value }}" {% if current_filters.hours == period.value %}selected{% endif %}>
                                        {{ period.label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="severity" class="form-label">Severity</label>
                                <select name="severity" id="severity" class="form-select">
                                    {% for severity in available_filters.severities %}
                                    <option value="{{ severity }}" {% if current_filters.severity == severity %}selected{% endif %}>
                                        {{ severity.title() }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="event_type" class="form-label">Event Type</label>
                                <select name="event_type" id="event_type" class="form-select">
                                    {% for event_type in available_filters.event_types %}
                                    <option value="{{ event_type }}" {% if current_filters.event_type == event_type %}selected{% endif %}>
                                        {{ event_type.replace('_', ' ').title() }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="per_page" class="form-label">Per Page</label>
                                <select name="per_page" id="per_page" class="form-select">
                                    <option value="25" {% if current_filters.per_page == 25 %}selected{% endif %}>25</option>
                                    <option value="50" {% if current_filters.per_page == 50 %}selected{% endif %}>50</option>
                                    <option value="100" {% if current_filters.per_page == 100 %}selected{% endif %}>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                                <a href="{{ url_for('admin.security_audit_logs') }}" class="btn btn-secondary">Reset</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Audit Logs Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Security Events</h5>
                    <div>
                        <small class="text-muted">
                            Showing {{ audit_logs.events|length }} of {{ audit_logs.total_events }} events
                        </small>
                    </div>
                </div>
                <div class="card-body">
                    {% if audit_logs.events %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>Severity</th>
                                    <th>Source IP</th>
                                    <th>User</th>
                                    <th>Endpoint</th>
                                    <th>Message</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in audit_logs.events %}
                                <tr>
                                    <td>
                                        <small>{{ event.timestamp }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ event.event_type }}</span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if event.severity == 'critical' %}bg-danger
                                            {% elif event.severity == 'high' %}bg-warning
                                            {% elif event.severity == 'medium' %}bg-primary
                                            {% elif event.severity == 'low' %}bg-secondary
                                            {% else %}bg-light{% endif %}">
                                            {{ event.severity|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <code>{{ event.source_ip }}</code>
                                    </td>
                                    <td>
                                        {% if event.user_id %}
                                            <span class="badge bg-success">{{ event.user_id }}</span>
                                        {% else %}
                                            <span class="text-muted">Anonymous</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <code>{{ event.endpoint }}</code>
                                    </td>
                                    <td>
                                        <small>{{ event.message }}</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="showEventDetails('{{ event.id }}')">
                                            Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if audit_logs.total_pages > 1 %}
                    <nav aria-label="Audit logs pagination">
                        <ul class="pagination justify-content-center">
                            {% if audit_logs.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.security_audit_logs', 
                                    page=current_filters.page-1, 
                                    hours=current_filters.hours,
                                    severity=current_filters.severity,
                                    event_type=current_filters.event_type,
                                    per_page=current_filters.per_page) }}">Previous</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in range(1, audit_logs.total_pages + 1) %}
                                {% if page_num == current_filters.page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% elif page_num <= 3 or page_num > audit_logs.total_pages - 3 or (page_num >= current_filters.page - 1 and page_num <= current_filters.page + 1) %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.security_audit_logs', 
                                        page=page_num, 
                                        hours=current_filters.hours,
                                        severity=current_filters.severity,
                                        event_type=current_filters.event_type,
                                        per_page=current_filters.per_page) }}">{{ page_num }}</a>
                                </li>
                                {% elif page_num == 4 or page_num == audit_logs.total_pages - 3 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if audit_logs.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.security_audit_logs', 
                                    page=current_filters.page+1, 
                                    hours=current_filters.hours,
                                    severity=current_filters.severity,
                                    event_type=current_filters.event_type,
                                    per_page=current_filters.per_page) }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <h5>No security events found</h5>
                        <p>No security events match the current filters for the selected time period.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ g.csp_nonce if g.csp_nonce else '' }}">
function showEventDetails(eventId) {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    modal.show();
    
    // Load event details (placeholder implementation)
    const content = document.getElementById('eventDetailsContent');
    content.innerHTML = `
        <div class="alert alert-info">
            <h6>Event ID: ${eventId}</h6>
            <p>Detailed event information would be loaded here from the security audit system.</p>
            <p><strong>Note:</strong> This is a placeholder implementation. In a full implementation, 
            this would fetch detailed event data from the security audit API.</p>
        </div>
    `;
}

// Auto-refresh every 60 seconds
setInterval(function() {
    location.reload();
}, 60000);
</script>
{% endblock %}