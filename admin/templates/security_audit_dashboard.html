{% extends "admin/base_admin.html" %}

{% block title %}Security Audit Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Security Audit Dashboard</h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary btn-sm" onclick="generateAuditReport()">
                        <i class="fas fa-file-alt"></i> Generate Report
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-danger">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Open Vulnerabilities
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="open-vulnerabilities">
                                {{ vulnerability_data.open_vulnerabilities }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Resolved Vulnerabilities
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="resolved-vulnerabilities">
                                {{ vulnerability_data.resolved_vulnerabilities }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Overdue Items
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="overdue-vulnerabilities">
                                {{ vulnerability_data.overdue_vulnerabilities }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Overall Compliance
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="overall-compliance">
                                {{ "%.1f"|format(compliance_data.overall_compliance * 100) }}%
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shield-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Vulnerability Status Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="vulnerabilityStatusChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Vulnerability Severity Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="vulnerabilitySeverityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Trend -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Compliance Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="complianceTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Vulnerabilities and Overdue Items -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Vulnerabilities</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="recent-vulnerabilities-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Component</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-vulnerabilities-tbody">
                                {% for vuln in vulnerability_data.recent_vulnerabilities %}
                                <tr>
                                    <td>{{ vuln.type }}</td>
                                    <td><span class="badge badge-{{ 'danger' if vuln.severity == 'CRITICAL' else 'warning' if vuln.severity == 'HIGH' else 'info' }}">{{ vuln.severity }}</span></td>
                                    <td><code>{{ vuln.component }}</code></td>
                                    <td><span class="badge badge-{{ 'success' if vuln.status == 'resolved' else 'warning' if vuln.status == 'in_progress' else 'danger' }}">{{ vuln.status.replace('_', ' ').title() }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="updateVulnerability('{{ vuln.vulnerability_id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Overdue Items</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="overdue-items-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Component</th>
                                    <th>Days Overdue</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="overdue-items-tbody">
                                {% for item in vulnerability_data.overdue_items %}
                                <tr>
                                    <td>{{ item.type }}</td>
                                    <td><span class="badge badge-{{ 'danger' if item.severity == 'CRITICAL' else 'warning' if item.severity == 'HIGH' else 'info' }}">{{ item.severity }}</span></td>
                                    <td><code>{{ item.component }}</code></td>
                                    <td><span class="badge badge-danger">{{ item.days_overdue }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="updateVulnerability('{{ item.vulnerability_id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Security Recommendations</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush" id="recommendations-list">
                        {% for recommendation in compliance_data.recommendations %}
                        <li class="list-group-item">
                            <i class="fas fa-lightbulb text-warning mr-2"></i>
                            {{ recommendation }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Vulnerability Modal -->
<div class="modal fade" id="updateVulnerabilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Vulnerability</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateVulnerabilityForm">
                    <input type="hidden" id="vulnerabilityId" name="vulnerability_id">
                    
                    <div class="form-group">
                        <label for="vulnerabilityStatus">Status</label>
                        <select class="form-control" id="vulnerabilityStatus" name="status" required>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="accepted_risk">Accepted Risk</option>
                            <option value="false_positive">False Positive</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignedTo">Assigned To</label>
                        <input type="text" class="form-control" id="assignedTo" name="assigned_to">
                    </div>
                    
                    <div class="form-group">
                        <label for="resolutionNotes">Resolution Notes</label>
                        <textarea class="form-control" id="resolutionNotes" name="resolution_notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveVulnerabilityUpdate()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let vulnerabilityStatusChart, vulnerabilitySeverityChart, complianceTrendChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setInterval(refreshDashboard, 60000); // Refresh every minute
});

function initializeCharts() {
    // Vulnerability Status Chart
    const statusCtx = document.getElementById('vulnerabilityStatusChart').getContext('2d');
    vulnerabilityStatusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Open', 'In Progress', 'Resolved', 'Accepted Risk'],
            datasets: [{
                data: [
                    {{ vulnerability_data.status_distribution.open }},
                    {{ vulnerability_data.status_distribution.in_progress }},
                    {{ vulnerability_data.status_distribution.resolved }},
                    {{ vulnerability_data.status_distribution.accepted_risk }}
                ],
                backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Vulnerability Severity Chart
    const severityCtx = document.getElementById('vulnerabilitySeverityChart').getContext('2d');
    vulnerabilitySeverityChart = new Chart(severityCtx, {
        type: 'bar',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                label: 'Vulnerabilities',
                data: [
                    {{ vulnerability_data.severity_distribution.CRITICAL }},
                    {{ vulnerability_data.severity_distribution.HIGH }},
                    {{ vulnerability_data.severity_distribution.MEDIUM }},
                    {{ vulnerability_data.severity_distribution.LOW }}
                ],
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Compliance Trend Chart
    const trendCtx = document.getElementById('complianceTrendChart').getContext('2d');
    complianceTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [{% for trend in compliance_data.compliance_trend %}'{{ trend.date[:10] }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Compliance Score',
                data: [{% for trend in compliance_data.compliance_trend %}{{ trend.score }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1
                }
            }
        }
    });
}

function refreshDashboard() {
    location.reload();
}

function generateAuditReport() {
    fetch('/admin/security/audit/api/generate-report')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Audit report generated successfully!\nReport ID: ${data.report_id}\nOverall Score: ${(data.overall_score * 100).toFixed(1)}%\nRisk Level: ${data.risk_level}`);
                refreshDashboard();
            } else {
                alert('Failed to generate audit report: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error generating audit report:', error);
            alert('Error generating audit report');
        });
}

function updateVulnerability(vulnerabilityId) {
    document.getElementById('vulnerabilityId').value = vulnerabilityId;
    $('#updateVulnerabilityModal').modal('show');
}

function saveVulnerabilityUpdate() {
    const form = document.getElementById('updateVulnerabilityForm');
    const formData = new FormData(form);
    const vulnerabilityId = formData.get('vulnerability_id');
    
    const data = {
        status: formData.get('status'),
        assigned_to: formData.get('assigned_to'),
        resolution_notes: formData.get('resolution_notes')
    };
    
    fetch(`/admin/security/audit/api/vulnerability/${vulnerabilityId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#updateVulnerabilityModal').modal('hide');
            refreshDashboard();
        } else {
            alert('Failed to update vulnerability: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error updating vulnerability:', error);
        alert('Error updating vulnerability');
    });
}
</script>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    border: 1px solid #e3e6f0;
}

.text-xs {
    font-size: 0.7rem;
}

canvas {
    height: 300px !important;
}
</style>
{% endblock %}