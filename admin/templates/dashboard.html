<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base_admin.html" %}

{% block title %}Admin Dashboard - Vedfolnir{% endblock %}

{% block extra_head %}
<!-- Dashboard-specific styles moved to admin.css -->
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        Admin Dashboard - Multi-Tenant Caption Management Dashboard
        <span class="real-time-indicator" id="connectionStatus" title="Real-time updates active"></span>
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleAutoRefresh()">
                <i class="bi bi-play-circle" id="autoRefreshIcon"></i> <span id="autoRefreshText">Start Auto-refresh</span>
            </button>
        </div>
    </div>
</div>

<!-- System Overview Cards with Responsiveness Metrics -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-white bg-primary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Active Jobs</span>
                <i class="bi bi-play-circle"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="activeJobsCount">{{ system_metrics.active_jobs or 0 }}</h4>
                <p class="card-text">
                    <small>{{ system_metrics.queued_jobs or 0 }} queued</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-white bg-success">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Completed Today</span>
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="completedTodayCount">{{ system_metrics.completed_today or 0 }}</h4>
                <p class="card-text">
                    <small>{{ system_metrics.success_rate or 0 }}% success rate</small>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Responsiveness Monitoring Cards -->
    <div class="col-md-2">
        <div class="card text-white" id="responsivenessCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Responsiveness</span>
                <i class="bi bi-speedometer2"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="responsivenessStatus">Loading...</h4>
                <p class="card-text">
                    <small id="responsivenessDetails">Checking system...</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-white" id="memoryCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Memory Usage</span>
                <i class="bi bi-memory"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="memoryUsage">--</h4>
                <p class="card-text">
                    <small id="memoryDetails">-- MB used</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-white" id="requestPerformanceCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Request Time</span>
                <i class="bi bi-clock"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="avgRequestTime">--</h4>
                <p class="card-text">
                    <small id="requestTimeDetails">-- req/sec</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-white" id="connectionPoolCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Connections</span>
                <i class="bi bi-diagram-3"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="connectionPoolUsage">--</h4>
                <p class="card-text">
                    <small id="connectionPoolDetails">-- active</small>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Active Jobs Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-task"></i> Active Caption Generation Jobs
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshActiveJobs()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="showBulkActions()">
                        <i class="bi bi-gear"></i> Bulk Actions
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="activeJobsTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllJobs" onchange="toggleAllJobSelection()">
                                </th>
                                <th>Job ID</th>
                                <th>User</th>
                                <th>Platform</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Started</th>
                                <th>Est. Completion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activeJobsBody">
                            {% for job in active_jobs %}
                            <tr data-job-id="{{ job.task_id }}">
                                <td>
                                    <input type="checkbox" class="job-checkbox" value="{{ job.task_id }}">
                                </td>
                                <td>
                                    <code class="small">{{ job.task_id[:8] }}...</code>
                                </td>
                                <td>
                                    <strong>{{ job.username }}</strong>
                                    <br><small class="text-muted">{{ job.user_email }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ job.platform_type }}</span>
                                    <br><small>{{ job.platform_name }}</small>
                                </td>
                                <td>
                                    <span class="badge job-status-badge 
                                        {% if job.status == 'running' %}bg-primary
                                        {% elif job.status == 'queued' %}bg-secondary
                                        {% elif job.status == 'completed' %}bg-success
                                        {% elif job.status == 'failed' %}bg-danger
                                        {% else %}bg-warning{% endif %}">
                                        {{ job.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress h-20px">
                                        <div class="progress-bar" role="progressbar" 
                                             class="progress-bar-dynamic" style="--progress-width: {{ job.progress_percentage or 0 }}%"
                                             aria-valuenow="{{ job.progress_percentage or 0 }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            {{ job.progress_percentage or 0 }}%
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ job.current_step or 'Initializing' }}</small>
                                </td>
                                <td>
                                    <small>{{ job.created_at.strftime('%H:%M:%S') if job.created_at else 'N/A' }}</small>
                                </td>
                                <td>
                                    <small>{{ job.estimated_completion or 'Calculating...' }}</small>
                                </td>
                                <td>
                                    <div class="job-controls">
                                        {% if job.status in ['running', 'queued'] %}
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="cancelJob('{{ job.task_id }}', '{{ job.username }}')"
                                                title="Cancel Job">
                                            <i class="bi bi-stop-circle"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" 
                                                onclick="setPriority('{{ job.task_id }}', 'high')"
                                                title="Set High Priority">
                                            <i class="bi bi-arrow-up-circle"></i>
                                        </button>
                                        {% endif %}
                                        {% if job.status == 'failed' %}
                                        <button class="btn btn-outline-success btn-sm" 
                                                onclick="restartJob('{{ job.task_id }}')"
                                                title="Restart Job">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-info btn-sm" 
                                                onclick="viewJobDetails('{{ job.task_id }}')"
                                                title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox"></i> No active jobs at this time
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Responsiveness Monitoring Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-speedometer2"></i> System Responsiveness Monitoring
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshResponsivenessData()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="showResponsivenessDetails()">
                        <i class="bi bi-info-circle"></i> Details
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Memory Leak Detection</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-dynamic" id="memoryLeakProgress" role="progressbar" style="--progress-width: 0%"></div>
                            </div>
                            <small id="memoryLeakStatus" class="text-muted">Monitoring...</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Connection Pool Health</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-dynamic" id="connectionHealthProgress" role="progressbar" style="--progress-width: 0%"></div>
                            </div>
                            <small id="connectionHealthStatus" class="text-muted">Monitoring...</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Background Task Load</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-dynamic" id="backgroundTaskProgress" role="progressbar" style="--progress-width: 0%"></div>
                            </div>
                            <small id="backgroundTaskStatus" class="text-muted">Monitoring...</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Request Performance</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-dynamic" id="requestPerformanceProgress" role="progressbar" style="--progress-width: 0%"></div>
                            </div>
                            <small id="requestPerformanceStatus" class="text-muted">Monitoring...</small>
                        </div>
                    </div>
                </div>
                
                <!-- Responsiveness Alerts -->
                <div class="mt-3" id="responsivenessAlerts" class="hidden">
                    <h6>Responsiveness Alerts</h6>
                    <div id="responsivenessAlertsList"></div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-3">
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-warning" onclick="triggerMemoryCleanup()">
                            <i class="bi bi-trash"></i> Memory Cleanup
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="optimizeConnections()">
                            <i class="bi bi-diagram-3"></i> Optimize Connections
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="runResponsivenessCheck()">
                            <i class="bi bi-check-circle"></i> Run Check
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Alerts and User Management Row -->
<div class="row mb-4">
    <!-- System Alerts -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bell"></i> System Alerts
                </h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshAlerts()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body max-height-300px">
                <div id="alertsList">
                    {% for alert in system_alerts %}
                    <div class="alert-item alert-{{ alert.severity }}" data-alert-id="{{ alert.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ alert.title }}</strong>
                                <p class="mb-1">{{ alert.message }}</p>
                                <small class="text-muted">{{ alert.created_at.strftime('%Y-%m-%d %H:%M:%S') if alert.created_at else 'N/A' }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="acknowledgeAlert('{{ alert.id }}')"
                                    title="Acknowledge">
                                <i class="bi bi-check"></i>
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-check-circle"></i> No active alerts
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick User Management -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> User Management
                </h5>
                <a href="{{ url_for('admin.user_management') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-gear"></i> Full Management
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 text-primary">{{ stats.total_users or 0 }}</div>
                            <small>Total Users</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h4 text-success">{{ stats.active_users or 0 }}</div>
                            <small>Active Users</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showUserLimitsModal()">
                        <i class="bi bi-sliders"></i> Set User Limits
                    </button>
                    <a href="{{ url_for('admin.pause_system') }}" class="btn btn-warning">
                        <i class="fas fa-pause"></i> Pause All
                    </a>
                    <a href="{{ url_for('admin.system_maintenance') }}" class="btn btn-outline-danger">
                        <i class="bi bi-tools"></i> System Maintenance
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Configuration and Quick Actions -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> System Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="systemConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxConcurrentJobs" class="form-label">Max Concurrent Jobs</label>
                                <input type="number" class="form-control" id="maxConcurrentJobs" 
                                       value="{{ system_config.max_concurrent_jobs or 5 }}" min="1" max="20">
                            </div>
                            <div class="mb-3">
                                <label for="jobTimeoutMinutes" class="form-label">Job Timeout (minutes)</label>
                                <input type="number" class="form-control" id="jobTimeoutMinutes" 
                                       value="{{ system_config.job_timeout_minutes or 30 }}" min="5" max="120">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxRetries" class="form-label">Max Retries</label>
                                <input type="number" class="form-control" id="maxRetries" 
                                       value="{{ system_config.max_retries or 3 }}" min="0" max="10">
                            </div>
                            <div class="mb-3">
                                <label for="alertThreshold" class="form-label">Alert Threshold (%)</label>
                                <input type="number" class="form-control" id="alertThreshold" 
                                       value="{{ system_config.alert_threshold or 80 }}" min="50" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="resetSystemConfig()">
                            Reset
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveSystemConfig()">
                            <i class="bi bi-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-heart-pulse"></i> System Health
                    </a>
                    <a href="{{ url_for('admin.monitoring_dashboard') }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-graph-up"></i> Performance Metrics
                    </a>
                    <a href="{{ url_for('admin.security_audit_dashboard') }}" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-shield-exclamation"></i> Security Audit
                    </a>
                    <a href="{{ url_for('admin.cleanup') }}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-trash"></i> Data Cleanup
                    </a>
                    <button type="button" class="btn btn-outline-dark btn-sm" onclick="exportSystemReport()">
                        <i class="bi bi-download"></i> Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'components/job_details_modal.html' %}
{% include 'components/bulk_actions_modal.html' %}
{% include 'components/user_limits_modal.html' %}
{% include 'components/system_maintenance_modal.html' %}

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('admin.static', filename='js/admin_dashboard.js') }}"></script>
<script src="{{ url_for('admin.static', filename='js/user_limits_modal.js') }}"></script>
<script nonce="{{ g.csp_nonce if g.csp_nonce else '' }}">
    // Responsiveness monitoring functions
    function refreshResponsivenessData() {
        console.log('Refreshing responsiveness data...');
        
        // Fetch responsiveness metrics from SystemOptimizer
        fetch('/admin/api/responsiveness/metrics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateResponsivenessWidgets(data.data);
                } else {
                    console.error('Failed to fetch responsiveness data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching responsiveness data:', error);
                // Show fallback data
                updateResponsivenessWidgets({
                    responsiveness_status: 'unknown',
                    memory_usage_percent: 0,
                    memory_usage_mb: 0,
                    avg_request_time: 0,
                    requests_per_second: 0,
                    connection_pool_utilization: 0,
                    active_connections: 0,
                    background_tasks_count: 0,
                    slow_request_count: 0
                });
            });
    }
    
    function updateResponsivenessWidgets(data) {
        // Update main responsiveness status card
        const responsivenessCard = document.getElementById('responsivenessCard');
        const responsivenessStatus = document.getElementById('responsivenessStatus');
        const responsivenessDetails = document.getElementById('responsivenessDetails');
        
        if (responsivenessCard && responsivenessStatus && responsivenessDetails) {
            const status = data.responsiveness_status || 'unknown';
            responsivenessStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            // Update card color based on status
            responsivenessCard.className = 'card text-white';
            if (status === 'healthy') {
                responsivenessCard.classList.add('bg-success');
                responsivenessDetails.textContent = 'System responsive';
            } else if (status === 'warning') {
                responsivenessCard.classList.add('bg-warning');
                responsivenessDetails.textContent = 'Performance issues detected';
            } else if (status === 'critical') {
                responsivenessCard.classList.add('bg-danger');
                responsivenessDetails.textContent = 'Critical performance issues';
            } else {
                responsivenessCard.classList.add('bg-secondary');
                responsivenessDetails.textContent = 'Status unknown';
            }
        }
        
        // Update memory usage card
        const memoryCard = document.getElementById('memoryCard');
        const memoryUsage = document.getElementById('memoryUsage');
        const memoryDetails = document.getElementById('memoryDetails');
        
        if (memoryCard && memoryUsage && memoryDetails) {
            const memoryPercent = data.memory_usage_percent || 0;
            const memoryMB = data.memory_usage_mb || 0;
            
            memoryUsage.textContent = `${memoryPercent.toFixed(1)}%`;
            memoryDetails.textContent = `${(memoryMB / 1024).toFixed(1)} GB used`;
            
            // Update card color based on memory usage
            memoryCard.className = 'card text-white';
            if (memoryPercent < 60) {
                memoryCard.classList.add('bg-success');
            } else if (memoryPercent < 80) {
                memoryCard.classList.add('bg-warning');
            } else {
                memoryCard.classList.add('bg-danger');
            }
        }
        
        // Update request performance card
        const requestCard = document.getElementById('requestPerformanceCard');
        const avgRequestTime = document.getElementById('avgRequestTime');
        const requestTimeDetails = document.getElementById('requestTimeDetails');
        
        if (requestCard && avgRequestTime && requestTimeDetails) {
            const avgTime = data.avg_request_time || 0;
            const reqPerSec = data.requests_per_second || 0;
            
            avgRequestTime.textContent = `${(avgTime * 1000).toFixed(0)}ms`;
            requestTimeDetails.textContent = `${reqPerSec.toFixed(1)} req/sec`;
            
            // Update card color based on request time
            requestCard.className = 'card text-white';
            if (avgTime < 1.0) {
                requestCard.classList.add('bg-success');
            } else if (avgTime < 3.0) {
                requestCard.classList.add('bg-warning');
            } else {
                requestCard.classList.add('bg-danger');
            }
        }
        
        // Update connection pool card
        const connectionCard = document.getElementById('connectionPoolCard');
        const connectionUsage = document.getElementById('connectionPoolUsage');
        const connectionDetails = document.getElementById('connectionPoolDetails');
        
        if (connectionCard && connectionUsage && connectionDetails) {
            const poolUtilization = data.connection_pool_utilization || 0;
            const activeConnections = data.active_connections || 0;
            
            connectionUsage.textContent = `${(poolUtilization * 100).toFixed(1)}%`;
            connectionDetails.textContent = `${activeConnections} active`;
            
            // Update card color based on pool utilization
            connectionCard.className = 'card text-white';
            if (poolUtilization < 0.7) {
                connectionCard.classList.add('bg-success');
            } else if (poolUtilization < 0.9) {
                connectionCard.classList.add('bg-warning');
            } else {
                connectionCard.classList.add('bg-danger');
            }
        }
        
        // Update detailed responsiveness metrics
        updateDetailedResponsivenessMetrics(data);
    }
    
    function updateDetailedResponsivenessMetrics(data) {
        // Memory leak detection progress
        const memoryLeakProgress = document.getElementById('memoryLeakProgress');
        const memoryLeakStatus = document.getElementById('memoryLeakStatus');
        
        if (memoryLeakProgress && memoryLeakStatus) {
            const memoryPercent = data.memory_usage_percent || 0;
            memoryLeakProgress.style.width = `${memoryPercent}%`;
            
            if (memoryPercent < 60) {
                memoryLeakProgress.className = 'progress-bar bg-success';
                memoryLeakStatus.textContent = 'Memory usage normal';
                memoryLeakStatus.className = 'text-success';
            } else if (memoryPercent < 80) {
                memoryLeakProgress.className = 'progress-bar bg-warning';
                memoryLeakStatus.textContent = 'Memory usage elevated';
                memoryLeakStatus.className = 'text-warning';
            } else {
                memoryLeakProgress.className = 'progress-bar bg-danger';
                memoryLeakStatus.textContent = 'Memory usage critical';
                memoryLeakStatus.className = 'text-danger';
            }
        }
        
        // Connection health progress
        const connectionHealthProgress = document.getElementById('connectionHealthProgress');
        const connectionHealthStatus = document.getElementById('connectionHealthStatus');
        
        if (connectionHealthProgress && connectionHealthStatus) {
            const poolUtilization = (data.connection_pool_utilization || 0) * 100;
            connectionHealthProgress.style.width = `${poolUtilization}%`;
            
            if (poolUtilization < 70) {
                connectionHealthProgress.className = 'progress-bar bg-success';
                connectionHealthStatus.textContent = 'Connection pool healthy';
                connectionHealthStatus.className = 'text-success';
            } else if (poolUtilization < 90) {
                connectionHealthProgress.className = 'progress-bar bg-warning';
                connectionHealthStatus.textContent = 'Connection pool stressed';
                connectionHealthStatus.className = 'text-warning';
            } else {
                connectionHealthProgress.className = 'progress-bar bg-danger';
                connectionHealthStatus.textContent = 'Connection pool critical';
                connectionHealthStatus.className = 'text-danger';
            }
        }
        
        // Background task load progress
        const backgroundTaskProgress = document.getElementById('backgroundTaskProgress');
        const backgroundTaskStatus = document.getElementById('backgroundTaskStatus');
        
        if (backgroundTaskProgress && backgroundTaskStatus) {
            const taskCount = data.background_tasks_count || 0;
            const taskPercent = Math.min(100, (taskCount / 20) * 100); // Max 20 tasks = 100%
            backgroundTaskProgress.style.width = `${taskPercent}%`;
            
            if (taskCount < 10) {
                backgroundTaskProgress.className = 'progress-bar bg-success';
                backgroundTaskStatus.textContent = `${taskCount} background tasks`;
                backgroundTaskStatus.className = 'text-success';
            } else if (taskCount < 15) {
                backgroundTaskProgress.className = 'progress-bar bg-warning';
                backgroundTaskStatus.textContent = `${taskCount} background tasks (high)`;
                backgroundTaskStatus.className = 'text-warning';
            } else {
                backgroundTaskProgress.className = 'progress-bar bg-danger';
                backgroundTaskStatus.textContent = `${taskCount} background tasks (critical)`;
                backgroundTaskStatus.className = 'text-danger';
            }
        }
        
        // Request performance progress
        const requestPerformanceProgress = document.getElementById('requestPerformanceProgress');
        const requestPerformanceStatus = document.getElementById('requestPerformanceStatus');
        
        if (requestPerformanceProgress && requestPerformanceStatus) {
            const avgTime = data.avg_request_time || 0;
            const slowRequests = data.slow_request_count || 0;
            const performancePercent = Math.min(100, (avgTime / 5.0) * 100); // 5 seconds = 100%
            requestPerformanceProgress.style.width = `${performancePercent}%`;
            
            if (avgTime < 1.0 && slowRequests === 0) {
                requestPerformanceProgress.className = 'progress-bar bg-success';
                requestPerformanceStatus.textContent = 'Request performance excellent';
                requestPerformanceStatus.className = 'text-success';
            } else if (avgTime < 3.0 && slowRequests < 5) {
                requestPerformanceProgress.className = 'progress-bar bg-warning';
                requestPerformanceStatus.textContent = `${slowRequests} slow requests detected`;
                requestPerformanceStatus.className = 'text-warning';
            } else {
                requestPerformanceProgress.className = 'progress-bar bg-danger';
                requestPerformanceStatus.textContent = `${slowRequests} slow requests (critical)`;
                requestPerformanceStatus.className = 'text-danger';
            }
        }
        
        // Update responsiveness alerts
        updateResponsivenessAlerts(data);
    }
    
    function updateResponsivenessAlerts(data) {
        const alertsContainer = document.getElementById('responsivenessAlerts');
        const alertsList = document.getElementById('responsivenessAlertsList');
        
        if (!alertsContainer || !alertsList) return;
        
        const alerts = [];
        
        // Check for memory alerts
        const memoryPercent = data.memory_usage_percent || 0;
        if (memoryPercent >= 80) {
            alerts.push({
                type: 'danger',
                message: `Critical memory usage: ${memoryPercent.toFixed(1)}% - Immediate cleanup recommended`
            });
        } else if (memoryPercent >= 60) {
            alerts.push({
                type: 'warning',
                message: `Elevated memory usage: ${memoryPercent.toFixed(1)}% - Monitor closely`
            });
        }
        
        // Check for connection pool alerts
        const poolUtilization = (data.connection_pool_utilization || 0) * 100;
        if (poolUtilization >= 90) {
            alerts.push({
                type: 'danger',
                message: `Critical connection pool usage: ${poolUtilization.toFixed(1)}% - Connection leaks possible`
            });
        } else if (poolUtilization >= 70) {
            alerts.push({
                type: 'warning',
                message: `High connection pool usage: ${poolUtilization.toFixed(1)}% - Monitor for leaks`
            });
        }
        
        // Check for request performance alerts
        const avgTime = data.avg_request_time || 0;
        const slowRequests = data.slow_request_count || 0;
        if (avgTime >= 3.0 || slowRequests >= 5) {
            alerts.push({
                type: 'danger',
                message: `Poor request performance: ${(avgTime * 1000).toFixed(0)}ms average, ${slowRequests} slow requests`
            });
        } else if (avgTime >= 1.0 || slowRequests > 0) {
            alerts.push({
                type: 'warning',
                message: `Degraded request performance: ${(avgTime * 1000).toFixed(0)}ms average, ${slowRequests} slow requests`
            });
        }
        
        // Check for background task alerts
        const taskCount = data.background_tasks_count || 0;
        if (taskCount >= 15) {
            alerts.push({
                type: 'danger',
                message: `High background task load: ${taskCount} tasks - May impact responsiveness`
            });
        } else if (taskCount >= 10) {
            alerts.push({
                type: 'warning',
                message: `Elevated background task load: ${taskCount} tasks`
            });
        }
        
        // Display alerts
        if (alerts.length > 0) {
            alertsContainer.style.display = 'block';
            alertsList.innerHTML = alerts.map(alert => 
                `<div class="responsiveness-alert alert-${alert.type}">${alert.message}</div>`
            ).join('');
        } else {
            alertsContainer.style.display = 'none';
        }
    }
    
    function showResponsivenessDetails() {
        // This would open a modal or navigate to detailed responsiveness page
        window.open('/admin/performance', '_blank');
    }
    
    function triggerMemoryCleanup() {
        if (confirm('Trigger memory cleanup? This may cause a brief performance impact.')) {
            fetch('/admin/api/responsiveness/cleanup/memory', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAdminNotification('Memory cleanup triggered successfully', 'success');
                        setTimeout(refreshResponsivenessData, 2000);
                    } else {
                        showAdminNotification('Memory cleanup failed: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showAdminNotification('Memory cleanup request failed', 'error');
                });
        }
    }
    
    function optimizeConnections() {
        if (confirm('Optimize database connections? This may cause brief connection interruptions.')) {
            fetch('/admin/api/responsiveness/optimize/connections', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAdminNotification('Connection optimization completed', 'success');
                        setTimeout(refreshResponsivenessData, 2000);
                    } else {
                        showAdminNotification('Connection optimization failed: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showAdminNotification('Connection optimization request failed', 'error');
                });
        }
    }
    
    function runResponsivenessCheck() {
        showAdminNotification('Running comprehensive responsiveness check...', 'info');
        
        fetch('/admin/api/responsiveness/check')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.data;
                    if (result.responsive) {
                        showAdminNotification('System responsiveness check passed', 'success');
                    } else {
                        const issues = result.issues.length;
                        showAdminNotification(`Responsiveness issues detected: ${issues} problems found`, 'warning');
                    }
                    refreshResponsivenessData();
                } else {
                    showAdminNotification('Responsiveness check failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showAdminNotification('Responsiveness check request failed', 'error');
            });
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        
        // Initialize responsiveness monitoring
        refreshResponsivenessData();
        
        // WebSocket connection handled by unified system
        console.log('Admin dashboard initialized - WebSocket managed by unified system');
        
        // Set up periodic refresh fallback
        setInterval(function() {
            if (!isWebSocketConnected()) {
                refreshDashboard();
                refreshResponsivenessData();
            }
        }, 30000); // 30 seconds
        
        // Set up more frequent responsiveness monitoring
        setInterval(refreshResponsivenessData, 15000); // 15 seconds
    });
</script>
{% endblock %}