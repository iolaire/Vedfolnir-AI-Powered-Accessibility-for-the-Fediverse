<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base_admin.html" %}

{% block title %}System Configuration Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('admin.static', filename='css/configuration_management.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-gear"></i> System Configuration Management
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-success" onclick="initializeDefaultConfigurations()">
                <i class="bi bi-gear-fill"></i> Initialize Defaults
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="exportConfigurations()">
                <i class="bi bi-download"></i> Export
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showImportModal()">
                <i class="bi bi-upload"></i> Import
            </button>
            <button type="button" class="btn btn-outline-info" onclick="showDocumentation()">
                <i class="bi bi-book"></i> Documentation
            </button>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <h4>Configuration Management</h4>
                <p>This page allows you to manage system configurations. Use the buttons above to export, import, or view documentation.</p>
            </div>
        </div>
    </div>

    <!-- Configuration Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Configuration Categories</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group flex-wrap" role="group" id="categoryFilters">
                        <button type="button" class="btn btn-outline-secondary active" data-category="all">
                            All Categories
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Restart Required Notification -->
    <div class="row mb-3" id="restartNotificationRow" style="display: none;">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div class="flex-grow-1">
                        <strong>System Restart Required</strong>
                        <p class="mb-0">Some configuration changes require a system restart to take effect.</p>
                        <div class="mt-2">
                            <span class="badge bg-warning text-dark me-1" id="restartRequiredCount">0</span>
                            <span>configuration(s) pending restart</span>
                            <button type="button" class="btn btn-sm btn-outline-warning ms-2" onclick="showRestartRequiredConfigs()">
                                <i class="bi bi-list-ul me-1"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Configuration List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">System Configurations</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeSensitive">
                        <label class="form-check-label" for="includeSensitive">
                            Include Sensitive Configurations
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="configurationsTable">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="configurationsTableBody">
                                <!-- Configurations will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Configuration Modal -->
<div class="modal fade" id="editConfigModal" tabindex="-1" aria-labelledby="editConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editConfigModalLabel">Edit Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editConfigForm">
                    <div class="mb-3">
                        <label for="configKey" class="form-label">Configuration Key</label>
                        <input type="text" class="form-control" id="configKey" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="configValue" class="form-label">Value</label>
                        <div id="configValueContainer">
                            <!-- Dynamic input based on data type -->
                        </div>
                        <div class="form-text" id="configDescription"></div>
                    </div>
                    <div class="mb-3">
                        <label for="configReason" class="form-label">Reason for Change</label>
                        <textarea class="form-control" id="configReason" rows="2"
                            placeholder="Optional reason for this configuration change"></textarea>
                    </div>
                    
                    <!-- Impact Assessment Display -->
                    <div id="impactAssessment" class="d-none">
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Configuration Change Impact Assessment
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Impact Level:</strong>
                                        <span id="impactLevel" class="badge ms-1"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Restart Required:</strong>
                                        <span id="impactRestartRequired" class="badge ms-1"></span>
                                    </div>
                                </div>
                                
                                <div class="mt-2" id="affectedComponentsSection">
                                    <strong>Affected Components:</strong>
                                    <div id="affectedComponents" class="mt-1"></div>
                                </div>
                                
                                <div class="mt-2" id="riskFactorsSection" style="display: none;">
                                    <strong>Risk Factors:</strong>
                                    <ul id="riskFactors" class="mt-1 mb-0"></ul>
                                </div>
                                
                                <div class="mt-2" id="mitigationStepsSection" style="display: none;">
                                    <strong>Mitigation Steps:</strong>
                                    <ul id="mitigationSteps" class="mt-1 mb-0"></ul>
                                </div>
                                
                                <div class="mt-2" id="relatedConfigsSection" style="display: none;">
                                    <strong>Related Configurations:</strong>
                                    <div id="relatedConfigs" class="mt-1"></div>
                                </div>
                                
                                <div class="mt-2" id="estimatedDowntimeSection" style="display: none;">
                                    <strong>Estimated Downtime:</strong>
                                    <span id="estimatedDowntime" class="text-warning"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Critical Change Confirmation -->
                    <div id="criticalChangeConfirmation" class="d-none">
                        <div class="alert alert-danger">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmCriticalChange">
                                <label class="form-check-label" for="confirmCriticalChange">
                                    <strong>I understand this is a critical configuration change</strong> and acknowledge the potential risks and impacts listed above.
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="validationErrors" class="alert alert-danger d-none"></div>
                    <div id="validationWarnings" class="alert alert-warning d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-info" onclick="testConfiguration()">
                    <i class="bi bi-play-circle me-1"></i>Test Configuration
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Configuration History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalLabel">Configuration History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Changed By</th>
                                <th>Old Value</th>
                                <th>New Value</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- History will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Configuration Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Configurations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">Configuration File</label>
                    <input type="file" class="form-control" id="importFile" accept=".json">
                    <div class="form-text">Select a JSON file containing exported configurations</div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="validateOnly">
                        <label class="form-check-label" for="validateOnly">
                            Validate Only (don't import)
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="overwriteExisting">
                        <label class="form-check-label" for="overwriteExisting">
                            Overwrite Existing Configurations
                        </label>
                    </div>
                </div>
                <div id="importResults" class="d-none">
                    <h6>Import Results:</h6>
                    <div id="importMessages"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importConfigurations()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Dry-Run Results Modal -->
<div class="modal fade" id="dryRunModal" tabindex="-1" aria-labelledby="dryRunModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dryRunModalLabel">
                    <i class="bi bi-play-circle-fill text-info me-2"></i>
                    Configuration Test Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Overall Recommendation -->
                <div id="dryRunRecommendation" class="alert mb-3">
                    <div class="d-flex align-items-center">
                        <i id="recommendationIcon" class="me-2"></i>
                        <div class="flex-grow-1">
                            <strong id="recommendationTitle"></strong>
                            <p id="recommendationReason" class="mb-0"></p>
                        </div>
                        <span id="confidenceLevel" class="badge"></span>
                    </div>
                </div>
                
                <!-- Tabs for different sections -->
                <ul class="nav nav-tabs" id="dryRunTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="validation-tab" data-bs-toggle="tab" data-bs-target="#validation-pane" type="button" role="tab">
                            <i class="bi bi-check-circle me-1"></i>Validation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="impact-tab" data-bs-toggle="tab" data-bs-target="#impact-pane" type="button" role="tab">
                            <i class="bi bi-exclamation-triangle me-1"></i>Impact
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="conflicts-tab" data-bs-toggle="tab" data-bs-target="#conflicts-pane" type="button" role="tab">
                            <i class="bi bi-shield-exclamation me-1"></i>Conflicts
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rollback-tab" data-bs-toggle="tab" data-bs-target="#rollback-pane" type="button" role="tab">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Rollback
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="checklist-tab" data-bs-toggle="tab" data-bs-target="#checklist-pane" type="button" role="tab">
                            <i class="bi bi-list-check me-1"></i>Checklist
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="dryRunTabContent">
                    <!-- Validation Tab -->
                    <div class="tab-pane fade show active" id="validation-pane" role="tabpanel">
                        <div id="dryRunValidation"></div>
                    </div>
                    
                    <!-- Impact Tab -->
                    <div class="tab-pane fade" id="impact-pane" role="tabpanel">
                        <div id="dryRunImpact"></div>
                    </div>
                    
                    <!-- Conflicts Tab -->
                    <div class="tab-pane fade" id="conflicts-pane" role="tabpanel">
                        <div id="dryRunConflicts"></div>
                    </div>
                    
                    <!-- Rollback Tab -->
                    <div class="tab-pane fade" id="rollback-pane" role="tabpanel">
                        <div id="dryRunRollback"></div>
                    </div>
                    
                    <!-- Checklist Tab -->
                    <div class="tab-pane fade" id="checklist-pane" role="tabpanel">
                        <div id="dryRunChecklist"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="proceedWithChange" onclick="proceedWithConfigurationChange()" style="display: none;">
                    <i class="bi bi-check-circle me-1"></i>Proceed with Change
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Restart Required Configurations Modal -->
<div class="modal fade" id="restartRequiredModal" tabindex="-1" aria-labelledby="restartRequiredModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restartRequiredModalLabel">
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                    Configurations Requiring Restart
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6>System Restart Required</h6>
                    <p class="mb-0">The following configurations have been changed and require a system restart to take effect. 
                    Until the system is restarted, these configurations will continue to use their previous values.</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Configuration Key</th>
                                <th>Current Value</th>
                                <th>Category</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="restartRequiredTableBody">
                            <!-- Restart required configurations will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="acknowledgeRestartRequired()">
                    <i class="bi bi-check-circle me-1"></i>Acknowledge
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Documentation Modal -->
<div class="modal fade" id="documentationModal" tabindex="-1" aria-labelledby="documentationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentationModalLabel">Configuration Documentation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="documentationContent">
                    <!-- Documentation will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('admin.static', filename='js/configuration_management.js') }}"></script>
{% endblock %}