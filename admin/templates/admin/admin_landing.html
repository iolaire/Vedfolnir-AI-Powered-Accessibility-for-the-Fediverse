<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base_admin.html" %}

{% block title %}Admin Dashboard - Vedfolnir{% endblock %}

{% block extra_head %}
<style>
    .dashboard-card {
        transition: transform 0.2s ease-in-out;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
    }
    .health-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .health-healthy { background-color: #28a745; }
    .health-degraded { background-color: #ffc107; }
    .health-unhealthy { background-color: #dc3545; }
    .health-unknown { background-color: #6c757d; }
    .quick-action-btn {
        height: 60px;
        font-size: 0.9rem;
    }
    
    /* Responsiveness Monitoring Styles */
    .responsiveness-metric {
        padding: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 10px;
        color: #495057;
    }
    
    .responsiveness-metric h6 {
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
    }
    
    .progress-bar.bg-success { background-color: #28a745 !important; }
    .progress-bar.bg-warning { background-color: #ffc107 !important; }
    .progress-bar.bg-danger { background-color: #dc3545 !important; }
    
    #responsivenessCard.bg-success { background-color: #28a745 !important; }
    #responsivenessCard.bg-warning { background-color: #ffc107 !important; }
    #responsivenessCard.bg-danger { background-color: #dc3545 !important; }
    
    #memoryCard.bg-success { background-color: #28a745 !important; }
    #memoryCard.bg-warning { background-color: #ffc107 !important; }
    #memoryCard.bg-danger { background-color: #dc3545 !important; }
    
    #requestPerformanceCard.bg-success { background-color: #28a745 !important; }
    #requestPerformanceCard.bg-warning { background-color: #ffc107 !important; }
    #requestPerformanceCard.bg-danger { background-color: #dc3545 !important; }
    
    #connectionPoolCard.bg-success { background-color: #28a745 !important; }
    #connectionPoolCard.bg-warning { background-color: #ffc107 !important; }
    #connectionPoolCard.bg-danger { background-color: #dc3545 !important; }
    
    .responsiveness-alert {
        border-left: 4px solid;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
    }
    
    .responsiveness-alert.alert-warning {
        border-left-color: #ffc107;
        background-color: #fff3cd;
        border-left-color: #ffc107;
    }
    
    .responsiveness-alert.alert-danger {
        border-left-color: #dc3545;
        background-color: #f8d7da;
        border-left-color: #dc3545;
    }
    
    .responsiveness-alert.alert-success {
        border-left-color: #28a745;
        background-color: #d4edda;
        border-left-color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-speedometer2"></i> Admin Dashboard
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-primary">
                <i class="bi bi-activity"></i> System Health Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="card-title mb-2">
                            Welcome back, {{ current_user.username }}!
                        </h4>
                        <p class="card-text text-muted mb-0">
                            System Status: 
                            <span class="health-indicator health-{{ health_status }}"></span>
                            <strong class="text-capitalize">{{ health_status }}</strong>
                        </p>
                        <small class="text-muted">
                            Last login: {{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') if current_user.last_login else 'First time' }}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <i class="bi bi-person-circle icon-lg text-gray"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Overview Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card text-white">
            <div class="card-body text-center">
                <i class="bi bi-people" class="icon-md"></i>
                <h3 class="mt-2">{{ stats.total_users }}</h3>
                <p class="mb-0">Total Users</p>
                <small>{{ stats.active_users }} active</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card text-white">
            <div class="card-body text-center">
                <i class="bi bi-diagram-3" class="icon-md"></i>
                <h3 class="mt-2">{{ stats.total_platforms }}</h3>
                <p class="mb-0">Platform Connections</p>
                <small>Multi-platform support</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card text-white">
            <div class="card-body text-center">
                <i class="bi bi-images" class="icon-md"></i>
                <h3 class="mt-2">{{ stats.total_images }}</h3>
                <p class="mb-0">Images Processed</p>
                <small>Caption generation</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card text-white">
            <div class="card-body text-center">
                <i class="bi bi-hdd-stack" class="icon-md"></i>
                <h3 class="mt-2">{{ storage_data.percentage if storage_data else '0.0%' }}</h3>
                <p class="mb-0">Storage Usage</p>
                <small class="text-{% if storage_data.status_color == 'green' %}success{% elif storage_data.status_color == 'yellow' %}warning{% else %}danger{% endif %}">
                    {{ storage_data.status_text if storage_data else 'Unknown' }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- System Overview Cards with Responsiveness Metrics -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-white" id="memoryCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Memory</span>
                <i class="bi bi-memory"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="memoryUsage">Loading...</h4>
                <p class="card-text">
                    <small id="memoryDetails">Checking usage...</small>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Responsiveness Monitoring Cards -->
    <div class="col-md-2">
        <div class="card text-white" id="responsivenessCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Responsiveness</span>
                <i class="bi bi-speedometer2"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="responsivenessStatus">Loading...</h4>
                <p class="card-text">
                    <small id="responsivenessDetails">Checking system...</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-white" id="requestPerformanceCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Requests</span>
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="requestPerformance">Loading...</h4>
                <p class="card-text">
                    <small id="requestDetails">Analyzing...</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-white" id="connectionPoolCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Connections</span>
                <i class="bi bi-diagram-3"></i>
            </div>
            <div class="card-body">
                <h4 class="card-title system-metric" id="connectionPoolStatus">Loading...</h4>
                <p class="card-text">
                    <small id="connectionDetails">Monitoring...</small>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Responsiveness Monitoring Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-speedometer2"></i> System Responsiveness Monitoring
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshResponsivenessData()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="showResponsivenessDetails()">
                        <i class="bi bi-info-circle"></i> Details
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Memory Leak Detection</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success progress-bar-dynamic" role="progressbar" style="--progress-width: 85%" id="memoryLeakProgress"></div>
                            </div>
                            <small class="text-muted" id="memoryLeakStatus">No leaks detected</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Connection Pool Health</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success progress-bar-dynamic" role="progressbar" style="--progress-width: 75%" id="connectionPoolProgress"></div>
                            </div>
                            <small class="text-muted" id="connectionPoolHealthStatus">Pool healthy</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Background Task Load</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-warning progress-bar-dynamic" role="progressbar" style="--progress-width: 60%" id="backgroundTaskProgress"></div>
                            </div>
                            <small class="text-muted" id="backgroundTaskStatus">Moderate load</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="responsiveness-metric">
                            <h6>Request Performance</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success progress-bar-dynamic" role="progressbar" style="--progress-width: 90%" id="requestPerformanceProgress"></div>
                            </div>
                            <small class="text-muted" id="requestPerformanceStatus">Excellent</small>
                        </div>
                    </div>
                </div>
                
                <!-- Responsiveness Alerts -->
                <div class="mt-3" id="responsivenessAlerts" class="hidden">
                    <h6>Responsiveness Alerts</h6>
                    <div id="responsivenessAlertsList"></div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="triggerMemoryCleanup()">
                        <i class="bi bi-memory"></i> Memory Cleanup
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="optimizeConnections()">
                        <i class="bi bi-diagram-3"></i> Optimize Connections
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="runResponsivenessCheck()">
                        <i class="bi bi-check-circle"></i> Run Check
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Storage Monitoring Section -->
{% if storage_data %}
    {% include 'admin/storage_monitoring_section.html' %}
{% endif %}

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning-charge"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{{ url_for('admin.health_dashboard') }}" class="btn btn-outline-primary w-100 quick-action-btn d-flex flex-column justify-content-center">
                            <i class="bi bi-activity mb-1" class="icon-sm"></i>
                            <span>System Health & Jobs</span>
                            <small class="text-muted">Multi-tenant management</small>
                        </a>
                    </div>
                    
                    <div class="col-md-4">
                        <a href="{{ url_for('admin.user_management') }}" class="btn btn-outline-success w-100 quick-action-btn d-flex flex-column justify-content-center">
                            <i class="bi bi-people mb-1" class="icon-sm"></i>
                            <span>User Management</span>
                            <small class="text-muted">Manage user accounts</small>
                        </a>
                    </div>
                    
                    <div class="col-md-4">
                        <a href="{{ url_for('admin.monitoring_dashboard') }}" class="btn btn-outline-info w-100 quick-action-btn d-flex flex-column justify-content-center">
                            <i class="bi bi-graph-up mb-1" class="icon-sm"></i>
                            <span>Performance Metrics</span>
                            <small class="text-muted">System monitoring</small>
                        </a>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{{ url_for('admin.security_audit_dashboard') }}" class="btn btn-outline-danger w-100 quick-action-btn d-flex flex-column justify-content-center">
                            <i class="bi bi-shield-exclamation mb-1" class="icon-sm"></i>
                            <span>Security Audit</span>
                            <small class="text-muted">Security monitoring</small>
                        </a>
                    </div>
                    
                    <div class="col-md-4">
                        <a href="{{ url_for('admin.cleanup') }}" class="btn btn-outline-warning w-100 quick-action-btn d-flex flex-column justify-content-center">
                            <i class="bi bi-trash mb-1" class="icon-sm"></i>
                            <span>Data Cleanup</span>
                            <small class="text-muted">Maintenance tools</small>
                        </a>
                    </div>
                    
                    <div class="col-md-4">
                        <a href="{{ url_for('admin.configuration_management') }}" class="btn btn-outline-secondary w-100 quick-action-btn d-flex flex-column justify-content-center">
                            <i class="bi bi-gear mb-1" class="icon-sm"></i>
                            <span>Configuration</span>
                            <small class="text-muted">System settings</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity & System Status -->
<div class="row">
    <div class="col-md-6">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>New Users (24h)</span>
                    <span class="badge bg-primary">{{ stats.new_users_24h }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Recent Logins (24h)</span>
                    <span class="badge bg-success">{{ stats.recent_logins }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Active Users</span>
                    <span class="badge bg-info">{{ stats.active_users }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Total Posts</span>
                    <span class="badge bg-secondary">{{ stats.total_posts }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> System Information
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>System Status</span>
                    <span class="badge bg-{{ 'success' if health_status == 'healthy' else 'warning' if health_status == 'degraded' else 'danger' }}">
                        {{ health_status.title() }}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Database Type</span>
                    <span class="badge bg-info">MySQL</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Session Storage</span>
                    <span class="badge bg-info">Redis</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Application Version</span>
                    <span class="badge bg-secondary">v{{ app_version }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh system status every 30 seconds
    setInterval(function() {
        // You could add AJAX calls here to update system status
        console.log('Auto-refresh system status');
    }, 30000);
    
    // Responsiveness monitoring functions
    function refreshResponsivenessData() {
        console.log('Refreshing responsiveness data...');
        
        // Fetch responsiveness metrics from SystemOptimizer
        fetch('/admin/api/responsiveness/metrics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateResponsivenessWidgets(data.data);
                } else {
                    console.error('Failed to fetch responsiveness data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching responsiveness data:', error);
                // Show fallback data
                updateResponsivenessWidgets({
                    responsiveness_status: 'unknown',
                    memory_usage_percent: 0,
                    memory_usage_mb: 0,
                    cpu_usage_percent: 0,
                    connection_pool_utilization: 0,
                    avg_request_time: 0,
                    background_tasks_count: 0
                });
            });
    }
    
    function updateResponsivenessWidgets(data) {
        // Update main responsiveness status card
        const responsivenessCard = document.getElementById('responsivenessCard');
        const responsivenessStatus = document.getElementById('responsivenessStatus');
        const responsivenessDetails = document.getElementById('responsivenessDetails');
        
        if (responsivenessCard && responsivenessStatus && responsivenessDetails) {
            // Update status text
            responsivenessStatus.textContent = data.responsiveness_status || 'Unknown';
            responsivenessDetails.textContent = data.responsive ? 'System responsive' : 'Issues detected';
            
            // Update card color based on status
            responsivenessCard.className = 'card text-white';
            if (data.responsiveness_status === 'healthy') {
                responsivenessCard.classList.add('bg-success');
            } else if (data.responsiveness_status === 'warning') {
                responsivenessCard.classList.add('bg-warning');
            } else if (data.responsiveness_status === 'critical') {
                responsivenessCard.classList.add('bg-danger');
            } else {
                responsivenessCard.classList.add('bg-secondary');
            }
        }
        
        // Update memory card
        const memoryCard = document.getElementById('memoryCard');
        const memoryUsage = document.getElementById('memoryUsage');
        const memoryDetails = document.getElementById('memoryDetails');
        
        if (memoryCard && memoryUsage && memoryDetails) {
            memoryUsage.textContent = (data.memory_usage_percent || 0).toFixed(1) + '%';
            memoryDetails.textContent = (data.memory_usage_mb || 0).toFixed(0) + ' MB used';
            
            memoryCard.className = 'card text-white';
            if (data.memory_usage_percent < 70) {
                memoryCard.classList.add('bg-success');
            } else if (data.memory_usage_percent < 85) {
                memoryCard.classList.add('bg-warning');
            } else {
                memoryCard.classList.add('bg-danger');
            }
        }
        
        // Update request performance card
        const requestCard = document.getElementById('requestPerformanceCard');
        const requestPerformance = document.getElementById('requestPerformance');
        const requestDetails = document.getElementById('requestDetails');
        
        if (requestCard && requestPerformance && requestDetails) {
            requestPerformance.textContent = (data.avg_request_time || 0).toFixed(2) + 's';
            requestDetails.textContent = (data.requests_per_second || 0).toFixed(1) + ' req/s';
            
            requestCard.className = 'card text-white';
            if (data.avg_request_time < 1.0) {
                requestCard.classList.add('bg-success');
            } else if (data.avg_request_time < 2.0) {
                requestCard.classList.add('bg-warning');
            } else {
                requestCard.classList.add('bg-danger');
            }
        }
        
        // Update connection pool card
        const connectionCard = document.getElementById('connectionPoolCard');
        const connectionStatus = document.getElementById('connectionPoolStatus');
        const connectionDetails = document.getElementById('connectionDetails');
        
        if (connectionCard && connectionStatus && connectionDetails) {
            connectionStatus.textContent = ((data.connection_pool_utilization || 0) * 100).toFixed(0) + '%';
            connectionDetails.textContent = (data.active_connections || 0) + '/' + (data.max_connections || 20);
            
            connectionCard.className = 'card text-white';
            if (data.connection_pool_utilization < 0.7) {
                connectionCard.classList.add('bg-success');
            } else if (data.connection_pool_utilization < 0.9) {
                connectionCard.classList.add('bg-warning');
            } else {
                connectionCard.classList.add('bg-danger');
            }
        }
    }
    
    function triggerMemoryCleanup() {
        console.log('Triggering memory cleanup...');
        
        fetch('/admin/api/responsiveness/cleanup/memory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Memory cleanup successful');
                refreshResponsivenessData();
            } else {
                console.error('Memory cleanup failed:', data.error);
            }
        })
        .catch(error => {
            console.error('Error triggering memory cleanup:', error);
        });
    }
    
    function optimizeConnections() {
        console.log('Optimizing connections...');
        
        fetch('/admin/api/responsiveness/optimize/connections', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Connection optimization successful');
                refreshResponsivenessData();
            } else {
                console.error('Connection optimization failed:', data.error);
            }
        })
        .catch(error => {
            console.error('Error optimizing connections:', error);
        });
    }
    
    function runResponsivenessCheck() {
        console.log('Running responsiveness check...');
        
        fetch('/admin/api/responsiveness/check')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Responsiveness check completed');
                    updateResponsivenessWidgets(data.data);
                } else {
                    console.error('Responsiveness check failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error running responsiveness check:', error);
            });
    }
    
    function showResponsivenessDetails() {
        console.log('Showing responsiveness details...');
        // This could open a modal or navigate to a detailed view
        window.location.href = '/admin/performance#responsiveness';
    }
    
    // Initialize responsiveness monitoring on page load
    document.addEventListener('DOMContentLoaded', function() {
        refreshResponsivenessData();
        
        // Auto-refresh responsiveness data every 30 seconds
        setInterval(refreshResponsivenessData, 30000);
    });
</script>
{% endblock %}