<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base_admin.html" %}

{% block title %}User Management - Vedfolnir{% endblock %}

{% block content %}
<div class="container">
    <h1>User Management</h1>
    
    <!-- User Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ user_stats.total_users }}</h4>
                            <p class="card-text">Total Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ user_stats.active_users }}</h4>
                            <p class="card-text">Active Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-person-check fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ user_stats.unverified_users }}</h4>
                            <p class="card-text">Unverified Email</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-envelope-exclamation fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ user_stats.locked_users }}</h4>
                            <p class="card-text">Locked Accounts</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-lock fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Management Interface -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Users</h3>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="filter-btn">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        <button type="button" class="btn btn-primary" id="add-user-btn">
                            <i class="bi bi-person-plus"></i> Add User
                        </button>
                    </div>
                </div>
                
                <!-- Filter Panel -->
                <div class="card-body border-bottom collapse" id="filterPanel">
                    <form id="user-filter-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="filter_role" class="form-label">Role</label>
                            <select class="form-select" id="filter_role" name="role">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="moderator">Moderator</option>
                                <option value="reviewer">Reviewer</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter_status" class="form-label">Status</label>
                            <select class="form-select" id="filter_status" name="status">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="locked">Locked</option>
                                <option value="unverified">Unverified Email</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filter_search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="filter_search" name="search" placeholder="Username, email, or name...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-outline-primary">Apply</button>
                                <button type="button" class="btn btn-outline-secondary" id="clear-filters">Clear</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="text-muted">Showing {{ users|length }} of {{ total_users }} users</span>
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="page-size" style="width: auto;">
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Platforms</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}">
                                    <td>{{ user.id }}</td>
                                    <td>
                                        <div>
                                            <strong>{{ user.username }}</strong>
                                            {% if user.first_name or user.last_name %}
                                            <br><small class="text-muted">{{ user.first_name }} {{ user.last_name }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            {{ user.email }}
                                            {% if not user.email_verified %}
                                            <br><small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Unverified</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% set role_str = user.role if user.role is string else user.role.value %}
                                        <span class="badge bg-{{ 'danger' if role_str == 'admin' else 'warning' if role_str == 'moderator' else 'primary' if role_str == 'reviewer' else 'secondary' }}">
                                            {{ role_str.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column gap-1">
                                            <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                                                {{ 'Active' if user.is_active else 'Inactive' }}
                                            </span>
                                            {% if user.account_locked %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-lock"></i> Locked
                                            </span>
                                            {% endif %}
                                            {% if user.failed_login_attempts > 0 %}
                                            <small class="text-warning">
                                                <i class="bi bi-exclamation-circle"></i> {{ user.failed_login_attempts }} failed attempts
                                            </small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.platform_connections_count is defined %}
                                        <span class="badge bg-info">{{ user.platform_connections_count }} platforms</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ (user.created_at.split('T')[0] if user.created_at is string else user.created_at.strftime('%Y-%m-%d')) if user.created_at else 'Unknown' }}</small>
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                        <small>{{ (user.last_login.split('.')[0].replace('T', ' ') if user.last_login is string else user.last_login.strftime('%Y-%m-%d %H:%M')) if user.last_login else 'Never' }}</small>
                                        {% else %}
                                        <small class="text-muted">Never</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-info"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#userDetailsModal"
                                                    data-user-id="{{ user.id }}"
                                                    title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editUserModal" 
                                                    data-user-id="{{ user.id }}"
                                                    data-username="{{ user.username }}"
                                                    data-email="{{ user.email }}"
                                                    data-role="{{ user.role if user.role is string else user.role.value }}"
                                                    data-is-active="{{ user.is_active }}"
                                                    data-email-verified="{{ user.email_verified }}"
                                                    data-account-locked="{{ user.account_locked }}"
                                                    data-first-name="{{ user.first_name or '' }}"
                                                    data-last-name="{{ user.last_name or '' }}"
                                                    title="Edit User">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            
                                            <!-- Dropdown for more actions -->
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                        data-bs-toggle="dropdown" aria-expanded="false" title="More Actions">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="#" 
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#resetPasswordModal"
                                                           data-user-id="{{ user.id }}"
                                                           data-username="{{ user.username }}">
                                                            <i class="bi bi-key"></i> Reset Password
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#userStatusModal"
                                                           data-user-id="{{ user.id }}"
                                                           data-username="{{ user.username }}"
                                                           data-is-active="{{ user.is_active }}"
                                                           data-account-locked="{{ user.account_locked }}"
                                                           data-email-verified="{{ user.email_verified }}">
                                                            <i class="bi bi-gear"></i> Manage Status
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#roleAssignmentModal"
                                                           data-user-id="{{ user.id }}"
                                                           data-username="{{ user.username }}"
                                                           data-current-role="{{ user.role if user.role is string else user.role.value }}">
                                                            <i class="bi bi-person-badge"></i> Change Role
                                                        </a>
                                                    </li>
                                                    {% if not user.email_verified %}
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="resendVerificationEmail({{ user.id }}, '{{ user.username }}')">
                                                            <i class="bi bi-envelope"></i> Resend Verification
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    {% set role_str = user.role if user.role is string else user.role.value %}
                                                    {% if not (role_str == 'admin' and admin_count <= 1) %}
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#"
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#deleteUserModal"
                                                           data-user-id="{{ user.id }}"
                                                           data-username="{{ user.username }}">
                                                            <i class="bi bi-trash"></i> Delete User
                                                        </a>
                                                    </li>
                                                    {% else %}
                                                    <li>
                                                        <span class="dropdown-item text-muted">
                                                            <i class="bi bi-shield-lock"></i> Cannot delete last admin
                                                        </span>
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.edit_user') }}">
                {{ edit_form.hidden_tag() }}
                {{ edit_form.user_id() }}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_username" class="form-label">Username</label>
                                {{ edit_form.username(class="form-control", id="edit_username") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_email" class="form-label">Email</label>
                                {{ edit_form.email(class="form-control", id="edit_email") }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="edit_first_name" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="edit_last_name" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_password" class="form-label">New Password (leave blank to keep current)</label>
                        {{ edit_form.password(class="form-control", id="edit_password") }}
                    </div>
                    <div class="mb-3">
                        <label for="edit_confirm_password" class="form-label">Confirm New Password</label>
                        {{ edit_form.confirm_password(class="form-control", id="edit_confirm_password") }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_role" class="form-label">Role</label>
                                {{ edit_form.role(class="form-select", id="edit_role") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Account Status</label>
                                <div class="form-check">
                                    {{ edit_form.is_active(class="form-check-input", id="edit_is_active") }}
                                    <label class="form-check-label" for="edit_is_active">Active</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="edit_email_verified" name="email_verified">
                                    <label class="form-check-label" for="edit_email_verified">Email Verified</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="edit_account_locked" name="account_locked">
                                    <label class="form-check-label" for="edit_account_locked">Account Locked</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.delete_user') }}">
                {{ delete_form.hidden_tag() }}
                {{ delete_form.user_id() }}
                <div class="modal-body">
                    <p>Are you sure you want to delete user <strong id="delete_username"></strong>?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="user-details-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading user details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Role Assignment Modal -->
<div class="modal fade" id="roleAssignmentModal" tabindex="-1" aria-labelledby="roleAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleAssignmentModalLabel">Change User Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.update_user_role') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <input type="hidden" id="role_user_id" name="user_id">
                <div class="modal-body">
                    <p>Change role for user <strong id="role_username"></strong>?</p>
                    
                    <div class="mb-3">
                        <label for="new_role" class="form-label">New Role</label>
                        <select class="form-select" id="new_role" name="new_role" required>
                            <option value="">Select a role...</option>
                            <option value="admin">Admin - Full system access</option>
                            <option value="moderator">Moderator - Content moderation</option>
                            <option value="reviewer">Reviewer - Caption review</option>
                            <option value="viewer">Viewer - Basic access</option>
                        </select>
                        <div class="form-text">
                            Current role: <span id="current_role_display" class="fw-bold"></span>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> Changing user roles affects their access permissions immediately.
                    </div>
                    
                    <div class="mb-3">
                        <label for="role_change_reason" class="form-label">Reason for role change (optional)</label>
                        <textarea class="form-control" id="role_change_reason" name="reason" rows="3" placeholder="Explain why this role change is being made..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-person-badge"></i> Change Role
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-user-form">
                {{ add_form.hidden_tag() }}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_username" class="form-label">Username</label>
                                {{ add_form.username(class="form-control", id="add_username") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_email" class="form-label">Email</label>
                                {{ add_form.email(class="form-control", id="add_email") }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="add_first_name" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="add_last_name" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_password" class="form-label">Password</label>
                                {{ add_form.password(class="form-control", id="add_password") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_confirm_password" class="form-label">Confirm Password</label>
                                {{ add_form.confirm_password(class="form-control", id="add_confirm_password") }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="add_role" class="form-label">Role</label>
                                {{ add_form.role(class="form-select", id="add_role") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Account Settings</label>
                                <div class="form-check">
                                    {{ add_form.is_active(class="form-check-input", id="add_is_active") }}
                                    <label class="form-check-label" for="add_is_active">Active</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="add_email_verified" name="email_verified" checked>
                                    <label class="form-check-label" for="add_email_verified">Email Verified</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="add_send_notification" name="send_notification" checked>
                                    <label class="form-check-label" for="add_send_notification">Send Welcome Email</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="add-user-submit-btn">
                        <i class="bi bi-person-plus"></i> Add User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.reset_user_password') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <input type="hidden" id="reset_user_id" name="user_id">
                <div class="modal-body">
                    <p>Reset password for user <strong id="reset_username"></strong>?</p>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        A secure temporary password will be generated and sent to the user's email address.
                        The user will be required to change their password on first login.
                    </div>
                    <div class="mb-3">
                        <label for="reset_password_method" class="form-label">Reset Method</label>
                        <select class="form-select" id="reset_password_method" name="reset_method">
                            <option value="email">Send temporary password via email</option>
                            <option value="generate">Generate and display temporary password</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="reset_invalidate_sessions" name="invalidate_sessions" checked>
                        <label class="form-check-label" for="reset_invalidate_sessions">
                            Invalidate all existing user sessions
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-key"></i> Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Status Management Modal -->
<div class="modal fade" id="userStatusModal" tabindex="-1" aria-labelledby="userStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userStatusModalLabel">Manage User Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.update_user_status') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <input type="hidden" id="status_user_id" name="user_id">
                <div class="modal-body">
                    <h6>User: <strong id="status_username"></strong></h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Account Status</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="status_is_active" name="is_active">
                            <label class="form-check-label" for="status_is_active">
                                Account Active
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="status_email_verified" name="email_verified">
                            <label class="form-check-label" for="status_email_verified">
                                Email Verified
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="status_account_locked" name="account_locked">
                            <label class="form-check-label" for="status_account_locked">
                                Account Locked
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Actions</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="status_reset_failed_attempts" name="reset_failed_attempts">
                            <label class="form-check-label" for="status_reset_failed_attempts">
                                Reset failed login attempts
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="status_send_verification" name="send_verification_email">
                            <label class="form-check-label" for="status_send_verification">
                                Send new email verification
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="status_admin_notes" class="form-label">Admin Notes (optional)</label>
                        <textarea class="form-control" id="status_admin_notes" name="admin_notes" rows="3" placeholder="Reason for status change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-gear"></i> Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Initialize modals
    const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    const userDetailsModal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    const roleAssignmentModal = new bootstrap.Modal(document.getElementById('roleAssignmentModal'));
    
    // Filter functionality
    const filterBtn = document.getElementById('filter-btn');
    const filterPanel = document.getElementById('filterPanel');
    const filterForm = document.getElementById('user-filter-form');
    const clearFiltersBtn = document.getElementById('clear-filters');
    
    if (filterBtn) {
        filterBtn.addEventListener('click', function() {
            const bsCollapse = new bootstrap.Collapse(filterPanel, {
                toggle: true
            });
        });
    }
    
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
    }
    
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            filterForm.reset();
            applyFilters();
        });
    }
    
    // Add user functionality
    const addUserBtn = document.getElementById('add-user-btn');
    const addUserForm = document.getElementById('add-user-form');
    
    if (addUserBtn) {
        addUserBtn.addEventListener('click', function() {
            addUserModal.show();
        });
    }
    
    if (addUserForm) {
        addUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.getElementById('add-user-submit-btn');
            
            // Validate passwords match
            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Handle checkbox - if not checked, FormData won't include it
            const isActiveCheckbox = document.getElementById('add_is_active');
            if (!isActiveCheckbox.checked) {
                formData.set('is_active', 'false');
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
            
            console.log('Submitting form data:', Object.fromEntries(formData));
            
            // Submit form data (CSRF token is already included by WTForms)
            fetch('/admin/users/add', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Response not ok:', response.status, response.statusText);
                    return response.text().then(text => {
                        console.error('Response body:', text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    const container = document.querySelector('.container');
                    container.insertBefore(alertDiv, container.firstChild);
                    
                    // Close modal and refresh page
                    addUserModal.hide();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert(data.error || 'Failed to add user');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the user.');
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-person-plus"></i> Add User';
            });
        });
    }
    
    // User details modal functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-bs-target="#userDetailsModal"]')) {
            const button = e.target.closest('[data-bs-target="#userDetailsModal"]');
            const userId = button.getAttribute('data-user-id');
            loadUserDetails(userId);
        }
        
        if (e.target.closest('[data-bs-target="#roleAssignmentModal"]')) {
            const button = e.target.closest('[data-bs-target="#roleAssignmentModal"]');
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            const currentRole = button.getAttribute('data-current-role');
            
            document.getElementById('role_user_id').value = userId;
            document.getElementById('role_username').textContent = username;
            document.getElementById('current_role_display').textContent = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);
            
            // Set current role as selected (disabled)
            const roleSelect = document.getElementById('new_role');
            Array.from(roleSelect.options).forEach(option => {
                option.disabled = option.value === currentRole;
            });
        }
    });
    
    // Filter functionality
    function applyFilters() {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                params.append(key, value);
            }
        }
        
        // Reload page with filters
        const currentUrl = new URL(window.location);
        currentUrl.search = params.toString();
        window.location.href = currentUrl.toString();
    }
    
    // Load user details
    function loadUserDetails(userId) {
        const contentDiv = document.getElementById('user-details-content');
        
        // Show loading state
        contentDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading user details...</p>
            </div>
        `;
        
        fetch(`/admin/users/${userId}/details`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayUserDetails(data.user);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Failed to load user details: ${data.error || 'Unknown error'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading user details:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    An error occurred while loading user details.
                </div>
            `;
        });
    }
    
    // Display user details
    function displayUserDetails(user) {
        const contentDiv = document.getElementById('user-details-content');
        
        const statusBadges = [];
        if (user.is_active) statusBadges.push('<span class="badge bg-success">Active</span>');
        else statusBadges.push('<span class="badge bg-secondary">Inactive</span>');
        
        if (user.email_verified) statusBadges.push('<span class="badge bg-success">Email Verified</span>');
        else statusBadges.push('<span class="badge bg-warning">Email Unverified</span>');
        
        if (user.account_locked) statusBadges.push('<span class="badge bg-danger">Account Locked</span>');
        
        if (user.data_processing_consent) statusBadges.push('<span class="badge bg-info">GDPR Consent</span>');
        
        const recentActivity = user.recent_activity.map(activity => `
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">${activity.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                    <small class="text-muted">${activity.details || 'No details'}</small>
                </div>
                <small class="text-muted">${new Date(activity.created_at).toLocaleString()}</small>
            </li>
        `).join('');
        
        contentDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                        <tr><td><strong>Username:</strong></td><td>${user.username}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${user.email}</td></tr>
                        <tr><td><strong>Full Name:</strong></td><td>${user.full_name || 'Not provided'}</td></tr>
                        <tr><td><strong>Role:</strong></td><td><span class="badge bg-primary">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span></td></tr>
                        <tr><td><strong>Created:</strong></td><td>${user.created_at ? new Date(user.created_at).toLocaleString() : 'Unknown'}</td></tr>
                        <tr><td><strong>Last Login:</strong></td><td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Account Status</h6>
                    <div class="mb-3">
                        ${statusBadges.join(' ')}
                    </div>
                    
                    <h6>Security Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Failed Login Attempts:</strong></td><td>${user.failed_login_attempts}</td></tr>
                        <tr><td><strong>Last Failed Login:</strong></td><td>${user.last_failed_login ? new Date(user.last_failed_login).toLocaleString() : 'Never'}</td></tr>
                        <tr><td><strong>Platform Connections:</strong></td><td>${user.platform_connections_count}</td></tr>
                    </table>
                </div>
            </div>
            
            <hr>
            
            <h6>Recent Activity</h6>
            ${user.recent_activity.length > 0 ? `
                <ul class="list-group list-group-flush">
                    ${recentActivity}
                </ul>
            ` : '<p class="text-muted">No recent activity</p>'}
        `;
    }
    
    // Resend verification email
    window.resendVerificationEmail = function(userId, username) {
        if (!confirm(`Resend verification email to ${username}?`)) {
            return;
        }
        
        fetch(`/admin/users/${userId}/resend-verification`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
            } else {
                showAlert('danger', data.error || 'Failed to resend verification email');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while resending verification email');
        });
    };
    
    // Show alert function
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Edit user modal
    const editUserModal = document.getElementById('editUserModal');
    if (editUserModal) {
        editUserModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            const email = button.getAttribute('data-email');
            const role = button.getAttribute('data-role');
            const isActive = button.getAttribute('data-is-active') === 'True';
            const emailVerified = button.getAttribute('data-email-verified') === 'True';
            const accountLocked = button.getAttribute('data-account-locked') === 'True';
            const firstName = button.getAttribute('data-first-name') || '';
            const lastName = button.getAttribute('data-last-name') || '';
            
            const userIdInput = editUserModal.querySelector('#user_id');
            const usernameInput = editUserModal.querySelector('#edit_username');
            const emailInput = editUserModal.querySelector('#edit_email');
            const firstNameInput = editUserModal.querySelector('#edit_first_name');
            const lastNameInput = editUserModal.querySelector('#edit_last_name');
            const roleSelect = editUserModal.querySelector('#edit_role');
            const isActiveCheckbox = editUserModal.querySelector('#edit_is_active');
            const emailVerifiedCheckbox = editUserModal.querySelector('#edit_email_verified');
            const accountLockedCheckbox = editUserModal.querySelector('#edit_account_locked');
            
            userIdInput.value = userId;
            usernameInput.value = username;
            emailInput.value = email;
            firstNameInput.value = firstName;
            lastNameInput.value = lastName;
            roleSelect.value = role;
            isActiveCheckbox.checked = isActive;
            emailVerifiedCheckbox.checked = emailVerified;
            accountLockedCheckbox.checked = accountLocked;
        });
    }
    
    
    // Reset password modal
    const resetPasswordModal = document.getElementById('resetPasswordModal');
    if (resetPasswordModal) {
        resetPasswordModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            
            const userIdInput = resetPasswordModal.querySelector('#reset_user_id');
            const usernameSpan = resetPasswordModal.querySelector('#reset_username');
            
            userIdInput.value = userId;
            usernameSpan.textContent = username;
        });
    }
    
    // User status modal
    const userStatusModal = document.getElementById('userStatusModal');
    if (userStatusModal) {
        userStatusModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            const isActive = button.getAttribute('data-is-active') === 'True';
            const accountLocked = button.getAttribute('data-account-locked') === 'True';
            const emailVerified = button.getAttribute('data-email-verified') === 'True';
            
            const userIdInput = userStatusModal.querySelector('#status_user_id');
            const usernameSpan = userStatusModal.querySelector('#status_username');
            const isActiveCheckbox = userStatusModal.querySelector('#status_is_active');
            const accountLockedCheckbox = userStatusModal.querySelector('#status_account_locked');
            const emailVerifiedCheckbox = userStatusModal.querySelector('#status_email_verified');
            
            userIdInput.value = userId;
            usernameSpan.textContent = username;
            isActiveCheckbox.checked = isActive;
            accountLockedCheckbox.checked = accountLocked;
            emailVerifiedCheckbox.checked = emailVerified;
        });
    }
    
    // Delete user modal
    const deleteUserModal = document.getElementById('deleteUserModal');
    if (deleteUserModal) {
        deleteUserModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            
            const userIdInput = deleteUserModal.querySelector('#user_id');
            const usernameSpan = deleteUserModal.querySelector('#delete_username');
            
            userIdInput.value = userId;
            usernameSpan.textContent = username;
        });
    }
});
</script>
{% if open_add_user_modal %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
        addUserModal.show();
    });
</script>
{% endif %}
{% endblock %}