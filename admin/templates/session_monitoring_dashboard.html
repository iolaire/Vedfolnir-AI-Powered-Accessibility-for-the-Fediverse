{% extends "base_admin.html" %}

{% block title %}Session Monitoring Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Session Monitoring Dashboard</h1>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="total-sessions">Loading...</h5>
                            <p class="card-text">Total Sessions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="active-users">Loading...</h5>
                            <p class="card-text">Active Sessions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="expired-sessions-count">Loading...</h5>
                            <p class="card-text">Expired Sessions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="session-manager-type">Loading...</h5>
                            <p class="card-text">Session Storage</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Session Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Session ID</th>
                                    <th>Platform</th>
                                    <th>Last Activity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="session-activity-table">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Loading session data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">Last updated: <span id="last-updated-time">Never</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ g.csp_nonce if g.csp_nonce else '' }}">
// Function to update session monitoring data
function updateSessionMonitoring() {
    fetch('/admin/api/session-monitoring/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const stats = data.data;
                
                // Update session counts
                document.getElementById('total-sessions').textContent = stats.total_sessions;
                document.getElementById('active-users').textContent = stats.active_sessions;
                document.getElementById('expired-sessions-count').textContent = stats.expired_sessions;
                
                // Update session manager type
                const managerType = stats.session_manager_type;
                document.getElementById('session-manager-type').textContent = 
                    managerType.charAt(0).toUpperCase() + managerType.slice(1);
                
                // Update last updated time
                const now = new Date();
                document.getElementById('last-updated-time').textContent = now.toLocaleTimeString();
                
                // Update session activity table
                updateSessionActivityTable(stats);
                
            } else {
                console.error('Error fetching session statistics:', data.message);
                // Show error state
                document.getElementById('total-sessions').textContent = 'Error';
                document.getElementById('active-users').textContent = 'Error';
                document.getElementById('expired-sessions-count').textContent = 'Error';
                document.getElementById('session-manager-type').textContent = 'Error';
            }
        })
        .catch(error => {
            console.error('Error fetching session statistics:', error);
            // Show error state
            document.getElementById('total-sessions').textContent = 'Error';
            document.getElementById('active-users').textContent = 'Error';
            document.getElementById('expired-sessions-count').textContent = 'Error';
            document.getElementById('session-manager-type').textContent = 'Error';
        });
}

function updateSessionActivityTable(stats) {
    const tableBody = document.getElementById('session-activity-table');
    
    if (stats.active_sessions === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No active sessions</td></tr>';
    } else {
        // For now, show a summary row since we don't have detailed session data
        // In a full implementation, you'd fetch detailed session data from another endpoint
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-info">
                    ${stats.active_sessions} active session(s) using ${stats.session_manager_type} storage
                    <br><small class="text-muted">Detailed session listing requires additional API implementation</small>
                </td>
            </tr>
        `;
    }
}

// Update data on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSessionMonitoring();
    
    // Update every 30 seconds
    setInterval(updateSessionMonitoring, 30000);
});
</script>
{% endblock %}