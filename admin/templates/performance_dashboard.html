<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->

{% extends "base_admin.html" %}

{% block title %}Performance Dashboard - Admin{% endblock %}

{% block extra_head %}
<style>
.performance-dashboard {
    padding: 20px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.metric-card.warning {
    border-left-color: #ffc107;
}

.metric-card.critical {
    border-left-color: #dc3545;
}

.metric-value {
    font-size: 2em;
    font-weight: bold;
    color: #333;
}

.metric-label {
    color: #666;
    font-size: 0.9em;
    margin-top: 5px;
}

.metric-trend {
    font-size: 0.8em;
    margin-top: 5px;
}

.trend-up {
    color: #28a745;
}

.trend-down {
    color: #dc3545;
}

.trend-stable {
    color: #6c757d;
}

.health-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-healthy {
    background-color: #28a745;
}

.status-warning {
    background-color: #ffc107;
}

.status-critical {
    background-color: #dc3545;
}

.recommendations-panel {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.recommendation-item {
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 10px;
}

.recommendation-item.high-priority {
    border-left: 4px solid #dc3545;
}

.recommendation-item.medium-priority {
    border-left: 4px solid #ffc107;
}

.recommendation-item.low-priority {
    border-left: 4px solid #28a745;
}

.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    height: 400px;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.error {
    color: #dc3545;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
}

.btn-optimize {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.btn-optimize:hover {
    background-color: #0056b3;
}

.btn-optimize:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.refresh-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.auto-refresh {
    display: flex;
    align-items: center;
    gap: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="performance-dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Performance Dashboard</h1>
        <div class="refresh-controls">
            <div class="auto-refresh">
                <label>
                    <input type="checkbox" id="autoRefresh" checked> Auto-refresh (30s)
                </label>
                <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">Refresh Now</button>
            </div>
        </div>
    </div>

    <!-- System Health Status -->
    <div class="health-status" id="systemHealth">
        <div class="status-indicator status-healthy"></div>
        <span>Loading system health...</span>
    </div>

    <!-- Performance Metrics Grid -->
    <div class="metrics-grid" id="metricsGrid">
        <div class="metric-card">
            <div class="metric-value" id="throughputValue">--</div>
            <div class="metric-label">Messages/Second</div>
            <div class="metric-trend" id="throughputTrend"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="connectionsValue">--</div>
            <div class="metric-label">WebSocket Connections</div>
            <div class="metric-trend" id="connectionsTrend"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="cacheHitRateValue">--</div>
            <div class="metric-label">Cache Hit Rate</div>
            <div class="metric-trend" id="cacheHitRateTrend"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="memoryUsageValue">--</div>
            <div class="metric-label">Memory Usage (MB)</div>
            <div class="metric-trend" id="memoryUsageTrend"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="cpuUsageValue">--</div>
            <div class="metric-label">CPU Usage (%)</div>
            <div class="metric-trend" id="cpuUsageTrend"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" id="dbQueryTimeValue">--</div>
            <div class="metric-label">DB Query Time (ms)</div>
            <div class="metric-trend" id="dbQueryTimeTrend"></div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h5>Throughput Trend</h5>
                <canvas id="throughputChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5>Resource Usage</h5>
                <canvas id="resourceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Optimization Recommendations -->
    <div class="recommendations-panel">
        <h5>Optimization Recommendations</h5>
        <div id="recommendationsContainer">
            <div class="loading">Loading recommendations...</div>
        </div>
    </div>

    <!-- Detailed Reports -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6>Connection Pool Status</h6>
                </div>
                <div class="card-body" id="connectionPoolStatus">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6>Cache Statistics</h6>
                </div>
                <div class="card-body" id="cacheStatistics">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6>Database Performance</h6>
                </div>
                <div class="card-body" id="databasePerformance">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js for performance charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let throughputChart = null;
let resourceChart = null;
let autoRefreshInterval = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    refreshDashboard();
    setupAutoRefresh();
});

function initializeCharts() {
    // Throughput chart
    const throughputCtx = document.getElementById('throughputChart').getContext('2d');
    throughputChart = new Chart(throughputCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Messages/Second',
                data: [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Resource usage chart
    const resourceCtx = document.getElementById('resourceChart').getContext('2d');
    resourceChart = new Chart(resourceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Memory (MB)',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'CPU (%)',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Memory (MB)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'CPU (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

function setupAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    
    function updateAutoRefresh() {
        if (autoRefreshCheckbox.checked) {
            autoRefreshInterval = setInterval(refreshDashboard, 30000); // 30 seconds
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }
    
    autoRefreshCheckbox.addEventListener('change', updateAutoRefresh);
    updateAutoRefresh(); // Initial setup
}

async function refreshDashboard() {
    try {
        await Promise.all([
            loadCurrentMetrics(),
            loadSystemHealth(),
            loadRecommendations(),
            loadPerformanceTrends()
        ]);
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
        showError('Failed to refresh dashboard data');
    }
}

async function loadCurrentMetrics() {
    try {
        const response = await fetch('/admin/api/performance/metrics');
        const metrics = await response.json();
        
        if (response.ok) {
            updateMetricsDisplay(metrics);
        } else {
            throw new Error(metrics.error || 'Failed to load metrics');
        }
    } catch (error) {
        console.error('Error loading metrics:', error);
        showError('Failed to load performance metrics');
    }
}

async function loadSystemHealth() {
    try {
        const response = await fetch('/admin/api/performance/health');
        const health = await response.json();
        
        if (response.ok) {
            updateHealthDisplay(health);
        } else {
            throw new Error(health.error || 'Failed to load health status');
        }
    } catch (error) {
        console.error('Error loading health status:', error);
        showError('Failed to load system health status');
    }
}

async function loadRecommendations() {
    try {
        const response = await fetch('/admin/api/performance/recommendations');
        const data = await response.json();
        
        if (response.ok) {
            updateRecommendationsDisplay(data.recommendations);
        } else {
            throw new Error(data.error || 'Failed to load recommendations');
        }
    } catch (error) {
        console.error('Error loading recommendations:', error);
        showError('Failed to load optimization recommendations');
    }
}

async function loadPerformanceTrends() {
    try {
        const response = await fetch('/admin/api/performance/trends?hours=24');
        const trends = await response.json();
        
        if (response.ok && trends.time_series) {
            updateChartsDisplay(trends.time_series);
        } else {
            console.warn('No trend data available');
        }
    } catch (error) {
        console.error('Error loading trends:', error);
    }
}

function updateMetricsDisplay(metrics) {
    document.getElementById('throughputValue').textContent = metrics.notification_throughput.toFixed(1);
    document.getElementById('connectionsValue').textContent = metrics.websocket_connections;
    document.getElementById('cacheHitRateValue').textContent = (metrics.cache_hit_rate * 100).toFixed(1) + '%';
    document.getElementById('memoryUsageValue').textContent = metrics.memory_usage_mb.toFixed(1);
    document.getElementById('cpuUsageValue').textContent = metrics.cpu_usage_percent.toFixed(1) + '%';
    document.getElementById('dbQueryTimeValue').textContent = metrics.database_query_time.toFixed(1);
    
    // Update metric card styles based on values
    updateMetricCardStyle('throughputValue', metrics.notification_throughput, 50, 10);
    updateMetricCardStyle('connectionsValue', metrics.websocket_connections, 800, 500);
    updateMetricCardStyle('cacheHitRateValue', metrics.cache_hit_rate, 0.7, 0.9);
    updateMetricCardStyle('memoryUsageValue', metrics.memory_usage_mb, 400, 300);
    updateMetricCardStyle('cpuUsageValue', metrics.cpu_usage_percent, 80, 60);
    updateMetricCardStyle('dbQueryTimeValue', metrics.database_query_time, 100, 50);
}

function updateMetricCardStyle(elementId, value, criticalThreshold, warningThreshold) {
    const element = document.getElementById(elementId);
    const card = element.closest('.metric-card');
    
    card.classList.remove('warning', 'critical');
    
    if (value >= criticalThreshold) {
        card.classList.add('critical');
    } else if (value >= warningThreshold) {
        card.classList.add('warning');
    }
}

function updateHealthDisplay(health) {
    const healthElement = document.getElementById('systemHealth');
    const indicator = healthElement.querySelector('.status-indicator');
    const text = healthElement.querySelector('span');
    
    // Update indicator
    indicator.className = 'status-indicator';
    indicator.classList.add(`status-${health.overall_status}`);
    
    // Update text
    let statusText = `System Status: ${health.overall_status.toUpperCase()}`;
    if (health.alerts && health.alerts.length > 0) {
        statusText += ` (${health.alerts.length} alerts)`;
    }
    text.textContent = statusText;
}

function updateRecommendationsDisplay(recommendations) {
    const container = document.getElementById('recommendationsContainer');
    
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div class="text-muted">No optimization recommendations at this time.</div>';
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div class="recommendation-item ${rec.priority}-priority">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6>${rec.title}</h6>
                    <p class="mb-2">${rec.description}</p>
                    <small class="text-muted">Priority: ${rec.priority}</small>
                </div>
                <button class="btn-optimize" onclick="applyRecommendation('${rec.action}', ${JSON.stringify(rec.parameters).replace(/"/g, '&quot;')})">
                    Apply
                </button>
            </div>
        </div>
    `).join('');
}

function updateChartsDisplay(timeSeries) {
    // Update throughput chart
    if (throughputChart && timeSeries.timestamps && timeSeries.throughput) {
        const labels = timeSeries.timestamps.map(ts => new Date(ts).toLocaleTimeString());
        
        throughputChart.data.labels = labels.slice(-20); // Last 20 data points
        throughputChart.data.datasets[0].data = timeSeries.throughput.slice(-20);
        throughputChart.update('none');
    }
    
    // Update resource chart
    if (resourceChart && timeSeries.timestamps) {
        const labels = timeSeries.timestamps.map(ts => new Date(ts).toLocaleTimeString());
        
        resourceChart.data.labels = labels.slice(-20);
        resourceChart.data.datasets[0].data = timeSeries.memory_usage.slice(-20);
        resourceChart.data.datasets[1].data = timeSeries.cpu_usage.slice(-20);
        resourceChart.update('none');
    }
}

async function applyRecommendation(action, parameters) {
    try {
        const response = await fetch('/admin/api/performance/apply-recommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recommendation_id: action,
                parameters: { action, parameters }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message || 'Optimization applied successfully');
            // Refresh dashboard after applying optimization
            setTimeout(refreshDashboard, 2000);
        } else {
            showError(result.message || 'Failed to apply optimization');
        }
    } catch (error) {
        console.error('Error applying recommendation:', error);
        showError('Failed to apply optimization recommendation');
    }
}

function showError(message) {
    // You can integrate this with your existing notification system
    console.error(message);
    alert('Error: ' + message);
}

function showSuccess(message) {
    // You can integrate this with your existing notification system
    console.log(message);
    alert('Success: ' + message);
}
</script>
{% endblock %}