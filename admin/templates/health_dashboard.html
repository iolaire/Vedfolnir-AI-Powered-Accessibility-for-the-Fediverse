<!-- Copyright (C) 2025 iolaire mcfadden. -->
<!-- This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. -->
<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. -->
{% extends "base_admin.html" %}

{% block title %}System Health Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">System Health Dashboard</h1>
            version.py
            <!-- Overall System Status -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Overall System Status</h5>
                    <span class="badge bg-{% if health.status.value == 'healthy' %}success{% elif health.status.value == 'degraded' %}warning{% else %}danger{% endif %} badge-lg">
                        {{ health.status.value.title() }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Last Check:</strong> {{ health.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
                            <p><strong>Uptime:</strong> {{ "%.1f"|format(health.uptime_seconds / 3600) }} hours</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Version:</strong> {{ health.version or 'Unknown' }}</p>
                            <p><strong>Components:</strong> {{ health.components|length }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Component Status Cards -->
            <div class="row">
                {% for component_name, component in health.components.items() %}
                <div class="col-lg-6 col-xl-3 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ component.name.title() }}</h6>
                            <span class="badge bg-{% if component.status.value == 'healthy' %}success{% elif component.status.value == 'degraded' %}warning{% else %}danger{% endif %}">
                                {{ component.status.value.title() }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ component.message }}</p>
                            
                            {% if component.response_time_ms %}
                            <small class="text-muted">
                                Response Time: {{ "%.0f"|format(component.response_time_ms) }}ms
                            </small>
                            {% endif %}
                            
                            {% if component.details %}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ component_name }}" aria-expanded="false">
                                    Show Details
                                </button>
                                <div class="collapse mt-2" id="details-{{ component_name }}">
                                    <div class="card card-body bg-light">
                                        {% for key, value in component.details.items() %}
                                        <small><strong>{{ key.replace('_', ' ').title() }}:</strong> 
                                            {% if value is mapping %}
                                                <pre class="mb-0">{{ value|tojson(indent=2) }}</pre>
                                            {% elif value is iterable and value is not string %}
                                                {{ value|join(', ') }}
                                            {% else %}
                                                {{ value }}
                                            {% endif %}
                                        </small>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">
                                Last Check: {{ component.last_check.strftime('%H:%M:%S') if component.last_check else 'Never' }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Health Checks</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('admin.health_check') }}" class="btn btn-sm btn-outline-primary" target="_blank">Basic Health Check</a>
                                <a href="{{ url_for('admin.health_check_detailed') }}" class="btn btn-sm btn-outline-info" target="_blank">Detailed Health Check</a>
                                <button onclick="refreshHealthData()" class="btn btn-sm btn-outline-success">Refresh</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>System Status</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-{% if health.status.value == 'healthy' %}success{% elif health.status.value == 'degraded' %}warning{% else %}danger{% endif %}">{{ health.components|length }} Components</span>
                                <span class="badge bg-info">{{ health.version or 'v1.0.0' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Health Check History (if available) -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">System Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Database</h6>
                            {% if health.components.database and health.components.database.details %}
                            <ul class="list-unstyled">
                                <li><small>Posts: {{ health.components.database.details.posts or 0 }}</small></li>
                                <li><small>Images: {{ health.components.database.details.images or 0 }}</small></li>
                                <li><small>Processing Runs: {{ health.components.database.details.processing_runs or 0 }}</small></li>
                                <li><small>Recent Runs (24h): {{ health.components.database.details.recent_runs_24h or 0 }}</small></li>
                            </ul>
                            {% else %}
                            <p><small class="text-muted">Database info not available</small></p>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h6>Storage</h6>
                            {% if health.components.storage and health.components.storage.details %}
                            <ul class="list-unstyled">
                                <!-- Database Information -->
                                {% if health.components.storage.details.database_type %}
                                <li><small><strong>{{ health.components.storage.details.database_type }}</strong></small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.database_name %}
                                <li><small>Database: {{ health.components.storage.details.database_name }}</small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.mysql_version %}
                                <li><small>Version: {{ health.components.storage.details.mysql_version }}</small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.database_size_mb %}
                                <li><small>DB Size: {{ health.components.storage.details.database_size_mb }}MB</small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.table_count %}
                                <li><small>Tables: {{ health.components.storage.details.table_count }}</small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.active_connections %}
                                <li><small>Connections: {{ health.components.storage.details.active_connections }}</small></li>
                                {% endif %}
                                
                                <!-- Images Storage Information -->
                                {% if health.components.storage.details.stored_images is defined %}
                                <li><small>Stored Images: {{ health.components.storage.details.stored_images or 0 }}</small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.stored_images_size %}
                                <li><small>Images Size: {{ health.components.storage.details.stored_images_size }}</small></li>
                                {% endif %}
                                
                                {% if health.components.storage.details.images_disk_free_gb %}
                                <li><small>Images Disk Free: {{ health.components.storage.details.images_disk_free_gb }}GB</small></li>
                                {% endif %}
                                
                                <!-- SQLite-specific information -->
                                {% if health.components.storage.details.db_disk_free_gb %}
                                <li><small>DB Disk Free: {{ health.components.storage.details.db_disk_free_gb }}GB</small></li>
                                {% endif %}
                            </ul>
                            {% else %}
                            <p><small class="text-muted">Storage info not available</small></p>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h6>Ollama AI</h6>
                            {% if health.components.ollama and health.components.ollama.details %}
                            <ul class="list-unstyled">
                                <li><small>Base URL: {{ health.components.ollama.details.base_url or 'Unknown' }}</small></li>
                                <li><small>Model: {{ health.components.ollama.details.required_model or 'Unknown' }}</small></li>
                                {% if health.components.ollama.details.model_available %}
                                <li><small>Status: Available</small></li>
                                {% else %}
                                <li><small>Status: Model not found</small></li>
                                {% endif %}
                            </ul>
                            {% else %}
                            <p><small class="text-muted">Ollama info not available</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ensure all buttons are visible and functional
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        // Ensure button has proper styling
        if (!btn.style.color && btn.classList.contains('btn-outline-primary')) {
            btn.style.color = '#2563eb';
            btn.style.borderColor = '#2563eb';
        }
    });
});

function refreshHealthData() {
    // Show loading indicator
    const refreshBtn = document.querySelector('button[onclick="refreshHealthData()"]');
    if (refreshBtn) {
        const originalText = refreshBtn.textContent;
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Refreshing...';
        refreshBtn.disabled = true;
        
        // Reload the page to get fresh health data
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }
}

// Auto-refresh every 30 seconds (optional)
// Uncomment the next lines if you want auto-refresh
/*
setInterval(() => {
    if (document.visibilityState === 'visible') {
        window.location.reload();
    }
}, 30000);
*/
</script>

<style>
.badge-lg {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}

.card-body pre {
    font-size: 0.8em;
    max-height: 200px;
    overflow-y: auto;
}

/* Bootstrap 5 already provides bg-success, bg-warning, bg-danger classes */
.bg-warning {
    color: #212529 !important;
}

/* Ensure health dashboard buttons are visible */
.btn-sm {
    padding: 0.375rem 0.75rem !important;
    font-size: 0.875rem !important;
    border-radius: 0.375rem !important;
}

.btn-outline-primary {
    color: #2563eb !important;
    border-color: #2563eb !important;
    background-color: transparent !important;
}

.btn-outline-primary:hover {
    color: #ffffff !important;
    background-color: #2563eb !important;
    border-color: #2563eb !important;
}

.btn-outline-info {
    color: #0891b2 !important;
    border-color: #0891b2 !important;
    background-color: transparent !important;
}

.btn-outline-info:hover {
    color: #ffffff !important;
    background-color: #0891b2 !important;
    border-color: #0891b2 !important;
}

.btn-outline-success {
    color: #059669 !important;
    border-color: #059669 !important;
    background-color: transparent !important;
}

.btn-outline-success:hover {
    color: #ffffff !important;
    background-color: #059669 !important;
    border-color: #059669 !important;
}

.btn-outline-secondary {
    color: #64748b !important;
    border-color: #64748b !important;
    background-color: transparent !important;
}

.btn-outline-secondary:hover {
    color: #ffffff !important;
    background-color: #64748b !important;
    border-color: #64748b !important;
}

/* Ensure button text is always visible */
.btn, .btn-sm {
    font-weight: 500 !important;
    text-decoration: none !important;
}

/* Fix gap utility for older Bootstrap versions */
.gap-2 > * {
    margin-right: 0.5rem !important;
    margin-bottom: 0.5rem !important;
}

.gap-2 > *:last-child {
    margin-right: 0 !important;
}
</style>
{% endblock %}